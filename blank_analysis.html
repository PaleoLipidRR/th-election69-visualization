<!DOCTYPE html>
<html lang="th" data-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thailand No-Vote (Blank Ballot) Analysis 2566‚Äì2569</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
  <style>
    /* ‚îÄ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #080e1a;
      --surface: #0f1827;
      --border: #1a2740;
      --text: #cbd5e1;
      --muted: #475569;
      --faint: #1e2d42;
      --red: #ef4444;
      --amber: #f59e0b;
      --teal: #14b8a6;
      --ring: #ffffff;
    }

    [data-theme="light"] {
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #64748b;
      --faint: #f1f5f9;
      --ring: #1e293b;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Sarabun', sans-serif;
      font-size: 18px;
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 12px 28px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: nowrap;
    }

    .header-main-group {
      display: flex;
      flex-wrap: nowrap;
      align-items: center;
      gap: 24px;
      flex: 1;
      min-width: 0;
    }

    #header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.01em;
    }

    #header p {
      font-size: 0.85rem;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      margin-top: 3px;
    }

    .header-stats {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-shrink: 0;
    }

    .hstat {
      text-align: right;
      white-space: nowrap;
    }

    .hstat .v {
      font-family: 'DM Mono', monospace;
      font-size: 1.15rem;
      font-weight: 500;
      color: var(--text);
    }

    .hstat .l {
      font-size: 0.78rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .archive-container {
      margin-right: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .archive-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .archive-select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-family: 'DM Mono', monospace;
      cursor: pointer;
      outline: none;
      min-width: 180px;
    }

    .archive-select:hover {
      border-color: #38bdf8;
    }

    /* ‚îÄ‚îÄ‚îÄ LEGEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #legend {
      padding: 8px 28px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
      font-size: 0.82rem;
      color: var(--muted);
      background: var(--bg);
      position: sticky;
      top: 80px;
      z-index: 99;
      margin-left: 190px;
      margin-right: 190px;
    }

    .legend-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .legend-group span {
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      margin-right: 4px;
    }

    .dot-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
    }

    .dot-swatch {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .bar-swatch {
      width: 14px;
      height: 8px;
      border-radius: 1px;
      flex-shrink: 0;
    }

    /* Lock the main wrapper to the screen height */
    #wrapper {
      display: flex;
      padding: 0;
      height: calc(100vh - var(--header-h, 68px));
      width: 100%;
      overflow: hidden;
    }

    /* Constrain the chart area and enable internal scrolling */
    #chart-area {
      display: flex;
      padding: 0 28px;
      margin-left: 250px;
      margin-right: 190px;
      flex: 1;
      height: 100%;
      overflow-y: auto;
      overflow-x: auto;
      align-items: flex-start;
      background: var(--bg);
    }

    /* Ensure sidebars stay pinned to the sides */
    #left-sidebar,
    #right-sidebar {
      position: fixed;
      top: var(--header-h, 68px);
      height: calc(100vh - var(--header-h, 68px));
      z-index: 97;
      overflow-y: auto;
    }

    /* ‚îÄ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #tooltip {
      position: fixed;
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      z-index: 10001;
      pointer-events: none;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
      width: 320px;
      color: var(--text);
    }

    #tooltip b {
      color: var(--text);
    }

    #tooltip .tip-change {
      font-family: 'DM Mono', monospace;
      font-weight: 500;
    }

    .ctrl-label {
      color: var(--muted);
      margin-right: 4px;
    }

    .btn-sort {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 3px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.82rem;
      font-family: 'DM Mono', monospace;
      transition: border-color 0.15s, color 0.15s;
    }

    .btn-sort:hover {
      border-color: #38bdf8;
      color: #38bdf8;
    }

    .btn-sort.active {
      border-color: #38bdf8;
      color: #38bdf8;
      background: rgba(56, 189, 248, 0.06);
    }

    .btn-dataset.active {
      border-color: #38bdf8;
      color: #38bdf8;
      background: rgba(56, 189, 248, 0.06);
    }

    /* ‚îÄ‚îÄ‚îÄ SIDEBARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #left-sidebar {
      position: fixed;
      top: var(--header-h, 68px);
      left: 0;
      width: 250px;
      height: calc(100vh - var(--header-h, 68px));
      overflow-y: auto;
      border-right: 1px solid var(--border);
      background: var(--bg);
      padding: 16px 12px;
      z-index: 97;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #right-sidebar {
      position: fixed;
      top: var(--header-h, 68px);
      right: 0;
      width: 190px;
      height: calc(100vh - var(--header-h, 68px));
      overflow-y: auto;
      border-left: 1px solid var(--border);
      background: var(--bg);
      padding: 16px 12px;
      z-index: 97;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .sidebar-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
    }

    #left-sidebar .btn-filter {
      display: block;
      width: 100%;
      text-align: left;
      white-space: normal;
      line-height: 1.4;
      padding: 5px 10px;
    }

    #right-sidebar #party-legend {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    #left-sidebar .btn-sort:not(.btn-filter) {
      display: block;
      width: 100%;
      text-align: left;
    }

    .sidebar-divider {
      height: 1px;
      background: var(--border);
      margin: 10px 0 14px;
    }

    /* ‚îÄ‚îÄ‚îÄ SVG PANELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #chart-area {
      display: flex;
      padding: 0 28px;
      gap: 0;
      min-width: max-content;
      margin-left: 190px;
      margin-right: 190px;
    }

    svg {
      display: block;
      overflow: visible;
    }

    .mobile-menu-btn {
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 12px;
    }

    @media (max-width: 1100px) {

      /* Show toggle button on medium/small screens */
      .mobile-menu-btn {
        display: block;
      }

      /* Make sidebars hidden by default, sliding in when active */
      #left-sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      #left-sidebar.show {
        transform: translateX(0);
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
      }

      #right-sidebar {
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }

      #right-sidebar.show {
        transform: translateX(0);
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
      }

      /* Let chart expand to fill screen */
      #chart-area {
        margin-left: 0;
        margin-right: 0;
        padding: 0 10px;
        width: 100%;
      }

      /* Overlay to click-off the sidebars */
      #sidebar-overlay {
        display: none;
        position: fixed;
        top: 80px;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 96;
        /* just behind sidebars (97) */
      }

      #sidebar-overlay.show {
        display: block;
      }

      /* Stack header stats */
      .header-stats {
        margin-left: 0;
        width: 100%;
        gap: 12px;
        justify-content: space-between;
      }

      .hstat {
        text-align: left;
      }

      .hstat:last-child {
        border-left: none !important;
        padding-left: 0 !important;
        margin-left: 0 !important;
      }

      /* Allow datasets dropdowns to grow */
      .archive-container {
        width: 100%;
        margin-right: 0;
      }
    }

    @media print {

      #left-sidebar,
      #right-sidebar {
        display: none !important;
      }

      #header {
        position: static !important;
      }

      #chart-area {
        margin-left: 0 !important;
        margin-right: 0 !important;
        overflow: visible !important;
      }

      body {
        background: white !important;
      }
    }
  </style>
</head>

<body>

  <div id="capture-container" style="background: var(--bg); padding: 20px 0;">
    <div id="header">
      <button class="mobile-menu-btn" onclick="toggleSidebar('left')">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>

      <div class="header-main-group">
        <!-- Title block -->
        <div style="flex:1; min-width:0;">
          <h1 id="header-title">‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î : ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2566 ‚Üí 2569</h1>
          <p id="header-subtitle">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î ¬∑ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° % ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</p>
        </div>

        <!-- Summary Stats -->
        <div class="header-stats">
          <div class="hstat">
            <div class="v" id="hs-danger">‚Äî</div>
            <div class="l">‚ö† ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å > ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;margin-top:2px;color:var(--muted);">
              <span style="opacity:0.65">L</span>&nbsp;<span id="hs-danger-sum-l" style="color:var(--text)">‚Äî</span>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);">
              <span style="opacity:0.65">R</span>&nbsp;<span id="hs-danger-sum-r" style="color:var(--red)">‚Äî</span>
            </div>
          </div>
          <div class="hstat">
            <div class="v" id="hs-improved">‚Äî</div>
            <div class="l">‚Üì ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏î‡∏•‡∏á (Œî%)</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;margin-top:1px;color:var(--muted);">
              <span style="opacity:0.65">L</span>&nbsp;<span id="hs-improved-sum-l" style="color:var(--text)">‚Äî</span>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);">
              <span style="opacity:0.65">R</span>&nbsp;<span id="hs-improved-sum-r" style="color:var(--teal)">‚Äî</span>
            </div>
            <div style="border-top:1px solid var(--border);margin:5px 0 3px;"></div>
            <div style="font-family:'DM Mono',monospace;font-size:0.95rem;color:var(--teal);" id="hs-improved-raw">‚Äî</div>
            <div class="l">‚Üì ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏î‡∏•‡∏á (Œî#)</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;margin-top:1px;color:var(--muted);">
              <span style="opacity:0.65">L</span>&nbsp;<span id="hs-improved-raw-sum-l" style="color:var(--text)">‚Äî</span>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);">
              <span style="opacity:0.65">R</span>&nbsp;<span id="hs-improved-raw-sum-r" style="color:var(--teal)">‚Äî</span>
            </div>
          </div>
          <div class="hstat">
            <div class="v" id="hs-worse">‚Äî</div>
            <div class="l">‚Üë ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (Œî%)</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;margin-top:1px;color:var(--muted);">
              <span style="opacity:0.65">L</span>&nbsp;<span id="hs-worse-sum-l" style="color:var(--text)">‚Äî</span>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);">
              <span style="opacity:0.65">R</span>&nbsp;<span id="hs-worse-sum-r" style="color:var(--red)">‚Äî</span>
            </div>
            <div style="border-top:1px solid var(--border);margin:5px 0 3px;"></div>
            <div style="font-family:'DM Mono',monospace;font-size:0.95rem;color:var(--red);" id="hs-worse-raw">‚Äî</div>
            <div class="l">‚Üë ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (Œî#)</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;margin-top:1px;color:var(--muted);">
              <span style="opacity:0.65">L</span>&nbsp;<span id="hs-worse-raw-sum-l" style="color:var(--text)">‚Äî</span>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);">
              <span style="opacity:0.65">R</span>&nbsp;<span id="hs-worse-raw-sum-r" style="color:var(--red)">‚Äî</span>
            </div>
          </div>
          <div class="hstat" style="border-left:1px solid var(--border);padding-left:20px;margin-left:4px">
            <div class="v" id="hs-all-summary">‚Äî</div>
            <div class="l">‚Üë‚Üì ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Œî%)</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;margin-top:1px;color:var(--muted);">
              <span id="hs-all-summary-raw" style="color:var(--text)">‚Äî</span>&thinsp;<span style="opacity:0.65">(Œî#)</span>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;margin-top:2px;color:var(--muted);">
              <span style="opacity:0.65">L</span>&nbsp;<span id="hs-all-sum-l" style="color:var(--text)">‚Äî</span>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);">
              <span style="opacity:0.65">R</span>&nbsp;<span id="hs-all-sum-r" style="color:var(--text)">‚Äî</span>
            </div>
          </div>
        </div>
      </div>

      <button class="mobile-menu-btn" onclick="toggleSidebar('right')" style="margin-left:auto;">‚òÖ ‡∏û‡∏£‡∏£‡∏Ñ</button>
    </div>

    <!-- ‚îÄ‚îÄ MISSING DATA WARNING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="missing-data-warning" style="
      display: none;
      background: rgba(245,158,11,0.1);
      border-bottom: 1px solid rgba(245,158,11,0.35);
      padding: 4px 28px;
      font-size: 0.72rem;
      font-family: 'DM Mono', monospace;
      color: #d97706;
      margin-left: 250px;
      margin-right: 190px;
    "></div>

    <!-- ‚îÄ‚îÄ AGGREGATE VOTE BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="vote-bar-wrap" style="
      position: sticky;
      top: var(--header-h, 68px);
      z-index: 98;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 6px 28px 7px;
      margin-left: 250px;
      margin-right: 190px;
    ">
      <!-- Row L -->
      <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
        <div id="vb-l-label" style="font-size:0.65rem;font-family:'DM Mono',monospace;color:var(--muted);min-width:45px;text-align:right;">L</div>
        <div id="vote-bar" style="
          display: flex;
          height: 10px;
          border-radius: 5px;
          overflow: hidden;
          flex: 1;
          background: var(--border);
        ">
          <div id="vb-winner" style="height:100%; transition:width 0.4s;"></div>
          <div id="vb-runner" style="height:100%; transition:width 0.4s;"></div>
          <div id="vb-rest" style="height:100%; background:#64748b; opacity:0.4; transition:width 0.4s;"></div>
          <div id="vb-invalid" style="height:100%; background:#8b5cf6; transition:width 0.4s;"></div>
        </div>
      </div>
      <!-- Row R -->
      <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
        <div id="vb-r-label" style="font-size:0.65rem;font-family:'DM Mono',monospace;color:var(--muted);min-width:45px;text-align:right;">R</div>
        <div id="vote-bar-right" style="
          display: flex;
          height: 10px;
          border-radius: 5px;
          overflow: hidden;
          flex: 1;
          background: var(--border);
        ">
          <div id="vbr-winner" style="height:100%; transition:width 0.4s;"></div>
          <div id="vbr-runner" style="height:100%; background:#94a3b8; transition:width 0.4s;"></div>
          <div id="vbr-rest" style="height:100%; background:#64748b; opacity:0.4; transition:width 0.4s;"></div>
          <div id="vbr-invalid" style="height:100%; background:#8b5cf6; transition:width 0.4s;"></div>
        </div>
      </div>
      <!-- Legend row -->
      <div id="vote-bar-legend" style="
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        align-items: center;
        font-size: 0.72rem;
        color: var(--muted);
        font-family: 'DM Mono', monospace;
      "></div>
    </div>

    <div id="sidebar-overlay" onclick="closeSidebars()"></div>

    <div id="wrapper">
      <div id="left-sidebar">
        <button class="btn-sort" onclick="window.location.href='index.html'"
          style="font-size:0.75rem;padding:3px 10px;margin-bottom:4px;margin-top:10px; width:100%;">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button id="btn-theme" class="btn-sort" onclick="toggleTheme()" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á/‡∏°‡∏∑‡∏î"
          style="font-size:0.75rem;padding:3px 10px;margin-bottom:4px">‚òÄÔ∏è Light</button>
        <button class="btn-sort" onclick="captureImage()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"
          style="font-size:0.75rem;padding:3px 10px;margin-bottom:12px">üì∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>

        <div class="sidebar-label">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
        <button class="btn-sort" onclick="window.location.href='surplus_analysis_v2.html'"
          style="width: 100%; background: var(--teal); color: white; border: none; margin-bottom: 6px;">
          üìä ‡∏î‡∏π‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£ (Surplus)
        </button>
        <button class="btn-sort" onclick="window.location.href='invalid_analysis.html'"
          style="width: 100%; background: var(--red); color: white; border: none; margin-bottom: 6px;">
          ‚úó ‡∏î‡∏π‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢ (Invalid)
        </button>
        <button class="btn-sort" onclick="window.location.href='total_votes_analysis.html'"
          style="width: 100%; background: var(--amber); color: white; border: none; margin-bottom: 6px;">
          üë• ‡∏î‡∏π‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Total Votes)
        </button>

        <div style="
          margin-top: 8px;
          padding: 10px;
          border: 1.5px solid var(--teal);
          border-radius: 8px;
          background: rgba(20, 184, 166, 0.05);
          margin-bottom: 14px;
        ">
          <div style="
            font-size: 0.68rem;
            font-weight: 700;
            color: var(--teal);
            text-transform: uppercase;
            letter-spacing: 0.07em;
            margin-bottom: 8px;
          ">‚öñ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö | Compare Datasets</div>

          <div style="display:flex; flex-direction:column; gap:4px; margin-bottom:6px;">
            <div class="archive-label" style="font-size:0.75rem;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ê‡∏≤‡∏ô </div>
            <div class="archive-label" style="font-size:0.65rem;">Base (Left) </div>
            <select id="archive-select-left" class="archive-select" style="width:100%; font-size:0.75rem;">
              <option value="data/election66_data.js" selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2566</option>
              <option value="data/election69_ocr.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (OCR)</option>
              <option value="data/election69_94pct.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (94%)</option>
            </select>
          </div>
          <div style="display:flex; flex-direction:column; gap:4px; margin-bottom:8px;">
            <div class="archive-label" style="font-size:0.75rem;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö </div>
            <div class="archive-label" style="font-size:0.65rem;">Comparison (Right) </div>
            <select id="archive-select-right" class="archive-select" style="width:100%; font-size:0.75rem;">
              <option value="data/election66_data.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2566</option>
              <option value="data/election69_ocr.js" selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (OCR)</option>
              <option value="data/election69_94pct.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (94%)</option>
            </select>
          </div>
          <button id="btn-load-comparison" class="btn-sort" style="
            width:100%;
            background: var(--teal);
            color: white;
            border: none;
            font-weight: bold;
            font-size: 0.8rem;
            padding: 6px 0;
            border-radius: 5px;
          ">‚úî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (confirm)</button>
        </div>

        <div class="sidebar-label">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | dataset</div>
        <button class="btn-sort btn-dataset active" onclick="switchDataset('constituency')" title="‡∏™.‡∏™. - ‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á"
          style="font-size:0.75rem;padding:3px 10px;margin-bottom:2px">‡∏™.‡∏™. (‡πÄ‡∏Ç‡∏ï)</button>
        <button class="btn-sort btn-dataset" onclick="switchDataset('partylist')" title="‡∏ö‡∏™. - ‡∏™.‡∏™. ‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠"
          style="font-size:0.75rem;padding:3px 10px;margin-bottom:12px">‡∏ö‡∏™. (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠)</button>

        <div class="sidebar-label">‡∏Å‡∏£‡∏≠‡∏á | filter by</div>
        <select id="filter-select" class="archive-select" style="width:100%; font-size:0.72rem; margin-bottom:4px;" onchange="setFilter(this.value)">
          <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="danger">‚ö† ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å > ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</option>
          <option value="safe">‚úì ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</option>
        </select>
        <div style="font-size:0.65rem; font-family:'DM Mono',monospace; color:var(--muted); margin-bottom:8px;">
          ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="cnt-all">‚Äî</span> ¬∑ <span style="color:#8b5cf6;">‚ö†</span>&thinsp;<span id="cnt-danger">‚Äî</span> ¬∑ <span style="color:#14b8a6;">‚úì</span>&thinsp;<span id="cnt-safe">‚Äî</span>
        </div>
        <div class="sidebar-divider"></div>
        <div class="sidebar-label">‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° | group by</div>
        <select id="grp-select" class="archive-select" style="width:100%; font-size:0.72rem; margin-bottom:8px;" onchange="setGrouping(this.value)">
          <option value="none">‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°</option>
          <option value="region">‡∏†‡∏≤‡∏Ñ</option>
          <option value="party_l">‡∏û‡∏£‡∏£‡∏Ñ (L)</option>
          <option value="party_r">‡∏û‡∏£‡∏£‡∏Ñ (R)</option>
        </select>
        <div class="sidebar-label">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÇ‡∏î‡∏¢ | sort by</div>
        <div style="display:flex; gap:4px; margin-bottom:8px;">
          <select id="sort-select" class="archive-select" style="flex:1; font-size:0.72rem;" onchange="resort(this.value)">
            <option value="pct_change" selected>% ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</option>
            <option value="pct_2569">% ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (R)</option>
            <option value="blank_change">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</option>
            <option value="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
            <option value="party_2566">‡∏û‡∏£‡∏£‡∏Ñ‡∏ä‡∏ô‡∏∞ (L)</option>
            <option value="party_2569">‡∏û‡∏£‡∏£‡∏Ñ‡∏ä‡∏ô‡∏∞ (R)</option>
            <option value="blank_l">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (L)</option>
            <option value="blank_r">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (R)</option>
          </select>
          <button id="sort-dir-btn" class="btn-sort" onclick="toggleSortDir()" title="‡∏™‡∏•‡∏±‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á" style="padding:3px 8px; font-size:0.75rem; min-width:28px;">‚ñº</button>
        </div>

        <div class="sidebar-spacer" style="flex-grow: 1; min-height: 50px;"></div>
        <div class="sidebar-disclaimer"
          style="font-size: 0.75rem; line-height: 1.4; color: var(--muted); padding-top: 15px; border-top: 1px solid var(--border); margin-top: auto;">
          <p style="color: var(--red)"><strong>‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Disclaimers):</strong></p>

          <p><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2566</strong> ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Å‡∏Å‡∏ï. (https://ectreport66.ect.go.th/) </p>
          <p><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2569</strong> ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏Å‡∏ï. ‡πÅ‡∏ö‡∏ö ‡∏™.‡∏™.6/1 ‡πÇ‡∏î‡∏¢ Chanon Ngernthongdee </p><br>
          <p>‡∏™‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å PDF ‡∏î‡πâ‡∏ß‡∏¢ OCR; Source: <a
              href="https://github.com/killernay/election-69-OCR-result">killernay/election-69-OCR-result</a></p><br>
          <p>‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p><br><br>

          <p>Data visualization by</p>
          <p>¬© 2026 Ronnakrit Rattanasriampaipong</p>
          <div id="data-timestamps"
            style="margin-top:8px; font-size:0.7rem; line-height:1.6; color:var(--muted); border-top: 1px dashed var(--border); padding-top:6px;">
            <p style="font-weight:600; margin-bottom:2px;">üïê ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</p>
            <p id="ts-left">Base: ‚Äî</p>
            <p id="ts-right">Compare: ‚Äî</p>
          </div>
        </div>
      </div>


      <div id="chart-area" style="display:none;">
        <svg id="svg-left"></svg>
        <svg id="svg-mid"></svg>
        <svg id="svg-right"></svg>
      </div>

      <div id="prompt-overlay"
        style="display:flex; flex:1; align-items:center; justify-content:center; flex-direction:column; margin-left:250px; margin-right:190px; text-align:center;">
        <h2 style="color:var(--text); margin-bottom:8px; font-weight:600;">Select Datasets to Compare</h2>
        <h3 style="color:var(--text); margin-bottom:8px; font-weight:600;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h3><br>
        <p style="color:var(--muted); font-size:0.9rem;">Please select a Base (Left) and Comparison (Right) dataset from
          the top menu, then click <b>Load Comparison</b>.</p>
        <p style="color:var(--muted); font-size:0.7rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (‡∏ã‡πâ‡∏≤‡∏¢) ‡πÅ‡∏•‡∏∞‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (‡∏Ç‡∏ß‡∏≤)
          ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π
          ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å <b>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</b></p>
      </div>
    </div>

    <div id="right-sidebar">
      <div class="sidebar-label" style="margin-top:20px" id="party-legend-title">‡∏û‡∏£‡∏£‡∏Ñ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ (‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)</div>
      <div id="party-legend"></div>
      <div class="sidebar-divider"></div>
      <div class="sidebar-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</div>
      <div
        style="font-size:0.75rem; color:var(--muted); margin-top:10px; display:flex; flex-direction:column; gap:6px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <div
            style="width:7px; height:7px; border-radius:50%; background:rgba(148,163,184,0.5); border:0.5px solid var(--muted);">
          </div>
          <span>‡∏à‡∏∏‡∏î‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ = 2566</span>
        </div>

        <div style="display:flex; align-items:center; gap:8px;">
          <div
            style="width:7px; height:7px; border-radius:50%; background:var(--muted); outline:2px solid var(--ring); outline-offset:1px;">
          </div>
          <span>‡∏°‡∏µ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô = 2569</span>
        </div>
      </div><br>
      <div class="dot-label">
        <div class="bar-swatch" style="background:#3e3f3f"></div>‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡∏£‡∏Ñ‡∏™‡∏≠‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å 2569
      </div>
      <div class="dot-label">
        <div class="bar-swatch" style="background:#a78bfa"></div>‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î
      </div>
      <div class="dot-label">
        <div class="bar-swatch" style="background:#8b5cf6"></div>‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å &gt; ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡∏£‡∏Ñ‡∏™‡∏≠‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å ‚ö†
      </div>
    </div>

    <div id="tooltip"></div>
    <script>
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // DATA NORMALIZATION
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      function normalizeRecord(d) {
        const num = (v) => Number(v) || 0;
        // Accept plain name or _2569-suffixed fallback (for extract_94pct_data.py output)
        const n = (plain, suffixed) => num(d[plain] ?? d[suffixed]);
        const str = (v) => (v && v !== 'Unknown') ? String(v) : "Unknown";
        const s = (plain, suffixed) => str(d[plain] ?? d[suffixed]);

        return {
          province_thai: str(d.province_thai),
          province_eng: str(d.province_eng),
          cons_no: num(d.cons_no),
          region: str(d.region),

          turn_out:        n('turn_out',        'turn_out_2569'),
          winner_party:    s('winner_party',     'winner_party_2569'),
          valid:           n('valid',            'valid_2569'),
          invalid:         n('invalid',          'invalid_2569'),
          blank:           n('blank',            'blank_2569'),
          winner_votes:    n('winner_votes',     'winner_votes_2569'),
          runnerup_party:  s('runnerup_party',   'runnerup_party_2569'),
          runnerup_votes:  n('runnerup_votes',   'runnerup_votes_2569'),
          margin:          n('margin',           'margin_2569'),
        };
      }

      // ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let DATA_LEFT = { raw: [], pl: [] };
      let DATA_RIGHT = { raw: [], pl: [] };
      let fullProcessedData = [];
      let data = [];
      let activeFilter = 'all';
      let currentSort = 'pct_change';
      let currentSortDir = 'desc';
      let currentGrouping = 'none';
      let missingFromL = [], missingFromR = [];

      // ‚îÄ‚îÄ‚îÄ SORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const SORTS_BASE = {
        pct_change:  (a, b) => b.blank_pct_change - a.blank_pct_change,
        pct_2569:    (a, b) => b.percent_blank_2569 - a.percent_blank_2569,
        blank_change:(a, b) => b.blank_change - a.blank_change,
        blank_l:     (a, b) => b.blank - a.blank,
        blank_r:     (a, b) => b.blank_2569 - a.blank_2569,
        province:    (a, b) => (a.province_eng || "").localeCompare(b.province_eng || "") || a.cons_no - b.cons_no,
        party_2566:  (a, b) => (a.winner_party || "").localeCompare(b.winner_party || "", 'th') || b.blank_pct_change - a.blank_pct_change,
        party_2569:  (a, b) => (a.winner_party_2569 || "").localeCompare(b.winner_party_2569 || "", 'th') || b.blank_pct_change - a.blank_pct_change,
      };
      function getSortFn() {
        const base = SORTS_BASE[currentSort] || SORTS_BASE.pct_change;
        return currentSortDir === 'asc' ? (a, b) => base(b, a) : base;
      }

      function processRawData() {
        console.log("[RENDER] Processing raw data as comparative set");

        const leftRaw = currentDataset === 'partylist' ? DATA_LEFT.pl : (DATA_LEFT.raw || []);
        const rightRaw = currentDataset === 'partylist' ? DATA_RIGHT.pl : (DATA_RIGHT.raw || []);

        // Build lookup maps both ways
        const mapRight = new Map();
        rightRaw.forEach(d => mapRight.set(`${d.province_thai}_${d.cons_no}`, d));
        const leftKeySet = new Set(leftRaw.map(d => `${d.province_thai}_${d.cons_no}`));

        // Track unmatched constituencies
        missingFromR = leftRaw.filter(d => !mapRight.has(`${d.province_thai}_${d.cons_no}`));
        missingFromL = rightRaw.filter(d => !leftKeySet.has(`${d.province_thai}_${d.cons_no}`));

        // Only include records present in BOTH datasets
        fullProcessedData = leftRaw
          .filter(dL => mapRight.has(`${dL.province_thai}_${dL.cons_no}`))
          .map(dL => {
            const dR = mapRight.get(`${dL.province_thai}_${dL.cons_no}`);
            const blank_L = dL.blank || 0;
            const pct_blank_L = dL.turn_out > 0 ? (blank_L / dL.turn_out * 100) : 0;
            const blank_R = dR.blank || 0;
            const pct_blank_R = dR.turn_out > 0 ? (blank_R / dR.turn_out * 100) : 0;

            return {
              ...dL,
              percent_blank: pct_blank_L,
              winner_party: dL.winner_party,
              blank_2569: blank_R,
              percent_blank_2569: pct_blank_R,
              winner_party_2569: dR.winner_party,
              winner_votes_2569: dR.winner_votes || 0,
              runnerup_party_2569: dR.runnerup_party,
              runnerup_votes_2569: dR.runnerup_votes || 0,
              margin_2569: dR.margin || 0,
              blank_pct_change: pct_blank_R - pct_blank_L,
              blank_change: blank_R - blank_L
            };
          });
        data = [...fullProcessedData];

        console.log(`[RENDER] ‚úì ${data.length} paired records. Missing R: ${missingFromR.length}, Missing L: ${missingFromL.length}`);
        if (data.length > 0) data.sort(getSortFn());
      }

      // ‚îÄ‚îÄ‚îÄ PARTY COLORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const PARTY_COLOR = {
        '‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢': '#312682',
        '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô': '#FF6413',
        '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢': '#E30613',
        '‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏£‡∏£‡∏°': '#4EC86F',
        '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå': '#15A5F5',
        '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥': '#BA810D',
        '‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ó‡∏¢': '#6841D0',
        '‡∏û‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏£‡∏±‡∏ê': '#006536',
        '‡πÑ‡∏ó‡∏£‡∏ß‡∏°‡∏û‡∏•‡∏±‡∏á': '#5266AD',
        '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏£‡∏ß‡∏°‡∏û‡∏•‡∏±‡∏á': '#5266AD',
        '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà': '#c61a12',
        '‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥': '#2b2c80',
        '‡∏Å‡πâ‡∏≤‡∏ß‡πÑ‡∏Å‡∏•': '#f97316',
        '‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏ó‡∏¢‡∏û‡∏±‡∏í‡∏ô‡∏≤': '#e40283',
        '‡∏ä‡∏≤‡∏ï‡∏¥‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏•‡πâ‡∏≤': '#fea12c'
      };
      function pc(name) { return PARTY_COLOR[name] || '#94a3b8'; }

      // ‚îÄ‚îÄ‚îÄ RUNNER-UP PARTY LOOKUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function runnerUpParty(d) {
        if (d.runnerup_party_2569 && d.runnerup_party_2569 !== "Unknown") {
          return d.runnerup_party_2569;
        }
        return d.winner_party_2569 || d.winner_party || "Unknown";
      }

      // ‚îÄ‚îÄ‚îÄ LAYOUT CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const ROW_H = 18;
      const TOP_PAD = 60;
      const LBL_W = 208;
      const SLOPE_W = 320;
      const BAR_W = 260;
      const BAR_GAP = 30;
      const DOT_COL_W = 28;
      const R = 3.2;

      // X scale: % blank 0..11 (X_MAX updated dynamically in buildChart)
      let X_MIN = 0, X_MAX = 11;
      function xScale(pct) {
        return LBL_W + ((pct - X_MIN) / (X_MAX - X_MIN)) * SLOPE_W;
      }

      // ‚îÄ‚îÄ‚îÄ DATASETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let currentDataset = 'constituency';

      function switchDataset(dataset) {
        currentDataset = dataset;

        // Update button active states
        document.querySelectorAll('.btn-dataset').forEach(b => {
          b.classList.remove('active');
          if (b.getAttribute('onclick')?.includes(`'${dataset}'`)) {
            b.classList.add('active');
          }
        });

        // Reset to default sort and filter
        activeFilter = 'all';
        currentSort = 'pct_change';

        // Reset filter dropdown
        const filterSel = document.getElementById('filter-select');
        if (filterSel) filterSel.value = 'all';

        // Reset sort dropdown + direction
        const sortSel = document.getElementById('sort-select');
        if (sortSel) sortSel.value = 'pct_change';
        currentSortDir = 'desc';
        const sortDirBtn = document.getElementById('sort-dir-btn');
        if (sortDirBtn) sortDirBtn.textContent = '‚ñº';

        // Switch data source contextually inside processRawData
        const selectedRaw = currentDataset === 'partylist' ? DATA_LEFT.pl : (DATA_LEFT.raw || []);

        // Update header subtitle
        const subtitle = document.getElementById('header-subtitle');
        if (dataset === 'partylist') {
          if (selectedRaw.length === 0) {
            subtitle.textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ö‡∏™. (‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠) ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° | Party List data coming soon';
          } else {
            subtitle.textContent = `‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î ¬∑ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ${selectedRaw.length} ‡πÄ‡∏Ç‡∏ï ¬∑ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° % ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á`;
          }
        } else {
          subtitle.textContent = `‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î ¬∑ ${selectedRaw.length} ‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ¬∑ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° % ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á`;
        }

        renderAll();
      }


      // ‚îÄ‚îÄ‚îÄ THEME HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function T(dark, light) {
        return document.documentElement.dataset.theme === 'light' ? light : dark;
      }
      function toggleTheme() {
        const root = document.documentElement;
        const going_light = root.dataset.theme !== 'light';
        root.dataset.theme = going_light ? 'light' : '';
        document.getElementById('btn-theme').textContent = going_light ? '‚òÄÔ∏è Light' : 'üåô Dark';
        buildChart();
      }


      function applyFilter() {
        if (activeFilter === 'danger') return fullProcessedData.filter(d => d.blank_2569 > d.margin_2569);
        if (activeFilter === 'safe') return fullProcessedData.filter(d => d.blank_2569 <= d.margin_2569);
        return [...fullProcessedData];
      }

      function setFilter(key) {
        activeFilter = key;
        const sel = document.getElementById('filter-select');
        if (sel) sel.value = key;
        processRawData();
        data = applyFilter();
        data.sort(getSortFn());
        buildChart();
      }


      function updateCounts() {
        const nd = fullProcessedData.filter(d => d.blank_2569 > d.margin_2569).length;
        const total = fullProcessedData.length;
        document.getElementById('cnt-all').textContent = '(' + total + ')';
        document.getElementById('cnt-danger').textContent = '(' + nd + ')';
        document.getElementById('cnt-safe').textContent = '(' + (total - nd) + ')';
      }

      function updateMissingWarning() {
        const el = document.getElementById('missing-data-warning');
        if (!el) return;
        const nL = missingFromL.length, nR = missingFromR.length;
        if (nL === 0 && nR === 0) { el.style.display = 'none'; return; }
        const leftSel = document.getElementById('archive-select-left');
        const rightSel = document.getElementById('archive-select-right');
        const lName = leftSel ? leftSel.options[leftSel.selectedIndex].text.split(' (')[0] : 'L';
        const rName = rightSel ? rightSel.options[rightSel.selectedIndex].text.split(' (')[0] : 'R';
        const parts = [];
        if (nR > 0) parts.push(`${nR} ‡πÄ‡∏Ç‡∏ï‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô ${rName}`);
        if (nL > 0) parts.push(`${nL} ‡πÄ‡∏Ç‡∏ï‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô ${lName}`);
        el.textContent = `‚ö† ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: ${parts.join(' ¬∑ ')} ¬∑ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${fullProcessedData.length} ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ä‡∏∏‡∏î`;
        el.style.display = 'block';
      }

      function resort(key) {
        currentSort = key;
        // Default direction: asc for province/party, desc for everything else
        currentSortDir = (key === 'province' || key === 'party_2566' || key === 'party_2569') ? 'asc' : 'desc';
        document.getElementById('sort-dir-btn').textContent = currentSortDir === 'asc' ? '‚ñ≤' : '‚ñº';
        processRawData();
        data = applyFilter();
        data.sort(getSortFn());
        buildChart();
      }

      function toggleSortDir() {
        currentSortDir = currentSortDir === 'desc' ? 'asc' : 'desc';
        document.getElementById('sort-dir-btn').textContent = currentSortDir === 'asc' ? '‚ñ≤' : '‚ñº';
        data.sort(getSortFn());
        buildChart();
      }

      function setGrouping(g) {
        currentGrouping = g;
        const sel = document.getElementById('grp-select');
        if (sel) sel.value = g;
        buildChart();
      }

      // ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function svgEl(tag, attrs) {
        const e = document.createElementNS('http://www.w3.org/2000/svg', tag);
        for (const [k, v] of Object.entries(attrs)) e.setAttribute(k, v);
        return e;
      }
      function svgText(parent, x, y, txt, attrs) {
        const e = svgEl('text', { x, y, ...attrs });
        e.textContent = txt;
        parent.appendChild(e);
        return e;
      }

      // ‚îÄ‚îÄ‚îÄ MAIN BUILD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function buildChart() {
        // ‚îÄ‚îÄ Build rows array (data rows + optional group header rows) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let rows;
        if (currentGrouping === 'none') {
          rows = data.map(d => ({ type: 'data', d }));
        } else {
          const groups = {};
          data.forEach(d => {
            const key = currentGrouping === 'region'   ? (d.region || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') :
                        currentGrouping === 'party_l'  ? (d.winner_party || 'Unknown') :
                        /* party_r */                    (d.winner_party_2569 || 'Unknown');
            if (!groups[key]) groups[key] = [];
            groups[key].push(d);
          });
          rows = [];
          Object.keys(groups).sort((a, b) => a.localeCompare(b, 'th')).forEach(k => {
            rows.push({ type: 'header', name: k, count: groups[k].length });
            groups[k].forEach(d => rows.push({ type: 'data', d }));
          });
        }

        const n = rows.length;
        const H = TOP_PAD + (n * ROW_H) + 10;
        const svgL = document.getElementById('svg-left');
        const svgM = document.getElementById('svg-mid');
        const svgR = document.getElementById('svg-right');
        svgL.innerHTML = '';
        svgM.innerHTML = '';
        svgR.innerHTML = '';

        // Dynamic x-axis: fit the widest data point, min 5%
        const allPcts = data.flatMap(d => [d.percent_blank || 0, d.percent_blank_2569 || 0]);
        const dataMax = allPcts.length ? Math.max(...allPcts) : 11;
        X_MAX = Math.max(5, Math.ceil(dataMax) + 1);

        const svgLW = LBL_W + SLOPE_W + 90;
        const svgMW = DOT_COL_W;
        const svgRW = BAR_GAP + BAR_W + 80;
        svgL.setAttribute('width', svgLW);
        svgL.setAttribute('height', H);
        svgM.setAttribute('width', svgMW);
        svgM.setAttribute('height', H);
        svgR.setAttribute('width', svgRW);
        svgR.setAttribute('height', H);

        // ‚îÄ‚îÄ LEFT SVG: x-axis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        svgL.appendChild(svgEl('line', {
          x1: LBL_W, y1: TOP_PAD - 2,
          x2: LBL_W + SLOPE_W, y2: TOP_PAD - 2,
          stroke: T('#1e3a5f', '#cbd5e1'), 'stroke-width': 1
        }));

        for (let p = 0; p <= X_MAX; p++) {
          const x = xScale(p);
          svgL.appendChild(svgEl('line', {
            x1: x, y1: TOP_PAD - 2,
            x2: x, y2: H,
            stroke: p === 0 ? T('#2563eb', '#6366f1') : T('#0f1e2f', '#e2e8f0'),
            'stroke-width': p === 0 ? 1 : 0.5,
            'stroke-dasharray': p === 0 ? '' : '2,4'
          }));
          // Only render if the index is even (0, 2, 4...)
          if (p % 2 === 0) {
            svgText(svgL, x, TOP_PAD - 8, p + '%', {
              'text-anchor': 'middle',
              'font-size': '12',
              'font-family': 'DM Mono, monospace',
              fill: T('#94a3b8', '#334155')
          });
        }
        }

        // ‚îÄ‚îÄ Headers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        svgText(svgL, xScale(5.5), 25, '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î (%) | ‡∏à‡∏∏‡∏î 2569 ‡∏°‡∏µ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô | ‡∏™‡∏µ‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏£‡∏£‡∏Ñ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1', {
          'text-anchor': 'middle', 'font-size': '12',
          'font-family': 'Sarabun, sans-serif', fill: T('#94a3b8', '#334155')
        });

        svgText(svgM, DOT_COL_W + 10, 25, '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2', {
          'text-anchor': 'middle', 'font-size': '12',
          'font-family': 'Sarabun, sans-serif', fill: T('#94a3b8', '#334155')
        });

        svgText(svgR, BAR_GAP + 10, 25, '‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ 2569', {
          'font-size': '11.5', 'font-family': 'Sarabun, sans-serif', fill: T('#94a3b8', '#334155')
        });

        svgText(svgL, LBL_W + SLOPE_W + 6, 25, 'Œî%', {
          'font-size': '10', 'font-family': 'DM Mono, monospace', fill: T('#94a3b8', '#334155')
        });
        svgText(svgL, LBL_W + SLOPE_W + 50, 25, 'Œî#', {
          'font-size': '10', 'font-family': 'DM Mono, monospace', fill: T('#94a3b8', '#334155')
        });

        // ‚îÄ‚îÄ Arrows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const arrowYStart = 35;
        const arrowYEnd = 50;
        const arrowStroke = T('#94a3b8', '#334155');

        function drawDownArrow(parent, x, y1, y2, color) {
          parent.appendChild(svgEl('line', {
            x1: x, y1: y1, x2: x, y2: y2,
            stroke: color, 'stroke-width': '1.5'
          }));
          parent.appendChild(svgEl('path', {
            d: `M ${x - 4} ${y2 - 5} L ${x} ${y2} L ${x + 4} ${y2 - 5}`,
            fill: 'none', stroke: color, 'stroke-width': '1.5'
          }));
        }

        drawDownArrow(svgM, DOT_COL_W + 15, arrowYStart, arrowYEnd, arrowStroke);
        drawDownArrow(svgR, BAR_GAP + 60, arrowYStart, arrowYEnd, arrowStroke);
        drawDownArrow(svgL, LBL_W + SLOPE_W + 18, arrowYStart, arrowYEnd, arrowStroke);
        drawDownArrow(svgL, LBL_W + SLOPE_W + 62, arrowYStart, arrowYEnd, arrowStroke);

        // ‚îÄ‚îÄ ROWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        rows.forEach((row, i) => {
          const y0 = TOP_PAD + i * ROW_H;
          const yMid = y0 + ROW_H / 2;

          // ‚îÄ‚îÄ Group header row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          if (row.type === 'header') {
            const bgColor = T('rgba(30,58,95,0.55)', 'rgba(226,232,240,0.7)');
            [svgL, svgM, svgR].forEach(svg => {
              svg.appendChild(svgEl('rect', {
                x: 0, y: y0,
                width: svg === svgL ? svgLW : svg === svgM ? svgMW : svgRW,
                height: ROW_H, fill: bgColor
              }));
            });
            svgText(svgL, LBL_W - 4, yMid + 4, `${row.name}  (${row.count})`, {
              'font-size': '12', 'font-weight': 'bold',
              'font-family': 'Sarabun, sans-serif',
              fill: T('#e2e8f0', '#1e3a5f')
            });
            return;
          }

          const d = row.d;
          const x2566 = xScale(d.percent_blank);
          const x2569 = xScale(d.percent_blank_2569);
          const c2566 = pc(d.winner_party);
          const c2569 = pc(d.winner_party_2569);
          const isDanger = d.blank_2569 > d.margin_2569;
          const pctChange = d.blank_pct_change;
          const sign = pctChange > 0 ? '+' : '';

          // ‚îÄ‚îÄ Row BG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          const rowBg = [svgL, svgM, svgR].map(svg => {
            const r = svgEl('rect', {
              x: 0, y: y0,
              width: svg === svgL ? svgLW : svg === svgM ? svgMW : svgRW,
              height: ROW_H,
              fill: i % 2 === 0 ? T('rgba(255,255,255,0.018)', 'rgba(0,0,0,0.028)') : 'transparent',
              'data-i': i
            });
            svg.appendChild(r);
            return r;
          });

          rowBg.forEach(r => {
            r.style.cursor = 'default';
            r.addEventListener('mousemove', e => showTip(e, d, isDanger, sign, pctChange));
            r.addEventListener('mouseleave', hideTip);
          });

          // ‚îÄ‚îÄ Y-axis label ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          svgText(svgL, LBL_W - 28, yMid + 3.5, d.province_thai, {
            'text-anchor': 'end',
            'font-size': '14',
            'font-family': 'Sarabun, sans-serif',
            fill: T('#64748b', '#64748b')
          });
          svgText(svgL, LBL_W - 4, yMid + 3.5, d.cons_no, {
            'text-anchor': 'end',
            'font-size': '14',
            'font-family': 'DM Mono, monospace',
            fill: T('#94a3b8', '#334155')
          });

          // ‚îÄ‚îÄ Connecting line ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          svgL.appendChild(svgEl('line', {
            x1: x2566, y1: yMid,
            x2: x2569, y2: yMid,
            stroke: T('rgba(148,163,184,0.18)', 'rgba(100,116,139,0.25)'),
            'stroke-width': isDanger ? 1.5 : 0.8
          }));

          // ‚îÄ‚îÄ 2566 dot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          svgL.appendChild(svgEl('circle', {
            cx: x2566, cy: yMid, r: R,
            fill: T('rgba(255,255,255,0.25)', 'rgba(0,0,0,0.3)'),
            stroke: T('rgba(255,255,255,0.25)', 'rgba(0,0,0,0.3)'),
            'stroke-width': 0.5
          }));

          // ‚îÄ‚îÄ 2569 dot with ring ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          svgL.appendChild(svgEl('circle', {
            cx: x2569, cy: yMid, r: R + 2.5,
            fill: 'none',
            stroke: getComputedStyle(document.documentElement).getPropertyValue('--ring').trim() || '#fff',
            'stroke-width': 2,
            opacity: 0.9
          }));
          svgL.appendChild(svgEl('circle', {
            cx: x2569, cy: yMid, r: R,
            fill: c2569,
            stroke: T('rgba(255,255,255,0.4)', 'rgba(0,0,0,0.3)'),
            'stroke-width': isDanger ? 1.5 : 0.8
          }));

          // ‚îÄ‚îÄ Change label ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          const changeColor = pctChange < -0.5 ? '#14b8a6'
            : pctChange > 0.5 ? '#8b5cf6'
              : '#475569';
          svgText(svgL, LBL_W + SLOPE_W + 6, yMid + 3.5,
            sign + pctChange.toFixed(2), {
            'font-size': '9.5',
            'font-family': 'DM Mono, monospace',
            fill: changeColor
          });

          // ‚îÄ‚îÄ Raw diff label ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          const rawDiff = d.blank_change || 0;
          const rawSign = rawDiff >= 0 ? '+' : '';
          svgText(svgL, LBL_W + SLOPE_W + 50, yMid + 3.5,
            rawSign + rawDiff.toLocaleString(), {
            'font-size': '9',
            'font-family': 'DM Mono, monospace',
            fill: changeColor
          });

          // ‚îÄ‚îÄ MID SVG: runner-up party dot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          svgM.appendChild(svgEl('circle', {
            cx: DOT_COL_W + 15, cy: yMid, r: R + 0.5,
            fill: pc(runnerUpParty(d)),
            stroke: T('rgba(255,255,255,0.3)', 'rgba(0,0,0,0.25)'),
            'stroke-width': 0.8
          }));

          // ‚îÄ‚îÄ RIGHT SVG: 100% bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          const mVal = d.margin_2569 || 0;
          const iVal = d.blank_2569 || 0;
          const total = mVal + iVal;
          const marginW = total > 0 ? (mVal / total) * BAR_W : 0;
          const invalidW = total > 0 ? (iVal / total) * BAR_W : 0;
          const bx = BAR_GAP;
          const by = y0 + 2;
          const bh = ROW_H - 4;

          // Margin segment
          svgR.appendChild(svgEl('rect', {
            x: bx, y: by, width: marginW, height: bh,
            fill: T('rgba(255,255,255,0.3)', 'rgba(0,0,0,0.15)'), opacity: 0.75, rx: 1
          }));

          // Blank segment
          svgR.appendChild(svgEl('rect', {
            x: bx + marginW, y: by, width: invalidW, height: bh,
            fill: isDanger ? '#8b5cf6' : '#c4b5fd',
            opacity: isDanger ? 0.9 : 0.7, rx: 1
          }));

          // Danger indicator
          if (isDanger) {
            svgText(svgR, bx + BAR_W + 5, yMid + 3.5, '‚ö†', {
              'font-size': '9.5', fill: '#8b5cf6'
            });
            // Numbers in bar
            svgText(svgR, bx + 2, yMid + 3.5,
              mVal.toLocaleString(), {
              'text-anchor': 'start', 'font-size': '8.5',
              'font-family': 'DM Mono, monospace',
              fill: '#ffffff'
            });
            svgText(svgR, bx + marginW + invalidW - 2, yMid + 3.5,
              iVal.toLocaleString(), {
              'text-anchor': 'end', 'font-size': '8.5',
              'font-family': 'DM Mono, monospace',
              fill: '#ffffff'
            });
          }
        });

        // ‚îÄ‚îÄ Update header stats (based on current filtered data) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const dangerRows      = data.filter(d => d.blank_2569 > d.margin_2569);
        const improvedRows    = data.filter(d => d.blank_pct_change < 0);   // Œî% down
        const worseRows       = data.filter(d => d.blank_pct_change > 0);   // Œî% up
        const improvedRawRows = data.filter(d => d.blank_change < 0);       // Œî# down
        const worseRawRows    = data.filter(d => d.blank_change > 0);       // Œî# up

        // Counts by Œî%
        document.getElementById('hs-danger').textContent   = dangerRows.length;
        document.getElementById('hs-improved').textContent = improvedRows.length;
        document.getElementById('hs-worse').textContent    = worseRows.length;

        // Counts by Œî# (raw)
        const elImpRaw = document.getElementById('hs-improved-raw');
        const elWrsRaw = document.getElementById('hs-worse-raw');
        if (elImpRaw) elImpRaw.textContent = improvedRawRows.length;
        if (elWrsRaw) elWrsRaw.textContent = worseRawRows.length;

        // L and R ballot sums per category
        const sumL = rows => rows.reduce((s, d) => s + (d.blank || 0), 0);
        const sumR = rows => rows.reduce((s, d) => s + (d.blank_2569 || 0), 0);
        const fmt  = n => n.toLocaleString() + ' ‡∏ö‡∏±‡∏ï‡∏£';

        document.getElementById('hs-danger-sum-l').textContent   = fmt(sumL(dangerRows));
        document.getElementById('hs-danger-sum-r').textContent   = fmt(sumR(dangerRows));
        document.getElementById('hs-improved-sum-l').textContent = fmt(sumL(improvedRows));
        document.getElementById('hs-improved-sum-r').textContent = fmt(sumR(improvedRows));
        document.getElementById('hs-worse-sum-l').textContent    = fmt(sumL(worseRows));
        document.getElementById('hs-worse-sum-r').textContent    = fmt(sumR(worseRows));
        document.getElementById('hs-improved-raw-sum-l').textContent = fmt(sumL(improvedRawRows));
        document.getElementById('hs-improved-raw-sum-r').textContent = fmt(sumR(improvedRawRows));
        document.getElementById('hs-worse-raw-sum-l').textContent    = fmt(sumL(worseRawRows));
        document.getElementById('hs-worse-raw-sum-r').textContent    = fmt(sumR(worseRawRows));

        const elSumL = document.getElementById('hs-all-sum-l');
        const elSumR = document.getElementById('hs-all-sum-r');
        if (elSumL) elSumL.textContent = fmt(sumL(data));
        if (elSumR) elSumR.textContent = fmt(sumR(data));

        // "All" summary: direction counts by Œî% and Œî#
        const allInc    = fullProcessedData.filter(d => d.blank_pct_change > 0).length;
        const allDec    = fullProcessedData.filter(d => d.blank_pct_change < 0).length;
        const allIncRaw = fullProcessedData.filter(d => d.blank_change > 0).length;
        const allDecRaw = fullProcessedData.filter(d => d.blank_change < 0).length;
        const summaryEl    = document.getElementById('hs-all-summary');
        const summaryRawEl = document.getElementById('hs-all-summary-raw');
        if (summaryEl)    summaryEl.textContent    = `‚Üë${allInc} / ‚Üì${allDec}`;
        if (summaryRawEl) summaryRawEl.textContent = `‚Üë${allIncRaw} / ‚Üì${allDecRaw}`;

        svgR.setAttribute('height', H);
        buildLegend(data);
      }

      // ‚îÄ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function showTip(e, d, isDanger, sign, pctChange) {
        const tip = document.getElementById('tooltip');
        if (!tip) return;

        const runnerUpName = runnerUpParty(d);
        const runnerUpCol = pc(runnerUpName);
        const changeColor = pctChange < 0 ? '#14b8a6' : '#8b5cf6';

        const leftLabel = document.getElementById('archive-select-left').options[document.getElementById('archive-select-left').selectedIndex].text.split(' | ')[0];
        const rightLabel = document.getElementById('archive-select-right').options[document.getElementById('archive-select-right').selectedIndex].text.split(' | ')[0];

        const leftMargin = (d.margin || 0);
        const rightMargin = (d.margin_2569 || 0);
        const leftBlank = (d.blank || 0);
        const rightBlank = (d.blank_2569 || 0);
        const leftDanger = leftBlank > leftMargin;
        const rightDanger = rightBlank > rightMargin;

        tip.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px;">${d.province_thai} ‡πÄ‡∏Ç‡∏ï ${d.cons_no}</div>
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 6px;">${d.province_eng}</div>

        <div style="display: flex; gap: 12px; margin-bottom: 8px;">
          <!-- Left Column -->
          <div style="flex: 1; border-right: 1px dashed var(--border); padding-right: 8px;">
            <div style="font-size: 10px; color: var(--muted); margin-bottom: 6px; font-weight: bold;">${leftLabel}</div>

            <div style="font-size: 11px; margin-bottom: 3px; display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                <span style="display:inline-block; min-width:8px; height:8px; border-radius:50%; background:${pc(d.winner_party)}; margin-top: 1px;"></span>
                <b title="${d.winner_party}" style="overflow: hidden; text-overflow: ellipsis;">${d.winner_party}</b>
              </div>
              <span style="font-family: 'DM Mono'; color: var(--muted);">${(d.winner_votes || 0).toLocaleString()}</span>
            </div>

            <div style="font-size: 11px; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                <span style="display:inline-block; min-width:8px; height:8px; border-radius:50%; background:${pc(d.runnerup_party || 'Unknown')}; margin-top: 1px;"></span>
                <span title="${d.runnerup_party || 'Unknown'}" style="overflow: hidden; text-overflow: ellipsis;">${d.runnerup_party || 'Unknown'}</span>
              </div>
              <span style="font-family: 'DM Mono'; color: var(--muted);">${(d.runnerup_votes || 0).toLocaleString()}</span>
            </div>

            <div style="font-size: 10px; display: flex; justify-content: space-between; margin-bottom: 3px;">
              <span style="color: var(--muted);">‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á:</span>
              <span style="font-family: 'DM Mono'; color: var(--teal);">${leftMargin.toLocaleString()}</span>
            </div>
            <div style="font-size: 10px; display: flex; justify-content: space-between;">
              <span style="color: var(--muted);">‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</span>
              <span style="font-family: 'DM Mono'; color: ${leftDanger ? '#8b5cf6' : 'var(--text)'}; font-weight: ${leftDanger ? 'bold' : 'normal'};">
                ${leftBlank.toLocaleString()} <span style="font-size:9px;opacity:0.75;font-weight:normal;">(${(d.percent_blank || 0).toFixed(2)}%)</span>
              </span>
            </div>
          </div>

          <!-- Right Column -->
          <div style="flex: 1;">
            <div style="font-size: 10px; color: var(--muted); margin-bottom: 6px; font-weight: bold;">${rightLabel}</div>

            <div style="font-size: 11px; margin-bottom: 3px; display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                <span style="display:inline-block; min-width:8px; height:8px; border-radius:50%; background:${pc(d.winner_party_2569)}; margin-top: 1px;"></span>
                <b title="${d.winner_party_2569}" style="overflow: hidden; text-overflow: ellipsis;">${d.winner_party_2569}</b>
              </div>
              <span style="font-family: 'DM Mono'; color: var(--muted);">${(d.winner_votes_2569 || 0).toLocaleString()}</span>
            </div>

            <div style="font-size: 11px; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                <span style="display:inline-block; min-width:8px; height:8px; border-radius:50%; background:${pc(d.runnerup_party_2569 || 'Unknown')}; margin-top: 1px;"></span>
                <span title="${d.runnerup_party_2569 || 'Unknown'}" style="overflow: hidden; text-overflow: ellipsis;">${d.runnerup_party_2569 || 'Unknown'}</span>
              </div>
              <span style="font-family: 'DM Mono'; color: var(--muted);">${(d.runnerup_votes_2569 || 0).toLocaleString()}</span>
            </div>

            <div style="font-size: 10px; display: flex; justify-content: space-between; margin-bottom: 3px;">
              <span style="color: var(--muted);">‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á:</span>
              <span style="font-family: 'DM Mono'; color: var(--teal);">${rightMargin.toLocaleString()}</span>
            </div>
            <div style="font-size: 10px; display: flex; justify-content: space-between;">
              <span style="color: var(--muted);">‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</span>
              <span style="font-family: 'DM Mono'; color: ${rightDanger ? '#8b5cf6' : 'var(--text)'}; font-weight: ${rightDanger ? 'bold' : 'normal'};">
                ${rightBlank.toLocaleString()} <span style="font-size:9px;opacity:0.75;font-weight:normal;">(${(d.percent_blank_2569 || 0).toFixed(2)}%)</span>
              </span>
            </div>
          </div>
        </div>

        <div style="font-size: 11px; border-top: 1px solid var(--border); padding-top: 6px; display: flex; justify-content: space-between; align-items: center;">
          <span style="color: var(--muted);">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:</span>
          <span style="font-family: 'DM Mono'; color: ${changeColor}; font-weight: bold;">${sign}${Math.abs(pctChange || 0).toFixed(2)} pp</span>
        </div>

        ${rightDanger ? `<div style="margin-top: 8px; color: #8b5cf6; font-weight: bold; font-size: 10px; text-align: center; background: rgba(139, 92, 246, 0.1); padding: 4px; border-radius: 4px;">‚ö† ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ > ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>` : ''}
      `;

        tip.style.display = 'block';

        let posX = e.clientX + 15;
        let posY = e.clientY + 15;

        if (posX + 250 > window.innerWidth) {
          posX = e.clientX - 260;
        }
        if (posY + 200 > window.innerHeight) {
          posY = e.clientY - tip.offsetHeight - 20;
        }

        tip.style.left = posX + 'px';
        tip.style.top = posY + 'px';
      }

      function hideTip() {
        document.getElementById('tooltip').style.display = 'none';
      }

      // ‚îÄ‚îÄ‚îÄ PARTY LEGEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function buildLegend(currentData) {
        const container = document.getElementById('party-legend');
        container.innerHTML = '';

        const rightSel = document.getElementById('archive-select-right');
        let rightLabel = rightSel.options[rightSel.selectedIndex].text.split(' | ')[0] || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö';
        rightLabel = rightLabel.replace('Election ', '').split(' (')[0].trim();
        const titleEl = document.getElementById('party-legend-title');
        if (titleEl) titleEl.textContent = `‡∏û‡∏£‡∏£‡∏Ñ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ (${rightLabel})`;

        const visibleParties = new Set();
        currentData.forEach(d => {
          visibleParties.add(d.winner_party_2569);
          visibleParties.add(runnerUpParty(d));
        });

        const sortedParties = [...visibleParties].filter(Boolean).sort((a, b) => (a ?? '').localeCompare(b ?? '', 'th'));

        sortedParties.forEach(p => {
          const div = document.createElement('div');
          div.className = 'dot-label';
          div.innerHTML = `<div class="dot-swatch" style="background:${pc(p)}"></div>${p}`;
          container.appendChild(div);
        });
      }

      // ‚îÄ‚îÄ‚îÄ CAPTURE IMAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function captureImage() {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚è≥ Processing...';
        btn.disabled = true;

        const element = document.getElementById('capture-container');
        const chartScroll = document.getElementById('chart-area');
        const header = document.getElementById('header');

        const originalContainerStyle = element.style.cssText;
        const originalHeaderStyle = header.style.cssText;
        const originalChartStyle = chartScroll.style.cssText;

        try {
          element.style.height = 'auto';
          element.style.width = '1200px';
          element.style.position = 'relative';
          element.style.padding = '40px';

          header.style.position = 'relative';
          header.style.width = '100%';
          header.style.top = '0';
          header.style.left = '0';

          chartScroll.style.height = 'auto';
          chartScroll.style.overflow = 'visible';
          chartScroll.style.position = 'relative';
          chartScroll.style.marginTop = '20px';
          chartScroll.style.marginLeft = '0';
          chartScroll.style.marginRight = '0';

          const dataUrl = await htmlToImage.toPng(element, {
            backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg'),
            quality: 0.95,
            pixelRatio: data.length > 50 ? 1 : 2,
            cacheBust: true,
          });

          const link = document.createElement('a');
          link.download = `election-blank-${new Date().getTime()}.png`;
          link.href = dataUrl;
          link.click();

          btn.textContent = originalText;
        } catch (err) {
          console.error("Capture Error:", err);
          btn.textContent = '‚ùå Error';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 3000);
        } finally {
          element.style.cssText = originalContainerStyle;
          header.style.cssText = originalHeaderStyle;
          chartScroll.style.cssText = originalChartStyle;
          btn.disabled = false;
        }
      }

      // ‚îÄ‚îÄ‚îÄ ARCHIVE LOADING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadArchive(url, side) {
        console.log(`[DATA] Fetching ${side} from ${url}...`);
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const text = await res.text();

        const parseVar = (varName) => {
          const idx = text.indexOf(varName);
          if (idx === -1) return [];
          const arrStart = text.indexOf('[', idx);
          const arrEnd = text.indexOf('];', arrStart);
          if (arrStart !== -1 && arrEnd !== -1) {
            return JSON.parse(text.substring(arrStart, arrEnd + 1));
          }
          return [];
        };

        const lastModified = res.headers.get('Last-Modified');
        const tsMatch = text.match(/\/\/ Generated:\s*(.+)/);
        let tsLabel;
        if (tsMatch) {
          tsLabel = tsMatch[1].trim();
        } else if (lastModified) {
          const d = new Date(lastModified);
          tsLabel = d.toLocaleString('th-TH', { timeZone: 'Asia/Bangkok', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) + ' (ICT)';
        } else {
          tsLabel = '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà';
        }

        const selId = side === 'left' ? 'archive-select-left' : 'archive-select-right';
        const sel = document.getElementById(selId);
        const datasetName = sel ? sel.options[sel.selectedIndex].text : url;

        const tsEl = document.getElementById(side === 'left' ? 'ts-left' : 'ts-right');
        if (tsEl) tsEl.textContent = `${datasetName}: ${tsLabel}`;

        const rawConst = parseVar('CONST_RAW');
        const rawPL = parseVar('PARTYLIST_RAW');

        if (side === 'left') {
          DATA_LEFT = { raw: rawConst.map(normalizeRecord), pl: rawPL.map(normalizeRecord) };
        } else {
          DATA_RIGHT = { raw: rawConst.map(normalizeRecord), pl: rawPL.map(normalizeRecord) };
        }
      }

      // Attach a hover tooltip to a single bar segment
      function attachBarTip(el, label, count, pct, dsLabel, color) {
        if (!el) return;
        el.style.cursor = count > 0 ? 'crosshair' : 'default';
        if (count > 0) {
          el.onmousemove = (e) => {
            const tip = document.getElementById('tooltip');
            if (!tip) return;
            tip.innerHTML = `
              <div style="font-size:0.68rem;color:var(--muted);margin-bottom:6px;font-family:'DM Mono',monospace;">${dsLabel}</div>
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:5px;">
                <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};flex-shrink:0;"></span>
                <b>${label}</b>
              </div>
              <div style="font-family:'DM Mono',monospace;font-size:0.88rem;">${count.toLocaleString()} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
              <div style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted);margin-top:2px;">${pct}% ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>
            `;
            tip.style.display = 'block';
            tip.style.left = Math.min(e.clientX + 14, window.innerWidth - 340) + 'px';
            tip.style.top = Math.min(e.clientY + 14, window.innerHeight - 130) + 'px';
          };
          el.onmouseleave = () => { document.getElementById('tooltip').style.display = 'none'; };
        } else {
          el.onmousemove = null;
          el.onmouseleave = null;
        }
      }

      function updateVoteBar() {
        const leftRaw = currentDataset === 'partylist' ? DATA_LEFT.pl : (DATA_LEFT.raw || []);

        const leftSel = document.getElementById('archive-select-left');
        const rightSel = document.getElementById('archive-select-right');
        const leftLabel = leftSel ? leftSel.options[leftSel.selectedIndex].text.split(' | ')[0] : 'L';
        const rightLabel = rightSel ? rightSel.options[rightSel.selectedIndex].text.split(' | ')[0] : 'R';

        // ‚îÄ‚îÄ LEFT bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let lPBl = '0';
        if (leftRaw.length) {
          let totW = 0, totRu = 0, totBlank = 0, totAll = 0;
          let winnerParty = '', winnerMax = 0;
          const partyCounts = {};
          leftRaw.forEach(d => {
            totW += (d.winner_votes || 0);
            totRu += (d.runnerup_votes || 0);
            totBlank += (d.blank || 0);
            totAll += (d.turn_out || 0);
            const p = d.winner_party || 'Unknown';
            partyCounts[p] = (partyCounts[p] || 0) + (d.winner_votes || 0);
            if (partyCounts[p] > winnerMax) { winnerMax = partyCounts[p]; winnerParty = p; }
          });
          if (totAll > 0) {
            const totValid = totAll - totBlank;
            const totRest = Math.max(totValid - totW - totRu, 0);
            const pW = (totW / totAll * 100).toFixed(2);
            const pRu = (totRu / totAll * 100).toFixed(2);
            const pRe = (totRest / totAll * 100).toFixed(2);
            lPBl = (totBlank / totAll * 100).toFixed(2);
            const wColor = pc(winnerParty);
            const bW = document.getElementById('vb-winner');
            const bRu = document.getElementById('vb-runner');
            const bRe = document.getElementById('vb-rest');
            const bIn = document.getElementById('vb-invalid');
            if (bW) { bW.style.width = pW + '%'; bW.style.background = wColor; }
            if (bRu) { bRu.style.width = pRu + '%'; bRu.style.background = '#94a3b8'; }
            if (bRe) bRe.style.width = pRe + '%';
            if (bIn) bIn.style.width = lPBl + '%';
            attachBarTip(bW,  '‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞',           totW,     pW,   leftLabel, wColor);
            attachBarTip(bRu, '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2',           totRu,    pRu,  leftLabel, '#94a3b8');
            attachBarTip(bRe, '‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠',       totRest,  pRe,  leftLabel, '#64748b');
            attachBarTip(bIn, '‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î',  totBlank, lPBl, leftLabel, '#8b5cf6');
          }
        } else {
          ['vb-winner','vb-runner','vb-rest','vb-invalid'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.width = '0%';
          });
        }

        // ‚îÄ‚îÄ RIGHT bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const rightRaw = currentDataset === 'partylist' ? (DATA_RIGHT && DATA_RIGHT.pl) : (DATA_RIGHT && DATA_RIGHT.raw);
        let rPBl = '0';
        const hasRight = rightRaw && rightRaw.length > 0;
        if (hasRight) {
          let totW = 0, totRu = 0, totBlank = 0, totAll = 0;
          let winnerParty = '', winnerMax = 0;
          const partyCounts = {};
          rightRaw.forEach(d => {
            totW += (d.winner_votes || 0);
            totRu += (d.runnerup_votes || 0);
            totBlank += (d.blank || 0);
            totAll += (d.turn_out || 0);
            const p = d.winner_party || 'Unknown';
            partyCounts[p] = (partyCounts[p] || 0) + (d.winner_votes || 0);
            if (partyCounts[p] > winnerMax) { winnerMax = partyCounts[p]; winnerParty = p; }
          });
          if (totAll > 0) {
            const totValid = totAll - totBlank;
            const totRest = Math.max(totValid - totW - totRu, 0);
            const pW = (totW / totAll * 100).toFixed(2);
            const pRu = (totRu / totAll * 100).toFixed(2);
            const pRe = (totRest / totAll * 100).toFixed(2);
            rPBl = (totBlank / totAll * 100).toFixed(2);
            const wColor = pc(winnerParty);
            const bW = document.getElementById('vbr-winner');
            const bRu = document.getElementById('vbr-runner');
            const bRe = document.getElementById('vbr-rest');
            const bIn = document.getElementById('vbr-invalid');
            if (bW) { bW.style.width = pW + '%'; bW.style.background = wColor; }
            if (bRu) bRu.style.width = pRu + '%';
            if (bRe) bRe.style.width = pRe + '%';
            if (bIn) bIn.style.width = rPBl + '%';
            attachBarTip(bW,  '‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞',           totW,     pW,   rightLabel, wColor);
            attachBarTip(bRu, '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2',           totRu,    pRu,  rightLabel, '#94a3b8');
            attachBarTip(bRe, '‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠',       totRest,  pRe,  rightLabel, '#64748b');
            attachBarTip(bIn, '‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î',  totBlank, rPBl, rightLabel, '#8b5cf6');
          }
        } else {
          ['vbr-winner','vbr-runner','vbr-rest','vbr-invalid'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.width = '0%';
          });
        }

        // ‚îÄ‚îÄ L/R labels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const lbl_l = document.getElementById('vb-l-label');
        const lbl_r = document.getElementById('vb-r-label');
        if (lbl_l) lbl_l.textContent = leftLabel.replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','').replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á','') || 'L';
        if (lbl_r) lbl_r.textContent = (hasRight ? rightLabel.replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','').replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á','') : '‚Äî') || 'R';

        // ‚îÄ‚îÄ Legend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const leg = document.getElementById('vote-bar-legend');
        if (leg) leg.innerHTML = `
            <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#8b5cf6;vertical-align:middle;margin-right:3px;"></span>L ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${lPBl}%</span>
            ${hasRight ? `<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#8b5cf6;opacity:0.5;vertical-align:middle;margin-right:3px;"></span>R ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${rPBl}%</span>` : ''}
            <span style="color:var(--muted);font-size:0.65rem;">‚óè ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ &nbsp;‚óè ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2 &nbsp;‚óè ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ &nbsp;‚óè ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
          `;
      }

      function renderAll() {
        processRawData();
        updateCounts();
        updateMissingWarning();
        buildChart();
        if (data.length > 0) buildLegend(data);
        updateVoteBar();
      }

      // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function toggleSidebar(side) {
        if (side === 'left') {
          document.getElementById('left-sidebar').classList.toggle('show');
          document.getElementById('right-sidebar').classList.remove('show');
        } else {
          document.getElementById('right-sidebar').classList.toggle('show');
          document.getElementById('left-sidebar').classList.remove('show');
        }

        if (document.getElementById('left-sidebar').classList.contains('show') || document.getElementById('right-sidebar').classList.contains('show')) {
          document.getElementById('sidebar-overlay').classList.add('show');
        } else {
          document.getElementById('sidebar-overlay').classList.remove('show');
        }
      }

      function closeSidebars() {
        document.getElementById('left-sidebar').classList.remove('show');
        document.getElementById('right-sidebar').classList.remove('show');
        document.getElementById('sidebar-overlay').classList.remove('show');
      }

      // ‚îÄ‚îÄ‚îÄ DYNAMIC HEADER HEIGHT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function updateHeaderHeight() {
        const h = document.getElementById('header').getBoundingClientRect().height;
        document.documentElement.style.setProperty('--header-h', h + 'px');
      }

      // ‚îÄ‚îÄ‚îÄ DYNAMIC TITLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function updateHeaderTitle() {
        const leftSel = document.getElementById('archive-select-left');
        const rightSel = document.getElementById('archive-select-right');
        if (!leftSel || !rightSel) return;

        const getShort = (sel) => {
          const txt = sel.options[sel.selectedIndex].text;
          if (txt.includes('(OCR)')) return '2569 (OCR)';
          if (txt.includes('(94%)')) return '2569 (94%)';
          const m = txt.match(/(\d{4})/);
          return m ? m[1] : txt.split(' (')[0].trim();
        };

        const leftYear = getShort(leftSel);
        const rightYear = getShort(rightSel);
        const titleEl = document.getElementById('header-title');
        const subtitleEl = document.getElementById('header-subtitle');
        if (titleEl) titleEl.textContent = `‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î : ${leftYear} ‚Üí ${rightYear}`;
        if (subtitleEl) subtitleEl.textContent = `‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î ¬∑ ${fullProcessedData.length || 0} ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ä‡∏∏‡∏î ¬∑ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° % ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á`;
      }

      function initApp() {
        document.getElementById('btn-load-comparison').addEventListener('click', async () => {
          const btn = document.getElementById('btn-load-comparison');
          btn.textContent = "Loading...";
          btn.disabled = true;

          try {
            const valL = document.getElementById('archive-select-left').value;
            const valR = document.getElementById('archive-select-right').value;

            await Promise.all([
              loadArchive(valL, 'left'),
              loadArchive(valR, 'right')
            ]);

            document.getElementById('prompt-overlay').style.display = 'none';
            document.getElementById('chart-area').style.display = 'flex';

            switchDataset(currentDataset);
            updateHeaderTitle();
          } catch (e) {
            alert("Error loading datasets. Ensure you are running a local web server (e.g. python -m http.server)");
            console.error(e);
          } finally {
            btn.textContent = "‚úî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (confirm)";
            btn.disabled = false;
          }
        });

        // Measure real header height and update CSS variable
        updateHeaderHeight();
        window.addEventListener('resize', updateHeaderHeight);
        if (window.ResizeObserver) {
          new ResizeObserver(updateHeaderHeight).observe(document.getElementById('header'));
        }

        // Update title on dropdown change without reloading
        document.getElementById('archive-select-left').addEventListener('change', updateHeaderTitle);
        document.getElementById('archive-select-right').addEventListener('change', updateHeaderTitle);
      }

      initApp();
    </script>

</body>

</html>
