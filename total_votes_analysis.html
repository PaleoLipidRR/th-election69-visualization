<!DOCTYPE html>
<html lang="th" data-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thailand Total Votes Analysis 2566‚Äì2569</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #080e1a; --surface: #0f1827; --border: #1a2740; --text: #cbd5e1;
      --muted: #475569; --faint: #1e2d42; --red: #ef4444; --amber: #f59e0b;
      --teal: #14b8a6; --ring: #ffffff;
    }
    [data-theme="light"] {
      --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text: #1e293b;
      --muted: #64748b; --faint: #f1f5f9; --ring: #1e293b;
    }

    body { background: var(--bg); color: var(--text); font-family: 'Sarabun', sans-serif; font-size: 18px; min-height: 100vh; }

    #header {
      position: sticky; top: 0; z-index: 100; background: var(--bg);
      border-bottom: 1px solid var(--border); padding: 12px 28px;
      display: flex; align-items: center; gap: 16px; flex-wrap: nowrap;
    }
    .header-main-group { display: flex; flex-wrap: nowrap; align-items: center; gap: 24px; flex: 1; min-width: 0; }
    #header h1 { font-size: 1.3rem; font-weight: 600; color: var(--text); letter-spacing: -0.01em; }
    #header p { font-size: 0.85rem; color: var(--muted); font-family: 'DM Mono', monospace; margin-top: 3px; }
    .header-stats { display: flex; gap: 20px; align-items: center; flex-shrink: 0; }
    .hstat { text-align: right; white-space: nowrap; }
    .hstat .v { font-family: 'DM Mono', monospace; font-size: 1.15rem; font-weight: 500; color: var(--text); }
    .hstat .l { font-size: 0.78rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }

    .archive-container { margin-right: 16px; display: flex; flex-direction: column; gap: 4px; }
    .archive-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
    .archive-select {
      background: var(--surface); border: 1px solid var(--border); color: var(--text);
      padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;
      font-family: 'DM Mono', monospace; cursor: pointer; outline: none; min-width: 180px;
    }
    .archive-select:hover { border-color: var(--amber); }

    #legend {
      padding: 8px 28px; display: flex; gap: 20px; flex-wrap: wrap;
      border-bottom: 1px solid var(--border); font-size: 0.82rem; color: var(--muted);
      background: var(--bg); position: sticky; top: 80px; z-index: 99;
      margin-left: 250px; margin-right: 190px;
    }
    .legend-group { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .dot-label { display: flex; align-items: center; gap: 4px; font-size: 0.8rem; }
    .dot-swatch { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .bar-swatch { width: 14px; height: 8px; border-radius: 1px; flex-shrink: 0; }

    #wrapper { display: flex; padding: 0; height: calc(100vh - var(--header-h, 68px)); width: 100%; overflow: hidden; }
    #chart-area {
      display: flex; padding: 0 28px; margin-left: 250px; margin-right: 190px;
      flex: 1; height: 100%; overflow-y: auto; overflow-x: auto;
      align-items: flex-start; background: var(--bg);
    }

    #left-sidebar, #right-sidebar {
      position: fixed; top: var(--header-h, 68px);
      height: calc(100vh - var(--header-h, 68px)); z-index: 97; overflow-y: auto;
    }

    #tooltip {
      position: fixed; display: none; background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px; font-size: 13px; z-index: 10001;
      pointer-events: none; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.4); width: 340px; color: var(--text);
    }
    #tooltip b { color: var(--text); }

    .ctrl-label { color: var(--muted); margin-right: 4px; }
    .btn-sort {
      background: var(--surface); border: 1px solid var(--border); color: var(--text);
      padding: 3px 10px; border-radius: 3px; cursor: pointer; font-size: 0.82rem;
      font-family: 'DM Mono', monospace; transition: border-color 0.15s, color 0.15s;
    }
    .btn-sort:hover { border-color: var(--amber); color: var(--amber); }
    .btn-sort.active { border-color: var(--amber); color: var(--amber); background: rgba(245,158,11,0.06); }
    .btn-dataset.active { border-color: var(--amber); color: var(--amber); background: rgba(245,158,11,0.06); }
    .btn-method.active  { border-color: var(--amber); color: var(--amber); background: rgba(245,158,11,0.06); }

    #left-sidebar {
      left: 0; width: 250px; border-right: 1px solid var(--border);
      background: var(--bg); padding: 16px 12px;
      display: flex; flex-direction: column; gap: 6px;
    }
    #right-sidebar {
      right: 0; width: 190px; border-left: 1px solid var(--border);
      background: var(--bg); padding: 16px 12px;
      display: flex; flex-direction: column; gap: 5px;
    }
    .sidebar-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 6px; }
    #left-sidebar .btn-filter { display: block; width: 100%; text-align: left; white-space: normal; line-height: 1.4; padding: 5px 10px; }
    #right-sidebar #party-legend { display: flex; flex-direction: column; gap: 5px; }
    #left-sidebar .btn-sort:not(.btn-filter) { display: block; width: 100%; text-align: left; }
    .sidebar-divider { height: 1px; background: var(--border); margin: 10px 0 14px; }

    svg { display: block; overflow: visible; }
    .mobile-menu-btn {
      display: none; background: var(--surface); border: 1px solid var(--border);
      color: var(--text); padding: 6px 12px; border-radius: 4px; cursor: pointer;
      font-size: 0.9rem; margin-right: 12px;
    }

    @media (max-width: 1100px) {
      .mobile-menu-btn { display: block; }
      #left-sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
      #left-sidebar.show { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
      #right-sidebar { transform: translateX(100%); transition: transform 0.3s ease; }
      #right-sidebar.show { transform: translateX(0); box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
      #chart-area { margin-left: 0; margin-right: 0; padding: 0 10px; width: 100%; }
      #sidebar-overlay { display: none; position: fixed; top: 80px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 96; }
      #sidebar-overlay.show { display: block; }
      .header-stats { margin-left: 0; width: 100%; gap: 12px; justify-content: space-between; }
      .hstat { text-align: left; }
      .archive-container { width: 100%; margin-right: 0; }
    }
    @media print {
      #left-sidebar, #right-sidebar { display: none !important; }
      #header { position: static !important; }
      #chart-area { margin-left: 0 !important; margin-right: 0 !important; overflow: visible !important; }
      body { background: white !important; }
    }
  </style>
</head>

<body>
  <div id="capture-container" style="background: var(--bg); padding: 20px 0;">
    <div id="header">
      <button class="mobile-menu-btn" onclick="toggleSidebar('left')">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>
      <div class="header-main-group">
        <div style="flex:1; min-width:0;">
          <h1 id="header-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå : ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2566 ‚Üí 2569</h1>
          <p id="header-subtitle">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ¬∑ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Œî ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</p>
        </div>
        <div class="header-stats">
          <div class="hstat">
            <div class="v" id="hs-increased">‚Äî</div>
            <div class="l" id="hs-increased-l">‚Üë ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;margin-top:2px;color:var(--muted);">
              <span style="opacity:0.65">L</span>&nbsp;<span id="hs-increased-sum-l" style="color:var(--text)">‚Äî</span>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);">
              <span style="opacity:0.65">R</span>&nbsp;<span id="hs-increased-sum-r" style="color:var(--teal)">‚Äî</span>
            </div>
          </div>
          <div class="hstat">
            <div class="v" id="hs-decreased">‚Äî</div>
            <div class="l" id="hs-decreased-l">‚Üì ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏î‡∏•‡∏á</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;margin-top:2px;color:var(--muted);">
              <span style="opacity:0.65">L</span>&nbsp;<span id="hs-decreased-sum-l" style="color:var(--text)">‚Äî</span>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);">
              <span style="opacity:0.65">R</span>&nbsp;<span id="hs-decreased-sum-r" style="color:var(--red)">‚Äî</span>
            </div>
          </div>
          <div class="hstat">
            <div class="v" id="hs-discrepancy">‚Äî</div>
            <div class="l" id="hs-discrepancy-l">‚ö† ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô (R)</div>
            <div id="hs-discrepancy-note" style="font-size:0.62rem;color:var(--muted);font-family:'DM Mono',monospace;">turn_out ‚â† v+i+b</div>
          </div>
          <div class="hstat" style="border-left:1px solid var(--border);padding-left:20px;margin-left:4px">
            <div class="v" id="hs-all-summary">‚Äî</div>
            <div class="l">‚Üë‚Üì ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;margin-top:2px;color:var(--muted);">
              <span style="opacity:0.65">L</span>&nbsp;<span id="hs-all-sum-l" style="color:var(--text)">‚Äî</span>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--muted);">
              <span style="opacity:0.65">R</span>&nbsp;<span id="hs-all-sum-r" style="color:var(--text)">‚Äî</span>
            </div>
          </div>
        </div>
      </div>
      <button class="mobile-menu-btn" onclick="toggleSidebar('right')" style="margin-left:auto;">‚òÖ ‡∏û‡∏£‡∏£‡∏Ñ</button>
    </div>

    <div id="missing-data-warning" style="
      display:none; background:rgba(245,158,11,0.1); border-bottom:1px solid rgba(245,158,11,0.35);
      padding:4px 28px; font-size:0.72rem; font-family:'DM Mono',monospace;
      color:#d97706; margin-left:250px; margin-right:190px;
    "></div>

    <!-- Aggregate Vote Bar -->
    <div id="vote-bar-wrap" style="
      position:sticky; top:var(--header-h,68px); z-index:98; background:var(--bg);
      border-bottom:1px solid var(--border); padding:6px 28px 7px;
      margin-left:250px; margin-right:190px;
    ">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
        <div id="vb-l-label" style="font-size:0.65rem;font-family:'DM Mono',monospace;color:var(--muted);min-width:45px;text-align:right;">L</div>
        <div id="vote-bar" style="display:flex;height:10px;border-radius:5px;overflow:hidden;flex:1;background:var(--border);">
          <div id="vb-winner" style="height:100%;transition:width 0.4s;"></div>
          <div id="vb-runner" style="height:100%;transition:width 0.4s;"></div>
          <div id="vb-rest"   style="height:100%;background:#64748b;opacity:0.4;transition:width 0.4s;"></div>
          <div id="vb-blank"  style="height:100%;background:#8b5cf6;transition:width 0.4s;"></div>
          <div id="vb-invalid" style="height:100%;background:#ef4444;transition:width 0.4s;"></div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
        <div id="vb-r-label" style="font-size:0.65rem;font-family:'DM Mono',monospace;color:var(--muted);min-width:45px;text-align:right;">R</div>
        <div id="vote-bar-right" style="display:flex;height:10px;border-radius:5px;overflow:hidden;flex:1;background:var(--border);">
          <div id="vbr-winner"  style="height:100%;transition:width 0.4s;"></div>
          <div id="vbr-runner"  style="height:100%;background:#94a3b8;transition:width 0.4s;"></div>
          <div id="vbr-rest"    style="height:100%;background:#64748b;opacity:0.4;transition:width 0.4s;"></div>
          <div id="vbr-blank"   style="height:100%;background:#8b5cf6;transition:width 0.4s;"></div>
          <div id="vbr-invalid" style="height:100%;background:#ef4444;transition:width 0.4s;"></div>
        </div>
      </div>
      <div id="vote-bar-legend" style="display:flex;gap:14px;flex-wrap:wrap;align-items:center;font-size:0.72rem;color:var(--muted);font-family:'DM Mono',monospace;"></div>
    </div>

    <div id="sidebar-overlay" onclick="closeSidebars()"></div>

    <div id="wrapper">
      <!-- LEFT SIDEBAR -->
      <div id="left-sidebar">
        <button class="btn-sort" onclick="window.location.href='index.html'"
          style="font-size:0.75rem;padding:3px 10px;margin-bottom:4px;margin-top:10px;width:100%;">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button id="btn-theme" class="btn-sort" onclick="toggleTheme()" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î"
          style="font-size:0.75rem;padding:3px 10px;margin-bottom:4px;">‚òÄÔ∏è Light</button>
        <button class="btn-sort" onclick="captureImage()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"
          style="font-size:0.75rem;padding:3px 10px;margin-bottom:12px;">üì∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>

        <div class="sidebar-label">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
        <button class="btn-sort" onclick="window.location.href='invalid_analysis.html'"
          style="width:100%;background:var(--red);color:white;border:none;margin-bottom:6px;">
          ‚úó ‡∏î‡∏π‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢ (Invalid)
        </button>
        <button class="btn-sort" onclick="window.location.href='blank_analysis.html'"
          style="width:100%;background:var(--teal);color:white;border:none;margin-bottom:6px;">
          üî≤ ‡∏î‡∏π‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Blank)
        </button>
        <button class="btn-sort" onclick="window.location.href='surplus_analysis_v2.html'"
          style="width:100%;background:#8b5cf6;color:white;border:none;margin-bottom:6px;">
          üìä ‡∏î‡∏π‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£ (Surplus)
        </button>

        <!-- Compare Settings -->
        <div style="
          margin-top:8px; padding:10px; border:1.5px solid var(--amber);
          border-radius:8px; background:rgba(245,158,11,0.05); margin-bottom:14px;
        ">
          <div style="font-size:0.68rem;font-weight:700;color:var(--amber);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">
            üë• ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö | Compare
          </div>

          <!-- Mode Toggle -->
          <div style="display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap;">
            <button id="btn-mode-a" class="btn-sort btn-method active" onclick="switchCompareMode('cross')"
              style="flex:1;font-size:0.63rem;padding:4px 3px;line-height:1.3;text-align:center;min-width:0;">
              üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö<br>‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
            <button id="btn-mode-b" class="btn-sort btn-method" onclick="switchCompareMode('same')"
              style="flex:1;font-size:0.63rem;padding:4px 3px;line-height:1.3;text-align:center;min-width:0;">
              ‚öñ ‡πÄ‡∏Ç‡∏ï vs<br>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            </button>
            <button id="btn-mode-c" class="btn-sort btn-method" onclick="switchCompareMode('discrepancy')"
              style="flex:1;font-size:0.63rem;padding:4px 3px;line-height:1.3;text-align:center;min-width:0;">
              üìã ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå<br>vs ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£
            </button>
          </div>

          <!-- Mode A: two dropdowns -->
          <div id="mode-a-controls">
            <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:6px;">
              <div class="archive-label" style="font-size:0.75rem;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ê‡∏≤‡∏ô (Base / Left)</div>
              <select id="archive-select-left" class="archive-select" style="width:100%;font-size:0.75rem;">
                <option value="data/election66_data.js" selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2566</option>
                <option value="data/election69_ocr.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (OCR)</option>
                <option value="data/election69_94pct.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (94%)</option>
              </select>
            </div>
            <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
              <div class="archive-label" style="font-size:0.75rem;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (Right)</div>
              <select id="archive-select-right" class="archive-select" style="width:100%;font-size:0.75rem;">
                <option value="data/election66_data.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2566</option>
                <option value="data/election69_ocr.js" selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (OCR)</option>
                <option value="data/election69_94pct.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (94%)</option>
              </select>
            </div>
            <button id="btn-load-comparison" class="btn-sort" style="
              width:100%;background:var(--amber);color:white;border:none;
              font-weight:bold;font-size:0.8rem;padding:6px 0;border-radius:5px;
            ">‚úî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (confirm)</button>
          </div>

          <!-- Mode B: single dropdown -->
          <div id="mode-b-controls" style="display:none;">
            <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
              <div class="archive-label" style="font-size:0.75rem;">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Dataset</div>
              <select id="archive-select-single" class="archive-select" style="width:100%;font-size:0.75rem;">
                <option value="data/election66_data.js" selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2566</option>
                <option value="data/election69_ocr.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (OCR)</option>
                <option value="data/election69_94pct.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (94%)</option>
              </select>
            </div>
            <button id="btn-load-single" class="btn-sort" style="
              width:100%;background:var(--amber);color:white;border:none;
              font-weight:bold;font-size:0.8rem;padding:6px 0;border-radius:5px;
            ">‚úî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (confirm)</button>
          </div>

          <!-- Mode C: turn_out vs v+i+b -->
          <div id="mode-c-controls" style="display:none;">
            <div style="font-size:0.65rem;color:var(--muted);margin-bottom:6px;line-height:1.6;font-family:'DM Mono',monospace;background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.2);border-radius:4px;padding:5px 7px;">
              ‡πÅ‡∏ö‡∏ö ‡∏™.‡∏™. 6/1<br>
              <span style="color:var(--text);">1.2</span> ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå<br>
              <span style="color:var(--text);">4.1+4.2+4.3</span> ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£
            </div>
            <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
              <div class="archive-label" style="font-size:0.75rem;">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Dataset</div>
              <select id="archive-select-single-c" class="archive-select" style="width:100%;font-size:0.75rem;">
                <option value="data/election66_data.js" selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2566</option>
                <option value="data/election69_ocr.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (OCR)</option>
                <option value="data/election69_94pct.js">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 (94%)</option>
              </select>
            </div>
            <button id="btn-load-single-c" class="btn-sort" style="
              width:100%;background:var(--amber);color:white;border:none;
              font-weight:bold;font-size:0.8rem;padding:6px 0;border-radius:5px;
            ">‚úî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (confirm)</button>
          </div>
        </div>

        <!-- Metric Toggle (hidden for Mode C) -->
        <div id="metric-toggle-section">
          <div class="sidebar-label">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î | total method</div>
          <button id="btn-method-turnout" class="btn-sort btn-method" onclick="switchMethod('turnout')"
            style="width:100%;font-size:0.72rem;padding:3px 10px;margin-bottom:2px;">‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ¬∑ ‡∏ä‡πà‡∏≠‡∏á 1.2</button>
          <button id="btn-method-sum" class="btn-sort btn-method active" onclick="switchMethod('sum')"
            style="width:100%;font-size:0.72rem;padding:3px 10px;margin-bottom:12px;">‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£ ¬∑ 4.1+4.2+4.3</button>
        </div>

        <!-- X-axis scale toggle -->
        <div class="sidebar-label">‡∏™‡πÄ‡∏Å‡∏•‡πÅ‡∏Å‡∏ô X | x scale</div>
        <div style="display:flex;gap:4px;margin-bottom:8px;">
          <button id="btn-scale-linear" class="btn-sort active" onclick="setScaleMode('linear')"
            style="flex:1;font-size:0.65rem;padding:3px 4px;">Linear</button>
          <button id="btn-scale-log" class="btn-sort" onclick="setScaleMode('log')"
            style="flex:1;font-size:0.65rem;padding:3px 4px;">Log (symlog)</button>
        </div>

        <!-- X-axis range slider -->
        <div class="sidebar-label">‡∏ä‡πà‡∏ß‡∏á X ‡πÅ‡∏Å‡∏ô | x range</div>
        <div style="display:flex;gap:4px;margin-bottom:4px;">
          <button id="btn-range-auto" class="btn-sort active" onclick="setRangeMode('auto')"
            style="flex:1;font-size:0.65rem;padding:3px 4px;">Auto</button>
          <button id="btn-range-manual" class="btn-sort" onclick="setRangeMode('manual')"
            style="flex:1;font-size:0.65rem;padding:3px 4px;">Manual</button>
        </div>
        <input type="range" id="x-range-slider" min="500" max="200000" step="500" value="10000"
          style="width:100%;accent-color:var(--amber);cursor:pointer;margin-bottom:2px;"
          oninput="onRangeSlider(this.value)" disabled>
        <div style="font-size:0.65rem;font-family:'DM Mono',monospace;color:var(--muted);text-align:center;margin-bottom:12px;" id="x-range-label">auto</div>

        <!-- Dataset Toggle (Mode A + C only) -->
        <div id="dataset-toggle-section">
          <div class="sidebar-label">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | dataset</div>
          <button class="btn-sort btn-dataset active" onclick="switchDataset('constituency')"
            style="font-size:0.75rem;padding:3px 10px;margin-bottom:2px;">‡∏™.‡∏™. (‡πÄ‡∏Ç‡∏ï)</button>
          <button class="btn-sort btn-dataset" onclick="switchDataset('partylist')"
            style="font-size:0.75rem;padding:3px 10px;margin-bottom:12px;">‡∏ö‡∏™. (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠)</button>
        </div>

        <!-- Filter -->
        <div class="sidebar-label">‡∏Å‡∏£‡∏≠‡∏á | filter by</div>
        <select id="filter-select" class="archive-select" style="width:100%;font-size:0.72rem;margin-bottom:4px;" onchange="setFilter(this.value)">
          <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="increased">‚Üë ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô</option>
          <option value="decreased">‚Üì ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏î‡∏•‡∏á</option>
          <option value="discrepancy">‚ö† ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô (turn_out ‚â† sum)</option>
        </select>
        <div style="font-size:0.65rem;font-family:'DM Mono',monospace;color:var(--muted);margin-bottom:8px;">
          ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="cnt-all">‚Äî</span> ¬∑ ‚Üë<span id="cnt-increased">‚Äî</span> ¬∑ ‚Üì<span id="cnt-decreased">‚Äî</span> ¬∑ ‚ö†<span id="cnt-discrepancy">‚Äî</span>
        </div>

        <div class="sidebar-divider"></div>

        <!-- Grouping -->
        <div class="sidebar-label">‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° | group by</div>
        <select id="grp-select" class="archive-select" style="width:100%;font-size:0.72rem;margin-bottom:8px;" onchange="setGrouping(this.value)">
          <option value="none">‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°</option>
          <option value="region">‡∏†‡∏≤‡∏Ñ</option>
          <option value="party_l">‡∏û‡∏£‡∏£‡∏Ñ (L)</option>
          <option value="party_r">‡∏û‡∏£‡∏£‡∏Ñ (R)</option>
        </select>

        <!-- Sort -->
        <div class="sidebar-label">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÇ‡∏î‡∏¢ | sort by</div>
        <div style="display:flex;gap:4px;margin-bottom:8px;">
          <select id="sort-select" class="archive-select" style="flex:1;font-size:0.72rem;" onchange="resort(this.value)">
            <option value="total_change" selected>Œî ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</option>
            <option value="pct_change">Œî% ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</option>
            <option value="total_r">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (R)</option>
            <option value="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
            <option value="party_2566">‡∏û‡∏£‡∏£‡∏Ñ‡∏ä‡∏ô‡∏∞ (L)</option>
            <option value="party_2569">‡∏û‡∏£‡∏£‡∏Ñ‡∏ä‡∏ô‡∏∞ (R)</option>
          </select>
          <button id="sort-dir-btn" class="btn-sort" onclick="toggleSortDir()" title="‡∏™‡∏•‡∏±‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á" style="padding:3px 8px;font-size:0.75rem;min-width:28px;">‚ñº</button>
        </div>

        <div class="sidebar-spacer" style="flex-grow:1;min-height:50px;"></div>
        <div style="font-size:0.75rem;line-height:1.4;color:var(--muted);padding-top:15px;border-top:1px solid var(--border);margin-top:auto;">
          <p style="color:var(--red)"><strong>‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Disclaimers):</strong></p>
          <p><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2566</strong> ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Å‡∏Å‡∏ï.</p>
          <p><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2569</strong> OCR ‡πÇ‡∏î‡∏¢ Chanon Ngernthongdee</p><br>
          <p>‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p><br>
          <p>Data visualization by</p>
          <p>¬© 2026 Ronnakrit Rattanasriampaipong</p>
          <div id="data-timestamps" style="margin-top:8px;font-size:0.7rem;line-height:1.6;color:var(--muted);border-top:1px dashed var(--border);padding-top:6px;">
            <p style="font-weight:600;margin-bottom:2px;">üïê ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</p>
            <div id="ts-a-section">
              <p id="ts-left">Base: ‚Äî</p>
              <p id="ts-right">Compare: ‚Äî</p>
            </div>
            <div id="ts-b-section" style="display:none;">
              <p id="ts-single">Dataset: ‚Äî</p>
            </div>
          </div>
        </div>
      </div>

      <!-- CHART AREA -->
      <div id="chart-area" style="display:none;">
        <svg id="svg-left"></svg>
        <svg id="svg-mid"></svg>
        <svg id="svg-right"></svg>
      </div>

      <!-- PROMPT OVERLAY -->
      <div id="prompt-overlay" style="display:flex;flex:1;align-items:center;justify-content:center;flex-direction:column;margin-left:250px;margin-right:190px;text-align:center;gap:8px;">
        <div style="font-size:2rem;">üë•</div>
        <h2 style="color:var(--text);font-weight:600;">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h2>
        <h3 style="color:var(--text);font-weight:600;">Total Votes Analysis</h3>
        <p style="color:var(--muted);font-size:0.9rem;max-width:440px;">
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ã‡πâ‡∏≤‡∏¢<br>
          A: ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ¬∑ B: ‡πÄ‡∏Ç‡∏ï vs ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ¬∑ C: ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå vs ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£ (‡πÅ‡∏ö‡∏ö ‡∏™.‡∏™. 6/1)<br>
          ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å <b>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</b>
        </p>
        <p style="color:var(--muted);font-size:0.75rem;margin-top:4px;">
          Select a comparison mode from the left sidebar, choose datasets, and click <b>confirm</b>.
        </p>
      </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div id="right-sidebar">
      <div class="sidebar-label" style="margin-top:20px;" id="party-legend-title">‡∏û‡∏£‡∏£‡∏Ñ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ (R)</div>
      <div id="party-legend"></div>
      <div class="sidebar-divider"></div>
      <div class="sidebar-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-top:6px;display:flex;flex-direction:column;gap:6px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="width:14px;height:8px;border-radius:2px;background:#14b8a6;opacity:0.75;flex-shrink:0;"></div>
          <span>‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: R &gt; L</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="width:14px;height:8px;border-radius:2px;background:#ef4444;opacity:0.75;flex-shrink:0;"></div>
          <span>‡πÅ‡∏ó‡πà‡∏á‡πÅ‡∏î‡∏á: L &gt; R</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="width:14px;height:8px;border-radius:2px;background:rgba(255,255,255,0.35);border:1px solid var(--border);flex-shrink:0;"></div>
          <span>‡πÅ‡∏ñ‡∏ö‡∏ö‡∏ô (‡∏Ç‡∏≤‡∏ß): ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° L</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="width:14px;height:8px;border-radius:2px;background:#f59e0b;opacity:0.65;flex-shrink:0;"></div>
          <span>‡πÅ‡∏ñ‡∏ö‡∏•‡πà‡∏≤‡∏á (‡∏™‡πâ‡∏°): ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° R</span>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="font-size:0.85rem;">‚ö†</span>
          <span style="color:#f59e0b;">‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô: ‡∏ä‡πà‡∏≠‡∏á 1.2 ‚â† 4.1+4.2+4.3</span>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:6px;display:flex;flex-direction:column;gap:4px;">
          <div style="display:flex;align-items:center;gap:6px;">
            <div style="width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0;"></div>
            <span>‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á: ‡∏û‡∏£‡∏£‡∏Ñ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2 (R)</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="color:#14b8a6;">‚ñ≤</span><span>‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô R &gt; L</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="color:#ef4444;">‚ñº</span><span>‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô R &lt; L</span>
          </div>
        </div>
      </div>
    </div>

    <div id="tooltip"></div>
  </div><!-- end capture-container -->

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DATA NORMALIZATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function normalizeRecord(d) {
      const num = (v) => Number(v) || 0;
      const n = (plain, suffixed) => num(d[plain] ?? d[suffixed]);
      const str = (v) => (v && v !== 'Unknown') ? String(v) : "Unknown";
      const s = (plain, suffixed) => str(d[plain] ?? d[suffixed]);
      return {
        province_thai:   str(d.province_thai),
        province_eng:    str(d.province_eng),
        cons_no:         num(d.cons_no),
        region:          str(d.region),
        turn_out:        n('turn_out',        'turn_out_2569'),
        winner_party:    s('winner_party',     'winner_party_2569'),
        valid:           n('valid',            'valid_2569'),
        invalid:         n('invalid',          'invalid_2569'),
        blank:           n('blank',            'blank_2569'),
        winner_votes:    n('winner_votes',     'winner_votes_2569'),
        runnerup_party:  s('runnerup_party',   'runnerup_party_2569'),
        runnerup_votes:  n('runnerup_votes',   'runnerup_votes_2569'),
        margin:          n('margin',           'margin_2569'),
        ballot_surplus:  num(d.ballot_surplus),
      };
    }

    // ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let DATA_LEFT   = { raw: [], pl: [] };
    let DATA_RIGHT  = { raw: [], pl: [] };
    let DATA_SINGLE = { raw: [], pl: [] };
    let fullProcessedData = [];
    let data = [];
    let activeFilter    = 'all';
    let currentSort     = 'total_change';
    let currentSortDir  = 'desc';
    let currentGrouping = 'none';
    let currentDataset  = 'constituency';
    let compareMode     = 'cross';   // 'cross' | 'same' | 'discrepancy'
    let currentMethod   = 'sum';     // 'turnout' | 'sum'
    let useLogScale     = false;
    let useManualRange  = false;
    let manualXMax      = 10000;
    let missingFromL = [], missingFromR = [];

    // ‚îÄ‚îÄ‚îÄ METRIC HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getTotalVotes(d, method) {
      return method === 'turnout'
        ? (d.turn_out || 0)
        : (d.valid || 0) + (d.invalid || 0) + (d.blank || 0);
    }

    // ‚îÄ‚îÄ‚îÄ SORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SORTS_BASE = {
      total_change: (a, b) => Math.abs(b.total_change) - Math.abs(a.total_change),
      pct_change:   (a, b) => Math.abs(b.total_pct_change) - Math.abs(a.total_pct_change),
      total_r:      (a, b) => b.total_R - a.total_R,
      province:     (a, b) => (a.province_eng || "").localeCompare(b.province_eng || "") || a.cons_no - b.cons_no,
      party_2566:   (a, b) => (a.winner_party || "").localeCompare(b.winner_party || "", 'th') || Math.abs(b.total_change) - Math.abs(a.total_change),
      party_2569:   (a, b) => (a.winner_party_2569 || "").localeCompare(b.winner_party_2569 || "", 'th') || Math.abs(b.total_change) - Math.abs(a.total_change),
    };
    function getSortFn() {
      const base = SORTS_BASE[currentSort] || SORTS_BASE.total_change;
      return currentSortDir === 'asc' ? (a, b) => base(b, a) : base;
    }

    // ‚îÄ‚îÄ‚îÄ PROCESS RAW DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function processRawData() {
      let leftRaw, rightRaw;
      if (compareMode === 'same') {
        leftRaw  = DATA_SINGLE.raw || [];
        rightRaw = DATA_SINGLE.pl  || [];
      } else if (compareMode === 'discrepancy') {
        // Mode C: compare turn_out vs v+i+b within same records
        const src = currentDataset === 'partylist' ? (DATA_SINGLE.pl || []) : (DATA_SINGLE.raw || []);
        leftRaw = src; rightRaw = src;
      } else {
        leftRaw  = currentDataset === 'partylist' ? DATA_LEFT.pl  : (DATA_LEFT.raw  || []);
        rightRaw = currentDataset === 'partylist' ? DATA_RIGHT.pl : (DATA_RIGHT.raw || []);
      }

      const mapRight = new Map();
      rightRaw.forEach(d => mapRight.set(`${d.province_thai}_${d.cons_no}`, d));
      const leftKeySet = new Set(leftRaw.map(d => `${d.province_thai}_${d.cons_no}`));

      // Mode C: no missing data (leftRaw === rightRaw)
      missingFromR = compareMode === 'discrepancy' ? [] : leftRaw.filter(d => !mapRight.has(`${d.province_thai}_${d.cons_no}`));
      missingFromL = compareMode === 'discrepancy' ? [] : rightRaw.filter(d => !leftKeySet.has(`${d.province_thai}_${d.cons_no}`));

      fullProcessedData = leftRaw
        .filter(dL => mapRight.has(`${dL.province_thai}_${dL.cons_no}`))
        .map(dL => {
          const dR    = mapRight.get(`${dL.province_thai}_${dL.cons_no}`);
          // Mode C: L = turn_out (‡∏ä‡πà‡∏≠‡∏á 1.2), R = valid+invalid+blank (4.1+4.2+4.3)
          const tot_L = compareMode === 'discrepancy' ? (dL.turn_out || 0) : getTotalVotes(dL, currentMethod);
          const tot_R = compareMode === 'discrepancy' ? ((dL.valid||0) + (dL.invalid||0) + (dL.blank||0)) : getTotalVotes(dR, currentMethod);
          const disc_L = (dL.turn_out || 0) - ((dL.valid||0) + (dL.invalid||0) + (dL.blank||0));
          const disc_R = (dR.turn_out || 0) - ((dR.valid||0) + (dR.invalid||0) + (dR.blank||0));
          return {
            ...dL,
            total_L:          tot_L,
            total_R:          tot_R,
            total_change:     tot_R - tot_L,
            total_pct_change: tot_L > 0 ? ((tot_R - tot_L) / tot_L * 100) : 0,
            discrepancy_L:    disc_L,
            discrepancy_R:    disc_R,
            turnout_L:        dL.turn_out || 0,
            turnout_R:        dR.turn_out || 0,
            sum_L:            (dL.valid||0) + (dL.invalid||0) + (dL.blank||0),
            sum_R:            (dR.valid||0) + (dR.invalid||0) + (dR.blank||0),
            winner_party_2569:   dR.winner_party,
            winner_votes_2569:   dR.winner_votes   || 0,
            runnerup_party_2569: dR.runnerup_party,
            runnerup_votes_2569: dR.runnerup_votes || 0,
            margin_2569:         dR.margin         || 0,
          };
        });
      data = [...fullProcessedData];
      if (data.length > 0) data.sort(getSortFn());
    }

    // ‚îÄ‚îÄ‚îÄ PARTY COLORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PARTY_COLOR = {
      '‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢': '#312682', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô': '#FF6413', '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢': '#E30613',
      '‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏£‡∏£‡∏°': '#4EC86F', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå': '#15A5F5', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥': '#BA810D',
      '‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ó‡∏¢': '#6841D0', '‡∏û‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏£‡∏±‡∏ê': '#006536', '‡πÑ‡∏ó‡∏£‡∏ß‡∏°‡∏û‡∏•‡∏±‡∏á': '#5266AD',
      '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏£‡∏ß‡∏°‡∏û‡∏•‡∏±‡∏á': '#5266AD', '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà': '#c61a12', '‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥': '#2b2c80',
      '‡∏Å‡πâ‡∏≤‡∏ß‡πÑ‡∏Å‡∏•': '#f97316', '‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏ó‡∏¢‡∏û‡∏±‡∏í‡∏ô‡∏≤': '#e40283', '‡∏ä‡∏≤‡∏ï‡∏¥‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏•‡πâ‡∏≤': '#fea12c'
    };
    function pc(name) { return PARTY_COLOR[name] || '#94a3b8'; }

    function runnerUpParty(d) {
      if (d.runnerup_party_2569 && d.runnerup_party_2569 !== "Unknown") return d.runnerup_party_2569;
      return d.winner_party_2569 || d.winner_party || "Unknown";
    }

    // ‚îÄ‚îÄ‚îÄ LAYOUT CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ROW_H  = 18;
    const TOP_PAD = 65;
    const LBL_W  = 208;
    const SLOPE_W = 340;
    const DELTA_W = 70;
    const MID_W  = 52;
    const BAR_W  = 190;
    const BAR_GAP = 20;
    const R = 3.2;
    let X_MAX = 10000;

    function symlog(v) {
      return v === 0 ? 0 : Math.sign(v) * Math.log(Math.abs(v) + 1);
    }
    function getLogTicks(xMax) {
      // Return a sparse set of ticks with at least MIN_PX pixels between each label.
      // In symlog space, high-value ticks cluster near the edge, so a pixel-gap
      // filter keeps the axis readable (typically ~3 ticks per side).
      const candidates = [50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000, 200000, 500000];
      const valid = candidates.filter(v => v <= xMax);
      if (valid.length === 0) return [];
      const logMax = symlog(xMax);
      const halfW  = SLOPE_W / 2;
      const MIN_PX = 40;
      const result = [];
      let lastPx = 0;
      for (const v of valid) {
        const px = (symlog(v) / logMax) * halfW;
        if (px - lastPx >= MIN_PX) { result.push(v); lastPx = px; }
      }
      return result;
    }
    function xDiff(diff) {
      const x0 = LBL_W + SLOPE_W / 2;
      if (useLogScale) {
        const logMax = symlog(X_MAX);
        return logMax > 0 ? x0 + (symlog(diff) / logMax) * (SLOPE_W / 2) : x0;
      }
      return x0 + (diff / X_MAX) * (SLOPE_W / 2);
    }

    // ‚îÄ‚îÄ‚îÄ MODE SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function switchCompareMode(mode) {
      compareMode = mode;
      document.getElementById('btn-mode-a').classList.toggle('active', mode === 'cross');
      document.getElementById('btn-mode-b').classList.toggle('active', mode === 'same');
      document.getElementById('btn-mode-c').classList.toggle('active', mode === 'discrepancy');
      document.getElementById('mode-a-controls').style.display = mode === 'cross'       ? '' : 'none';
      document.getElementById('mode-b-controls').style.display = mode === 'same'        ? '' : 'none';
      document.getElementById('mode-c-controls').style.display = mode === 'discrepancy' ? '' : 'none';
      // Dataset toggle: shown for cross and discrepancy, hidden for same (CONS vs PL is already fixed)
      document.getElementById('dataset-toggle-section').style.display = (mode === 'cross' || mode === 'discrepancy') ? '' : 'none';
      // Metric toggle: hidden for discrepancy (mode C IS the comparison between the two metrics)
      document.getElementById('metric-toggle-section').style.display = mode !== 'discrepancy' ? '' : 'none';
      // Vote bar: hide for discrepancy (both bars would be identical)
      const vbWrap = document.getElementById('vote-bar-wrap');
      if (vbWrap) vbWrap.style.display = mode === 'discrepancy' ? 'none' : '';
      document.getElementById('ts-a-section').style.display = mode === 'cross'                           ? '' : 'none';
      document.getElementById('ts-b-section').style.display = (mode === 'same' || mode === 'discrepancy') ? '' : 'none';
      fullProcessedData = []; data = [];
      document.getElementById('prompt-overlay').style.display = 'flex';
      document.getElementById('chart-area').style.display = 'none';
      updateFilterLabels();
      updateHeaderStatLabels();
      updateHeaderTitle();
    }

    function updateFilterLabels() {
      const isModeC = compareMode === 'discrepancy';
      const sel = document.getElementById('filter-select');
      if (!sel) return;
      sel.options[1].text = isModeC ? '‚Üë ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£ > ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå' : '‚Üë ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô';
      sel.options[2].text = isModeC ? '‚Üì ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå > ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£' : '‚Üì ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏î‡∏•‡∏á';
      sel.options[3].text = isModeC ? '‚â† ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô (non-zero)' : '‚ö† ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô (turn_out ‚â† sum)';
    }

    function updateHeaderStatLabels() {
      const isModeC = compareMode === 'discrepancy';
      const el = id => document.getElementById(id);
      if (el('hs-increased-l'))     el('hs-increased-l').textContent  = isModeC ? '‚Üë ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£ > ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå' : '‚Üë ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô';
      if (el('hs-decreased-l'))     el('hs-decreased-l').textContent  = isModeC ? '‚Üì ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå > ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£' : '‚Üì ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏î‡∏•‡∏á';
      if (el('hs-discrepancy-l'))   el('hs-discrepancy-l').textContent = isModeC ? '‚â† ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : '‚ö† ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô (R)';
      if (el('hs-discrepancy-note')) el('hs-discrepancy-note').textContent = isModeC ? '|sum ‚àí turn_out|' : 'turn_out ‚â† v+i+b';
    }

    function switchMethod(method) {
      currentMethod = method;
      document.getElementById('btn-method-turnout').classList.toggle('active', method === 'turnout');
      document.getElementById('btn-method-sum').classList.toggle('active', method === 'sum');
      if (fullProcessedData.length > 0) renderAll();
    }

    // ‚îÄ‚îÄ‚îÄ DATASETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function switchDataset(dataset) {
      currentDataset = dataset;
      document.querySelectorAll('.btn-dataset').forEach(b => {
        b.classList.remove('active');
        if (b.getAttribute('onclick')?.includes(`'${dataset}'`)) b.classList.add('active');
      });
      activeFilter = 'all';
      currentSort  = 'total_change';
      const filterSel = document.getElementById('filter-select');
      if (filterSel) filterSel.value = 'all';
      const sortSel = document.getElementById('sort-select');
      if (sortSel) sortSel.value = 'total_change';
      currentSortDir = 'desc';
      const sortDirBtn = document.getElementById('sort-dir-btn');
      if (sortDirBtn) sortDirBtn.textContent = '‚ñº';
      renderAll();
    }

    // ‚îÄ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function T(dark, light) { return document.documentElement.dataset.theme === 'light' ? light : dark; }
    function toggleTheme() {
      const root = document.documentElement;
      const going_light = root.dataset.theme !== 'light';
      root.dataset.theme = going_light ? 'light' : '';
      document.getElementById('btn-theme').textContent = going_light ? '‚òÄÔ∏è Light' : 'üåô Dark';
      buildChart();
    }

    // ‚îÄ‚îÄ‚îÄ FILTER / SORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function applyFilter() {
      if (activeFilter === 'increased')   return fullProcessedData.filter(d => d.total_change > 0);
      if (activeFilter === 'decreased')   return fullProcessedData.filter(d => d.total_change < 0);
      if (activeFilter === 'discrepancy') return fullProcessedData.filter(d => Math.abs(d.discrepancy_R || 0) > 0);
      return [...fullProcessedData];
    }

    function setFilter(key) {
      activeFilter = key;
      const sel = document.getElementById('filter-select');
      if (sel) sel.value = key;
      processRawData();
      data = applyFilter();
      data.sort(getSortFn());
      buildChart();
    }

    function updateCounts() {
      const nInc  = fullProcessedData.filter(d => d.total_change > 0).length;
      const nDec  = fullProcessedData.filter(d => d.total_change < 0).length;
      const nDisc = fullProcessedData.filter(d => Math.abs(d.discrepancy_R || 0) > 0).length;
      const total = fullProcessedData.length;
      document.getElementById('cnt-all').textContent         = '(' + total + ')';
      document.getElementById('cnt-increased').textContent   = '(' + nInc + ')';
      document.getElementById('cnt-decreased').textContent   = '(' + nDec + ')';
      document.getElementById('cnt-discrepancy').textContent = '(' + nDisc + ')';
    }

    function updateMissingWarning() {
      const el = document.getElementById('missing-data-warning');
      if (!el) return;
      const nL = missingFromL.length, nR = missingFromR.length;
      if (nL === 0 && nR === 0) { el.style.display = 'none'; return; }
      const isModeSame = compareMode === 'same' || compareMode === 'discrepancy';
      const lName = isModeSame ? '‡πÄ‡∏Ç‡∏ï' : (() => {
        const s = document.getElementById('archive-select-left');
        return s ? s.options[s.selectedIndex].text.split(' (')[0] : 'L';
      })();
      const rName = isModeSame ? '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠' : (() => {
        const s = document.getElementById('archive-select-right');
        return s ? s.options[s.selectedIndex].text.split(' (')[0] : 'R';
      })();
      const parts = [];
      if (nR > 0) parts.push(`${nR} ‡πÄ‡∏Ç‡∏ï‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô ${rName}`);
      if (nL > 0) parts.push(`${nL} ‡πÄ‡∏Ç‡∏ï‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô ${lName}`);
      el.textContent = `‚ö† ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: ${parts.join(' ¬∑ ')} ¬∑ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${fullProcessedData.length} ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ä‡∏∏‡∏î`;
      el.style.display = 'block';
    }

    function resort(key) {
      currentSort = key;
      currentSortDir = (key === 'province' || key === 'party_2566' || key === 'party_2569') ? 'asc' : 'desc';
      document.getElementById('sort-dir-btn').textContent = currentSortDir === 'asc' ? '‚ñ≤' : '‚ñº';
      processRawData();
      data = applyFilter();
      data.sort(getSortFn());
      buildChart();
    }

    function toggleSortDir() {
      currentSortDir = currentSortDir === 'desc' ? 'asc' : 'desc';
      document.getElementById('sort-dir-btn').textContent = currentSortDir === 'asc' ? '‚ñ≤' : '‚ñº';
      data.sort(getSortFn());
      buildChart();
    }

    function setGrouping(g) {
      currentGrouping = g;
      const sel = document.getElementById('grp-select');
      if (sel) sel.value = g;
      buildChart();
    }

    // ‚îÄ‚îÄ‚îÄ SVG HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function svgEl(tag, attrs) {
      const e = document.createElementNS('http://www.w3.org/2000/svg', tag);
      for (const [k, v] of Object.entries(attrs)) e.setAttribute(k, v);
      return e;
    }
    function svgText(parent, x, y, txt, attrs) {
      const e = svgEl('text', { x, y, ...attrs });
      e.textContent = txt;
      parent.appendChild(e);
      return e;
    }

    // ‚îÄ‚îÄ‚îÄ BUILD CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildChart() {
      // Build rows (with optional grouping)
      let rows;
      if (currentGrouping === 'none') {
        rows = data.map(d => ({ type: 'data', d }));
      } else {
        const groups = {};
        data.forEach(d => {
          const key = currentGrouping === 'region'  ? (d.region || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') :
                      currentGrouping === 'party_l' ? (d.winner_party || 'Unknown') :
                      (d.winner_party_2569 || 'Unknown');
          if (!groups[key]) groups[key] = [];
          groups[key].push(d);
        });
        rows = [];
        Object.keys(groups).sort((a, b) => a.localeCompare(b, 'th')).forEach(k => {
          rows.push({ type: 'header', name: k, count: groups[k].length });
          groups[k].forEach(d => rows.push({ type: 'data', d }));
        });
      }

      const n = rows.length;
      const H = TOP_PAD + (n * ROW_H) + 10;
      const svgL = document.getElementById('svg-left');
      const svgM = document.getElementById('svg-mid');
      const svgR = document.getElementById('svg-right');
      svgL.innerHTML = '';
      svgM.innerHTML = '';
      svgR.innerHTML = '';

      if (n === 0) return;

      // Dynamic X scale (auto or manual)
      const allDiffs = data.map(d => Math.abs(d.total_change || 0));
      const maxAbsDiff = allDiffs.length ? Math.max(...allDiffs) : 10000;
      let tickStep;
      if (useManualRange) {
        X_MAX = manualXMax;
        if      (X_MAX <= 2000)   tickStep = 500;
        else if (X_MAX <= 5000)   tickStep = 1000;
        else if (X_MAX <= 10000)  tickStep = 2000;
        else if (X_MAX <= 20000)  tickStep = 5000;
        else if (X_MAX <= 50000)  tickStep = 10000;
        else if (X_MAX <= 100000) tickStep = 20000;
        else                       tickStep = 50000;
      } else {
        if      (maxAbsDiff <= 2000)   tickStep = 500;
        else if (maxAbsDiff <= 5000)   tickStep = 1000;
        else if (maxAbsDiff <= 10000)  tickStep = 2000;
        else if (maxAbsDiff <= 20000)  tickStep = 5000;
        else if (maxAbsDiff <= 50000)  tickStep = 10000;
        else if (maxAbsDiff <= 100000) tickStep = 20000;
        else                            tickStep = 50000;
        X_MAX = Math.max(tickStep, Math.ceil(maxAbsDiff / tickStep) * tickStep);
        // Sync slider to auto-computed value
        const sl = document.getElementById('x-range-slider');
        if (sl) sl.value = Math.min(X_MAX, parseInt(sl.max));
      }

      const x0 = LBL_W + SLOPE_W / 2;
      const svgLW = LBL_W + SLOPE_W + DELTA_W;
      const svgMW = MID_W;
      const svgRW = BAR_GAP + BAR_W + 50;

      svgL.setAttribute('width', svgLW); svgL.setAttribute('height', H);
      svgM.setAttribute('width', svgMW); svgM.setAttribute('height', H);
      svgR.setAttribute('width', svgRW); svgR.setAttribute('height', H);

      // X-axis baseline
      svgL.appendChild(svgEl('line', { x1: LBL_W, y1: TOP_PAD-2, x2: LBL_W+SLOPE_W, y2: TOP_PAD-2, stroke: T('#1e3a5f','#cbd5e1'), 'stroke-width': 1 }));

      // Center zero line (full height)
      svgL.appendChild(svgEl('line', { x1: x0, y1: 0, x2: x0, y2: H, stroke: T('#2563eb','#6366f1'), 'stroke-width': 1 }));

      // Tick marks and grid lines
      const tickVals = useLogScale
        ? [0, ...getLogTicks(X_MAX).flatMap(v => [-v, v])]
        : (() => { const vs = []; for (let v = -X_MAX; v <= X_MAX; v += tickStep) vs.push(v); return vs; })();
      tickVals.forEach(v => {
        const x = xDiff(v);
        if (v !== 0) {
          svgL.appendChild(svgEl('line', { x1: x, y1: TOP_PAD-2, x2: x, y2: H, stroke: T('#0f1e2f','#e2e8f0'), 'stroke-width': 0.5, 'stroke-dasharray': '2,4' }));
        }
        let lbl;
        if (v === 0) lbl = '0';
        else if (Math.abs(v) >= 1000) lbl = (v > 0 ? '+' : '') + (v / 1000).toFixed(0) + 'k';
        else lbl = (v > 0 ? '+' : '') + v.toLocaleString();
        svgText(svgL, x, TOP_PAD-8, lbl, { 'text-anchor':'middle','font-size':'11','font-family':'DM Mono, monospace', fill: T('#94a3b8','#334155') });
      });

      // Dataset labels above bar area
      const isModeC    = compareMode === 'discrepancy';
      const isModeSame = compareMode === 'same';
      const isSingleDataset = isModeSame || isModeC;
      let leftLblShort, rightLblShort;
      if (isModeC) {
        leftLblShort  = '‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (1.2)';
        rightLblShort = '‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£ (4.1+4.2+4.3)';
      } else if (isModeSame) {
        const ss = document.getElementById('archive-select-single');
        const sn = ss ? ss.options[ss.selectedIndex].text.replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','').split(' (')[0] : '';
        leftLblShort  = `‡πÄ‡∏Ç‡∏ï (${sn})`;
        rightLblShort = `‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (${sn})`;
      } else {
        const lSel = document.getElementById('archive-select-left');
        const rSel = document.getElementById('archive-select-right');
        const shorten = sel => {
          if (!sel) return '?';
          const t = sel.options[sel.selectedIndex].text;
          if (t.includes('(OCR)')) return '2569 (OCR)';
          if (t.includes('(94%)')) return '2569 (94%)';
          const m = t.match(/(\d{4})/);
          return m ? m[1] : t.split(' (')[0].trim().replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','');
        };
        leftLblShort  = shorten(lSel);
        rightLblShort = shorten(rSel);
      }

      const hintText = isModeC ? '‚Üê turn_out > sum  |  sum > turn_out ‚Üí' : '‚Üê ‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á  |  ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‚Üí';
      svgText(svgL, LBL_W+4,       22, '‚óÑ ' + leftLblShort,  { 'text-anchor':'start','font-size':'10.5','font-family':'Sarabun, sans-serif', fill: T('#ef4444','#dc2626') });
      svgText(svgL, LBL_W+SLOPE_W-4, 22, rightLblShort + ' ‚ñ∫', { 'text-anchor':'end', 'font-size':'10.5','font-family':'Sarabun, sans-serif', fill: T('#14b8a6','#0d9488') });
      svgText(svgL, x0, 22, hintText, { 'text-anchor':'middle','font-size':'9','font-family':'Sarabun, sans-serif', fill: T('#475569','#94a3b8') });
      svgText(svgL, LBL_W+SLOPE_W+8,  19, 'Œî ‡∏Ñ‡∏ô',  { 'font-size':'10','font-family':'DM Mono, monospace', fill: T('#94a3b8','#334155') });
      svgText(svgL, LBL_W+SLOPE_W+8,  31, 'Œî%',    { 'font-size':'10','font-family':'DM Mono, monospace', fill: T('#94a3b8','#334155') });

      svgText(svgM, MID_W/2, 19, '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2', { 'text-anchor':'middle','font-size':'9','font-family':'Sarabun, sans-serif', fill: T('#94a3b8','#334155') });
      svgText(svgM, MID_W/2, 31, '‚Üï‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', { 'text-anchor':'middle','font-size':'8','font-family':'Sarabun, sans-serif', fill: T('#94a3b8','#334155') });

      svgText(svgR, BAR_GAP, 19, '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° L', { 'font-size':'10','font-family':'Sarabun, sans-serif', fill: T('#94a3b8','#334155') });
      svgText(svgR, BAR_GAP, 31, '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° R', { 'font-size':'10','font-family':'Sarabun, sans-serif', fill: '#f59e0b' });

      // Down arrows
      const arrowStroke = T('#94a3b8','#334155');
      function drawDownArrow(parent, x, y1, y2, color) {
        parent.appendChild(svgEl('line', { x1: x, y1: y1, x2: x, y2: y2, stroke: color, 'stroke-width':'1.5' }));
        parent.appendChild(svgEl('path', { d: `M ${x-4} ${y2-5} L ${x} ${y2} L ${x+4} ${y2-5}`, fill:'none', stroke: color, 'stroke-width':'1.5' }));
      }
      drawDownArrow(svgM, MID_W/2,              40, 55, arrowStroke);
      drawDownArrow(svgR, BAR_GAP+BAR_W/2,      40, 55, arrowStroke);
      drawDownArrow(svgL, LBL_W+SLOPE_W+18,     40, 55, arrowStroke);
      drawDownArrow(svgL, LBL_W+SLOPE_W+52,     40, 55, arrowStroke);

      // Global max for absolute mini-bars
      const allTotals = data.flatMap(d => [d.total_L||0, d.total_R||0]);
      const globalMaxTotal = allTotals.length ? Math.max(...allTotals) : 1;

      // ‚îÄ‚îÄ ROWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      rows.forEach((row, i) => {
        const y0   = TOP_PAD + i * ROW_H;
        const yMid = y0 + ROW_H / 2;

        if (row.type === 'header') {
          const bgColor = T('rgba(30,58,95,0.55)','rgba(226,232,240,0.7)');
          [svgL, svgM, svgR].forEach(svg => {
            svg.appendChild(svgEl('rect', {
              x: 0, y: y0,
              width: svg===svgL ? svgLW : svg===svgM ? svgMW : svgRW,
              height: ROW_H, fill: bgColor
            }));
          });
          svgText(svgL, LBL_W-4, yMid+4, `${row.name}  (${row.count})`, {
            'font-size':'12','font-weight':'bold','font-family':'Sarabun, sans-serif', fill: T('#e2e8f0','#1e3a5f')
          });
          return;
        }

        const d    = row.d;
        const diff = d.total_change || 0;
        const pctChange = d.total_pct_change || 0;
        const sign = diff >= 0 ? '+' : '';
        const pctSign = pctChange >= 0 ? '+' : '';
        const barColor = diff > 0 ? '#14b8a6' : diff < 0 ? '#ef4444' : '#475569';

        // Row background
        const rowBg = [svgL, svgM, svgR].map(svg => {
          const r = svgEl('rect', {
            x: 0, y: y0,
            width: svg===svgL ? svgLW : svg===svgM ? svgMW : svgRW,
            height: ROW_H,
            fill: i%2===0 ? T('rgba(255,255,255,0.018)','rgba(0,0,0,0.028)') : 'transparent'
          });
          svg.appendChild(r);
          return r;
        });
        rowBg.forEach(r => {
          r.style.cursor = 'default';
          r.addEventListener('mousemove', e => showTip(e, d));
          r.addEventListener('mouseleave', hideTip);
        });

        // Province + cons_no labels
        svgText(svgL, LBL_W-28, yMid+3.5, d.province_thai, { 'text-anchor':'end','font-size':'14','font-family':'Sarabun, sans-serif', fill: T('#64748b','#64748b') });
        svgText(svgL, LBL_W-4,  yMid+3.5, d.cons_no,       { 'text-anchor':'end','font-size':'14','font-family':'DM Mono, monospace', fill: T('#94a3b8','#334155') });

        // Diverging bar (with overflow clipping)
        const chartLeft  = LBL_W;
        const chartRight = LBL_W + SLOPE_W;
        const rawBarXEnd  = xDiff(diff);
        const clampedXEnd = Math.max(chartLeft, Math.min(chartRight, rawBarXEnd));
        const isClipped   = clampedXEnd !== rawBarXEnd;
        const barLeft  = Math.min(x0, clampedXEnd);
        const barWidth = Math.abs(clampedXEnd - x0);
        const bh = ROW_H - 6;
        const by = y0 + 3;
        if (barWidth > 0.5) {
          svgL.appendChild(svgEl('rect', { x: barLeft, y: by, width: barWidth, height: bh, fill: barColor, opacity: 0.72, rx: 1 }));
          if (isClipped) {
            const arrowX   = diff > 0 ? chartRight - 3 : chartLeft + 3;
            const arrowAnchor = diff > 0 ? 'end' : 'start';
            svgText(svgL, arrowX, yMid + 3.5, diff > 0 ? '‚ñ∂' : '‚óÄ', { 'text-anchor': arrowAnchor, 'font-size': '8', fill: barColor });
          }
        } else {
          svgL.appendChild(svgEl('line', { x1: x0, y1: by, x2: x0, y2: by+bh, stroke: '#475569', 'stroke-width': 1 }));
        }

        // Discrepancy warning dot
        if (Math.abs(d.discrepancy_R || 0) > 0) {
          svgText(svgL, LBL_W+SLOPE_W-6, yMid+3.5, '‚ö†', { 'text-anchor':'end','font-size':'8', fill: '#f59e0b' });
        }

        // Œî labels
        const absK = Math.abs(diff);
        const diffLabel = absK >= 1000 ? sign + (diff/1000).toFixed(1)+'k' : sign + diff.toLocaleString();
        svgText(svgL, LBL_W+SLOPE_W+8, yMid+1,   diffLabel,                          { 'font-size':'9','font-family':'DM Mono, monospace', fill: barColor });
        svgText(svgL, LBL_W+SLOPE_W+8, yMid+11,  pctSign+pctChange.toFixed(1)+'%', { 'font-size':'8.5','font-family':'DM Mono, monospace', fill: barColor });

        // svgM: runner-up dot + margin change arrow
        const marginChange = (d.margin_2569||0) - (d.margin||0);
        const mColor = marginChange > 500 ? '#14b8a6' : marginChange < -500 ? '#ef4444' : '#475569';
        const mArrow = marginChange > 500 ? '‚ñ≤' : marginChange < -500 ? '‚ñº' : '‚Äî';
        const dotStroke = Math.abs(marginChange) > 1000 ? 1.5 : 0.5;

        svgM.appendChild(svgEl('circle', {
          cx: MID_W/2, cy: yMid-2, r: R+0.5,
          fill: pc(runnerUpParty(d)),
          stroke: T('rgba(255,255,255,0.3)','rgba(0,0,0,0.25)'), 'stroke-width': dotStroke
        }));
        if (!isSingleDataset) {
          svgText(svgM, MID_W/2, yMid+9, mArrow, { 'text-anchor':'middle','font-size':'8', fill: mColor });
        }

        // svgR: mini absolute bars (L top, R bottom)
        const lW = globalMaxTotal > 0 ? Math.max(1, (d.total_L/globalMaxTotal)*BAR_W) : 0;
        const rW = globalMaxTotal > 0 ? Math.max(1, (d.total_R/globalMaxTotal)*BAR_W) : 0;
        const halfH = Math.floor((ROW_H-4)/2) - 1;
        svgR.appendChild(svgEl('rect', { x: BAR_GAP, y: y0+2,         width: lW, height: halfH, fill: T('rgba(255,255,255,0.35)','rgba(0,0,0,0.2)'), rx: 1 }));
        svgR.appendChild(svgEl('rect', { x: BAR_GAP, y: y0+2+halfH+1, width: rW, height: halfH, fill: '#f59e0b', opacity: 0.65, rx: 1 }));
      });

      // ‚îÄ‚îÄ Header stats update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const increasedRows = data.filter(d => d.total_change > 0);
      const decreasedRows = data.filter(d => d.total_change < 0);
      const discRows      = data.filter(d => Math.abs(d.discrepancy_R||0) > 0);

      document.getElementById('hs-increased').textContent  = increasedRows.length;
      document.getElementById('hs-decreased').textContent  = decreasedRows.length;
      document.getElementById('hs-discrepancy').textContent = discRows.length;

      const sumOf = (rows, key) => rows.reduce((s, d) => s + (d[key]||0), 0);
      const fmt = n => n.toLocaleString() + ' ‡∏Ñ‡∏ô';

      document.getElementById('hs-increased-sum-l').textContent = fmt(sumOf(increasedRows,'total_L'));
      document.getElementById('hs-increased-sum-r').textContent = fmt(sumOf(increasedRows,'total_R'));
      document.getElementById('hs-decreased-sum-l').textContent = fmt(sumOf(decreasedRows,'total_L'));
      document.getElementById('hs-decreased-sum-r').textContent = fmt(sumOf(decreasedRows,'total_R'));

      const allInc = fullProcessedData.filter(d => d.total_change > 0).length;
      const allDec = fullProcessedData.filter(d => d.total_change < 0).length;
      const summaryEl = document.getElementById('hs-all-summary');
      if (summaryEl) summaryEl.textContent = `‚Üë${allInc} / ‚Üì${allDec}`;
      document.getElementById('hs-all-sum-l').textContent = fmt(sumOf(data,'total_L'));
      document.getElementById('hs-all-sum-r').textContent = fmt(sumOf(data,'total_R'));

      svgR.setAttribute('height', H);
      buildLegend(data);
    }

    // ‚îÄ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showTip(e, d) {
      const tip = document.getElementById('tooltip');
      if (!tip) return;
      const isModeC    = compareMode === 'discrepancy';
      const isModeSame = compareMode === 'same';

      let leftLabel, rightLabel;
      if (isModeSame) {
        const ss = document.getElementById('archive-select-single');
        const sn = ss ? ss.options[ss.selectedIndex].text.replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','').split(' (')[0] : '';
        leftLabel  = `‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ¬∑ ${sn}`;
        rightLabel = `‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ¬∑ ${sn}`;
      } else {
        const lSel = document.getElementById('archive-select-left');
        const rSel = document.getElementById('archive-select-right');
        leftLabel  = lSel ? lSel.options[lSel.selectedIndex].text.split(' | ')[0] : 'L';
        rightLabel = rSel ? rSel.options[rSel.selectedIndex].text.split(' | ')[0] : 'R';
      }

      const diff = d.total_change || 0;
      const pct  = d.total_pct_change || 0;
      const diffSign = diff >= 0 ? '+' : '';
      const pctSign  = pct  >= 0 ? '+' : '';
      const diffColor = diff > 0 ? '#14b8a6' : diff < 0 ? '#ef4444' : 'var(--muted)';

      const marginChange = (d.margin_2569||0) - (d.margin||0);
      const mChangeSign  = marginChange >= 0 ? '+' : '';
      const mColor = marginChange > 0 ? '#14b8a6' : marginChange < 0 ? '#ef4444' : 'var(--muted)';

      const discL = d.discrepancy_L || 0;
      const discR = d.discrepancy_R || 0;
      const discLHtml = Math.abs(discL) > 0 ? `<span style="color:#f59e0b;"> (‚ö† diff: ${discL>0?'+':''}${discL.toLocaleString()})</span>` : '';
      const discRHtml = Math.abs(discR) > 0 ? `<span style="color:#f59e0b;"> (‚ö† diff: ${discR>0?'+':''}${discR.toLocaleString()})</span>` : '';

      if (isModeC) {
        const ss = document.getElementById('archive-select-single-c');
        const dsName = ss ? ss.options[ss.selectedIndex].text.replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','').split(' (')[0] : '';
        const turnout = d.turnout_L || 0;
        const ballotSum = d.sum_L || 0;
        const valid   = d.valid   || 0;
        const invalid = d.invalid || 0;
        const blank   = d.blank   || 0;
        const discDiff = ballotSum - turnout; // = total_change
        const discColor = discDiff > 0 ? '#14b8a6' : discDiff < 0 ? '#ef4444' : 'var(--muted)';
        const discSign  = discDiff >= 0 ? '+' : '';
        tip.innerHTML = `
          <div style="font-weight:600;margin-bottom:2px;">${d.province_thai} ‡πÄ‡∏Ç‡∏ï ${d.cons_no}</div>
          <div style="font-size:11px;color:var(--muted);margin-bottom:6px;border-bottom:1px solid var(--border);padding-bottom:4px;">${d.province_eng} ¬∑ ${dsName}</div>
          <div style="font-size:11px;margin-bottom:4px;display:flex;align-items:center;gap:4px;">
            <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${pc(d.winner_party)};flex-shrink:0;"></span>
            <b>${d.winner_party}</b>
            <span style="font-family:'DM Mono';color:var(--muted);margin-left:auto;">${(d.winner_votes||0).toLocaleString()}</span>
          </div>
          <div style="font-size:10px;display:flex;justify-content:space-between;margin-bottom:8px;padding-bottom:6px;border-bottom:1px dashed var(--border);">
            <span style="color:var(--muted);">‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</span>
            <span style="font-family:'DM Mono';color:var(--teal);">${(d.margin||0).toLocaleString()}</span>
          </div>
          <div style="font-size:11px;font-weight:600;color:var(--muted);margin-bottom:5px;font-family:'DM Mono',monospace;">‡πÅ‡∏ö‡∏ö ‡∏™.‡∏™. 6/1</div>
          <div style="font-size:10px;display:flex;justify-content:space-between;margin-bottom:3px;">
            <span style="color:var(--muted);">‡∏ä‡πà‡∏≠‡∏á 1.2 ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå:</span>
            <span style="font-family:'DM Mono';">${turnout.toLocaleString()}</span>
          </div>
          <div style="font-size:10px;display:flex;justify-content:space-between;margin-bottom:2px;">
            <span style="color:var(--muted);">4.1+4.2+4.3 ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£:</span>
            <span style="font-family:'DM Mono';">${ballotSum.toLocaleString()}</span>
          </div>
          <div style="font-size:10px;color:var(--muted);padding-left:10px;line-height:1.7;margin-bottom:6px;border-bottom:1px solid var(--border);padding-bottom:5px;">
            <div style="display:flex;justify-content:space-between;">
              <span>4.1 ‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ (valid):</span>
              <span style="font-family:'DM Mono';color:var(--text);">${valid.toLocaleString()}</span>
            </div>
            <div style="display:flex;justify-content:space-between;">
              <span>4.2 ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢ (invalid):</span>
              <span style="font-family:'DM Mono';color:var(--text);">${invalid.toLocaleString()}</span>
            </div>
            <div style="display:flex;justify-content:space-between;">
              <span>4.3 ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (blank):</span>
              <span style="font-family:'DM Mono';color:var(--text);">${blank.toLocaleString()}</span>
            </div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="color:var(--muted);font-size:11px;">Œî (‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£ ‚àí ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå):</span>
            <span style="font-family:'DM Mono';color:${discColor};font-weight:bold;">${discSign}${discDiff.toLocaleString()}</span>
          </div>
        `;
        tip.style.display = 'block';
        let posX = e.clientX + 15, posY = e.clientY + 15;
        if (posX + 350 > window.innerWidth)  posX = e.clientX - 360;
        if (posY + 350 > window.innerHeight) posY = e.clientY - tip.offsetHeight - 20;
        tip.style.left = posX + 'px'; tip.style.top = posY + 'px';
        return;
      }

      tip.innerHTML = `
        <div style="font-weight:600;margin-bottom:4px;">${d.province_thai} ‡πÄ‡∏Ç‡∏ï ${d.cons_no}</div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px;border-bottom:1px solid var(--border);padding-bottom:6px;">${d.province_eng}</div>
        <div style="display:flex;gap:12px;margin-bottom:8px;">
          <div style="flex:1;border-right:1px dashed var(--border);padding-right:8px;">
            <div style="font-size:10px;color:var(--muted);margin-bottom:6px;font-weight:bold;">${leftLabel}</div>
            <div style="font-size:11px;margin-bottom:3px;display:flex;align-items:center;justify-content:space-between;">
              <div style="display:flex;align-items:center;gap:4px;overflow:hidden;">
                <span style="display:inline-block;min-width:8px;height:8px;border-radius:50%;background:${pc(d.winner_party)};flex-shrink:0;"></span>
                <b style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.winner_party}</b>
              </div>
              <span style="font-family:'DM Mono';color:var(--muted);flex-shrink:0;margin-left:4px;">${(d.winner_votes||0).toLocaleString()}</span>
            </div>
            <div style="font-size:11px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;">
              <div style="display:flex;align-items:center;gap:4px;overflow:hidden;">
                <span style="display:inline-block;min-width:8px;height:8px;border-radius:50%;background:${pc(d.runnerup_party||'Unknown')};flex-shrink:0;"></span>
                <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.runnerup_party||'Unknown'}</span>
              </div>
              <span style="font-family:'DM Mono';color:var(--muted);flex-shrink:0;margin-left:4px;">${(d.runnerup_votes||0).toLocaleString()}</span>
            </div>
            <div style="font-size:10px;display:flex;justify-content:space-between;margin-bottom:2px;">
              <span style="color:var(--muted);">‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á:</span>
              <span style="font-family:'DM Mono';color:var(--teal);">${(d.margin||0).toLocaleString()}</span>
            </div>
            <div style="border-top:1px dashed var(--border);margin:5px 0 4px;"></div>
            <div style="font-size:10px;display:flex;justify-content:space-between;margin-bottom:2px;">
              <span style="color:var(--muted);">‡∏ä‡πà‡∏≠‡∏á 1.2 ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå:</span>
              <span style="font-family:'DM Mono';">${(d.turnout_L||0).toLocaleString()}</span>
            </div>
            <div style="font-size:10px;display:flex;justify-content:space-between;">
              <span style="color:var(--muted);">4.1+4.2+4.3 ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£:</span>
              <span style="font-family:'DM Mono';">${(d.sum_L||0).toLocaleString()}${discLHtml}</span>
            </div>
          </div>
          <div style="flex:1;">
            <div style="font-size:10px;color:var(--muted);margin-bottom:6px;font-weight:bold;">${rightLabel}</div>
            <div style="font-size:11px;margin-bottom:3px;display:flex;align-items:center;justify-content:space-between;">
              <div style="display:flex;align-items:center;gap:4px;overflow:hidden;">
                <span style="display:inline-block;min-width:8px;height:8px;border-radius:50%;background:${pc(d.winner_party_2569)};flex-shrink:0;"></span>
                <b style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.winner_party_2569}</b>
              </div>
              <span style="font-family:'DM Mono';color:var(--muted);flex-shrink:0;margin-left:4px;">${(d.winner_votes_2569||0).toLocaleString()}</span>
            </div>
            <div style="font-size:11px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;">
              <div style="display:flex;align-items:center;gap:4px;overflow:hidden;">
                <span style="display:inline-block;min-width:8px;height:8px;border-radius:50%;background:${pc(d.runnerup_party_2569||'Unknown')};flex-shrink:0;"></span>
                <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.runnerup_party_2569||'Unknown'}</span>
              </div>
              <span style="font-family:'DM Mono';color:var(--muted);flex-shrink:0;margin-left:4px;">${(d.runnerup_votes_2569||0).toLocaleString()}</span>
            </div>
            <div style="font-size:10px;display:flex;justify-content:space-between;margin-bottom:2px;">
              <span style="color:var(--muted);">‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á:</span>
              <span style="font-family:'DM Mono';color:${mColor};">${(d.margin_2569||0).toLocaleString()}${!isModeSame ? ` (${mChangeSign}${marginChange.toLocaleString()})` : ''}</span>
            </div>
            <div style="border-top:1px dashed var(--border);margin:5px 0 4px;"></div>
            <div style="font-size:10px;display:flex;justify-content:space-between;margin-bottom:2px;">
              <span style="color:var(--muted);">‡∏ä‡πà‡∏≠‡∏á 1.2 ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå:</span>
              <span style="font-family:'DM Mono';">${(d.turnout_R||0).toLocaleString()}</span>
            </div>
            <div style="font-size:10px;display:flex;justify-content:space-between;">
              <span style="color:var(--muted);">4.1+4.2+4.3 ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£:</span>
              <span style="font-family:'DM Mono';">${(d.sum_R||0).toLocaleString()}${discRHtml}</span>
            </div>
          </div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:6px;display:flex;justify-content:space-between;align-items:center;">
          <span style="color:var(--muted);font-size:11px;">${isModeSame ? 'Œî (‡πÄ‡∏Ç‡∏ï ‚àí ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠):' : 'Œî ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå:'}</span>
          <span style="font-family:'DM Mono';color:${diffColor};font-weight:bold;">${diffSign}${Math.abs(diff).toLocaleString()} (${pctSign}${Math.abs(pct).toFixed(2)}%)</span>
        </div>
        ${!isModeSame ? `
        <div style="display:flex;justify-content:space-between;margin-top:3px;">
          <span style="color:var(--muted);font-size:11px;">Œî ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</span>
          <span style="font-family:'DM Mono';color:${mColor};font-size:11px;">${mChangeSign}${marginChange.toLocaleString()}</span>
        </div>` : `
        <div style="font-size:10px;color:var(--muted);margin-top:3px;text-align:center;">(Œî = ballot surplus ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£)</div>
        `}
      `;

      tip.style.display = 'block';
      let posX = e.clientX + 15;
      let posY = e.clientY + 15;
      if (posX + 350 > window.innerWidth)  posX = e.clientX - 360;
      if (posY + 350 > window.innerHeight) posY = e.clientY - tip.offsetHeight - 20;
      tip.style.left = posX + 'px';
      tip.style.top  = posY + 'px';
    }

    function hideTip() { document.getElementById('tooltip').style.display = 'none'; }

    // ‚îÄ‚îÄ‚îÄ PARTY LEGEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildLegend(currentData) {
      const container = document.getElementById('party-legend');
      container.innerHTML = '';
      const isModeC2    = compareMode === 'discrepancy';
      const isModeSame2 = compareMode === 'same';
      const rSel = isModeSame2 ? document.getElementById('archive-select-single') : document.getElementById('archive-select-right');
      let rightLabel = rSel ? rSel.options[rSel.selectedIndex].text.split(' | ')[0] : 'R';
      rightLabel = rightLabel.replace('Election ','').split(' (')[0].trim().replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','');
      const titleEl = document.getElementById('party-legend-title');
      const legLabel = isModeC2
        ? (currentDataset === 'partylist' ? '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠' : '‡πÄ‡∏Ç‡∏ï')
        : (isModeSame2 ? '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠' : rightLabel);
      if (titleEl) titleEl.textContent = `‡∏û‡∏£‡∏£‡∏Ñ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ (${legLabel})`;

      const visibleParties = new Set();
      currentData.forEach(d => {
        visibleParties.add(d.winner_party_2569);
        visibleParties.add(runnerUpParty(d));
      });
      const sortedParties = [...visibleParties].filter(Boolean).sort((a, b) => (a ?? '').localeCompare(b ?? '', 'th'));
      sortedParties.forEach(p => {
        const div = document.createElement('div');
        div.className = 'dot-label';
        div.innerHTML = `<div class="dot-swatch" style="background:${pc(p)}"></div>${p}`;
        container.appendChild(div);
      });
    }

    // ‚îÄ‚îÄ‚îÄ CAPTURE IMAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function captureImage() {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚è≥ Processing...'; btn.disabled = true;
      const element = document.getElementById('capture-container');
      const chartScroll = document.getElementById('chart-area');
      const header = document.getElementById('header');
      const origContainer = element.style.cssText;
      const origHeader = header.style.cssText;
      const origChart = chartScroll.style.cssText;
      try {
        element.style.height = 'auto'; element.style.width = '1200px';
        element.style.position = 'relative'; element.style.padding = '40px';
        header.style.position = 'relative'; header.style.width = '100%';
        header.style.top = '0'; header.style.left = '0';
        chartScroll.style.height = 'auto'; chartScroll.style.overflow = 'visible';
        chartScroll.style.position = 'relative'; chartScroll.style.marginTop = '20px';
        chartScroll.style.marginLeft = '0'; chartScroll.style.marginRight = '0';
        const dataUrl = await htmlToImage.toPng(element, {
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg'),
          quality: 0.95, pixelRatio: data.length > 50 ? 1 : 2, cacheBust: true,
        });
        const link = document.createElement('a');
        link.download = `total-votes-${new Date().getTime()}.png`;
        link.href = dataUrl; link.click();
        btn.textContent = originalText;
      } catch (err) {
        console.error("Capture Error:", err);
        btn.textContent = '‚ùå Error';
        setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 3000);
      } finally {
        element.style.cssText = origContainer;
        header.style.cssText = origHeader;
        chartScroll.style.cssText = origChart;
        btn.disabled = false;
      }
    }

    // ‚îÄ‚îÄ‚îÄ ARCHIVE LOADING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadArchive(url, side) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      const text = await res.text();

      const parseVar = (varName) => {
        const idx = text.indexOf(varName);
        if (idx === -1) return [];
        const arrStart = text.indexOf('[', idx);
        const arrEnd   = text.indexOf('];', arrStart);
        if (arrStart !== -1 && arrEnd !== -1) return JSON.parse(text.substring(arrStart, arrEnd + 1));
        return [];
      };

      const lastModified = res.headers.get('Last-Modified');
      const tsMatch = text.match(/\/\/ Generated:\s*(.+)/);
      let tsLabel;
      if (tsMatch) { tsLabel = tsMatch[1].trim(); }
      else if (lastModified) {
        const d = new Date(lastModified);
        tsLabel = d.toLocaleString('th-TH', { timeZone: 'Asia/Bangkok', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) + ' (ICT)';
      } else { tsLabel = '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'; }

      const selId = side === 'left' ? 'archive-select-left' : side === 'right' ? 'archive-select-right' : 'archive-select-single';
      const sel = document.getElementById(selId);
      const datasetName = sel ? sel.options[sel.selectedIndex].text : url;

      const tsElId = side === 'left' ? 'ts-left' : side === 'right' ? 'ts-right' : 'ts-single';
      const tsEl = document.getElementById(tsElId);
      if (tsEl) tsEl.textContent = `${datasetName}: ${tsLabel}`;

      const rawConst = parseVar('CONST_RAW');
      const rawPL    = parseVar('PARTYLIST_RAW');

      if (side === 'single') {
        DATA_SINGLE = { raw: rawConst.map(normalizeRecord), pl: rawPL.map(normalizeRecord) };
      } else if (side === 'left') {
        DATA_LEFT  = { raw: rawConst.map(normalizeRecord), pl: rawPL.map(normalizeRecord) };
      } else {
        DATA_RIGHT = { raw: rawConst.map(normalizeRecord), pl: rawPL.map(normalizeRecord) };
      }
    }

    // ‚îÄ‚îÄ‚îÄ BAR TIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function attachBarTip(el, label, count, pct, dsLabel, color) {
      if (!el) return;
      el.style.cursor = count > 0 ? 'crosshair' : 'default';
      if (count > 0) {
        el.onmousemove = (e) => {
          const tip = document.getElementById('tooltip');
          if (!tip) return;
          tip.innerHTML = `
            <div style="font-size:0.68rem;color:var(--muted);margin-bottom:6px;font-family:'DM Mono',monospace;">${dsLabel}</div>
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:5px;">
              <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};flex-shrink:0;"></span>
              <b>${label}</b>
            </div>
            <div style="font-family:'DM Mono',monospace;font-size:0.88rem;">${count.toLocaleString()} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted);margin-top:2px;">${pct}% ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>
          `;
          tip.style.display = 'block';
          tip.style.left = Math.min(e.clientX+14, window.innerWidth-350) + 'px';
          tip.style.top  = Math.min(e.clientY+14, window.innerHeight-130) + 'px';
        };
        el.onmouseleave = () => { document.getElementById('tooltip').style.display = 'none'; };
      } else { el.onmousemove = null; el.onmouseleave = null; }
    }

    // ‚îÄ‚îÄ‚îÄ VOTE BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateVoteBar() {
      const isModeSame = compareMode === 'same';
      const leftRawSrc  = isModeSame ? (DATA_SINGLE.raw || []) : (currentDataset === 'partylist' ? DATA_LEFT.pl  : (DATA_LEFT.raw  || []));
      const rightRawSrc = isModeSame ? (DATA_SINGLE.pl  || []) : (currentDataset === 'partylist' ? DATA_RIGHT.pl : (DATA_RIGHT.raw || []));

      const lSel = document.getElementById(isModeSame ? 'archive-select-single' : 'archive-select-left');
      const rSel = document.getElementById(isModeSame ? 'archive-select-single' : 'archive-select-right');
      const leftLabel  = isModeSame ? '‡πÄ‡∏Ç‡∏ï' : (lSel ? lSel.options[lSel.selectedIndex].text.split(' | ')[0] : 'L');
      const rightLabel = isModeSame ? '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠' : (rSel ? rSel.options[rSel.selectedIndex].text.split(' | ')[0] : 'R');

      function computeBar(rawArr) {
        if (!rawArr.length) return null;
        let totW=0, totRu=0, totInv=0, totBlank=0, totAll=0;
        let winnerParty='', winnerMax=0;
        const pc2 = {};
        rawArr.forEach(d => {
          totW += (d.winner_votes||0); totRu += (d.runnerup_votes||0);
          totInv += (d.invalid||0); totBlank += (d.blank||0);
          totAll += (d.turn_out||0);
          const p = d.winner_party||'Unknown';
          pc2[p] = (pc2[p]||0) + (d.winner_votes||0);
          if (pc2[p] > winnerMax) { winnerMax = pc2[p]; winnerParty = p; }
        });
        if (totAll === 0) return null;
        const totValid = totAll - totInv - totBlank;
        const totRest = Math.max(totValid - totW - totRu, 0);
        return {
          pW:   (totW     /totAll*100).toFixed(2),
          pRu:  (totRu    /totAll*100).toFixed(2),
          pRe:  (totRest  /totAll*100).toFixed(2),
          pBl:  (totBlank /totAll*100).toFixed(2),
          pIn:  (totInv   /totAll*100).toFixed(2),
          totW, totRu, totRest, totBlank, totInv, wColor: pc(winnerParty),
        };
      }

      const lv = computeBar(leftRawSrc);
      const rv = computeBar(rightRawSrc);

      const setBar = (prefix, v, label) => {
        const bW  = document.getElementById(`${prefix}-winner`);
        const bRu = document.getElementById(`${prefix}-runner`);
        const bRe = document.getElementById(`${prefix}-rest`);
        const bBl = document.getElementById(`${prefix}-blank`);
        const bIn = document.getElementById(`${prefix}-invalid`);
        if (!v) {
          [bW,bRu,bRe,bBl,bIn].forEach(el => { if (el) el.style.width = '0%'; });
          return '0';
        }
        if (bW)  { bW.style.width = v.pW+'%';  bW.style.background = v.wColor; }
        if (bRu) { bRu.style.width = v.pRu+'%'; bRu.style.background = '#94a3b8'; }
        if (bRe) bRe.style.width = v.pRe+'%';
        if (bBl) bBl.style.width = v.pBl+'%';
        if (bIn) bIn.style.width = v.pIn+'%';
        attachBarTip(bW,  '‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞',           v.totW,     v.pW,  label, v.wColor);
        attachBarTip(bRu, '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2',           v.totRu,    v.pRu, label, '#94a3b8');
        attachBarTip(bRe, '‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠',       v.totRest,  v.pRe, label, '#64748b');
        attachBarTip(bBl, '‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î',  v.totBlank, v.pBl, label, '#8b5cf6');
        attachBarTip(bIn, '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢',           v.totInv,   v.pIn, label, '#ef4444');
        return v.pIn;
      };

      const lPIn = setBar('vb',  lv, leftLabel);
      const rPIn = setBar('vbr', rv, rightLabel);
      const hasRight = rv !== null;

      const lbl_l = document.getElementById('vb-l-label');
      const lbl_r = document.getElementById('vb-r-label');
      const shortL = isModeSame ? '‡πÄ‡∏Ç‡∏ï' : leftLabel.replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','').replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á','');
      const shortR = isModeSame ? '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠' : (hasRight ? rightLabel.replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','').replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á','') : '‚Äî');
      if (lbl_l) lbl_l.textContent = shortL || 'L';
      if (lbl_r) lbl_r.textContent = shortR || 'R';

      const leg = document.getElementById('vote-bar-legend');
      if (leg) leg.innerHTML = `
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#ef4444;vertical-align:middle;margin-right:3px;"></span>L ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢: ${lPIn}%</span>
        ${hasRight ? `<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#ef4444;opacity:0.5;vertical-align:middle;margin-right:3px;"></span>R ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢: ${rPIn}%</span>` : ''}
        <span style="color:var(--muted);font-size:0.65rem;">‚óè ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ &nbsp;‚óè ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2 &nbsp;‚óè ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ &nbsp;‚óè ‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å &nbsp;‚óè ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢</span>
      `;
    }

    // ‚îÄ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderAll() {
      processRawData();
      updateCounts();
      updateMissingWarning();
      buildChart();
      if (data.length > 0) buildLegend(data);
      updateVoteBar();
    }

    // ‚îÄ‚îÄ‚îÄ SIDEBAR / LAYOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleSidebar(side) {
      if (side === 'left') {
        document.getElementById('left-sidebar').classList.toggle('show');
        document.getElementById('right-sidebar').classList.remove('show');
      } else {
        document.getElementById('right-sidebar').classList.toggle('show');
        document.getElementById('left-sidebar').classList.remove('show');
      }
      const overlay = document.getElementById('sidebar-overlay');
      const showAny = document.getElementById('left-sidebar').classList.contains('show') || document.getElementById('right-sidebar').classList.contains('show');
      overlay.classList.toggle('show', showAny);
    }

    function closeSidebars() {
      document.getElementById('left-sidebar').classList.remove('show');
      document.getElementById('right-sidebar').classList.remove('show');
      document.getElementById('sidebar-overlay').classList.remove('show');
    }

    function updateHeaderHeight() {
      const h = document.getElementById('header').getBoundingClientRect().height;
      document.documentElement.style.setProperty('--header-h', h + 'px');
    }

    function updateHeaderTitle() {
      const isModeC    = compareMode === 'discrepancy';
      const isModeSame = compareMode === 'same';
      const titleEl    = document.getElementById('header-title');
      const subtitleEl = document.getElementById('header-subtitle');
      if (isModeC) {
        const ss = document.getElementById('archive-select-single-c');
        const sn = ss ? ss.options[ss.selectedIndex].text.replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','').split(' (')[0] : '';
        if (titleEl) titleEl.textContent = `‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå vs ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ö‡∏±‡∏ï‡∏£ : ${sn}`;
        if (subtitleEl) subtitleEl.textContent = `‡∏ä‡πà‡∏≠‡∏á 1.2 vs 4.1+4.2+4.3 (‡πÅ‡∏ö‡∏ö ‡∏™.‡∏™. 6/1) ¬∑ ${fullProcessedData.length||0} ‡πÄ‡∏Ç‡∏ï`;
      } else if (isModeSame) {
        const ss = document.getElementById('archive-select-single');
        const sn = ss ? ss.options[ss.selectedIndex].text.replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','').split(' (')[0] : '';
        if (titleEl) titleEl.textContent = `‡πÄ‡∏Ç‡∏ï vs ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ : ${sn}`;
        if (subtitleEl) subtitleEl.textContent = `‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÄ‡∏Ç‡∏ï vs ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ¬∑ ${fullProcessedData.length||0} ‡πÄ‡∏Ç‡∏ï`;
      } else {
        const lSel = document.getElementById('archive-select-left');
        const rSel = document.getElementById('archive-select-right');
        const getShort = sel => {
          if (!sel) return '?';
          const t = sel.options[sel.selectedIndex].text;
          if (t.includes('(OCR)')) return '2569 (OCR)';
          if (t.includes('(94%)')) return '2569 (94%)';
          const m = t.match(/(\d{4})/);
          return m ? m[1] : t.split(' (')[0].trim().replace('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ','');
        };
        if (titleEl) titleEl.textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå : ${getShort(lSel)} ‚Üí ${getShort(rSel)}`;
        if (subtitleEl) subtitleEl.textContent = `‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ¬∑ ${fullProcessedData.length||0} ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ä‡∏∏‡∏î ¬∑ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Œî ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô`;
      }
    }

    // ‚îÄ‚îÄ‚îÄ X-SCALE / X-RANGE CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setScaleMode(mode) {
      useLogScale = mode === 'log';
      document.getElementById('btn-scale-linear').classList.toggle('active', !useLogScale);
      document.getElementById('btn-scale-log').classList.toggle('active', useLogScale);
      if (data.length > 0) buildChart();
    }

    function setRangeMode(mode) {
      useManualRange = mode === 'manual';
      document.getElementById('btn-range-auto').classList.toggle('active', !useManualRange);
      document.getElementById('btn-range-manual').classList.toggle('active', useManualRange);
      const sl = document.getElementById('x-range-slider');
      if (sl) sl.disabled = !useManualRange;
      const lbl = document.getElementById('x-range-label');
      if (!useManualRange && lbl) lbl.textContent = 'auto';
      if (data.length > 0) buildChart();
    }

    function onRangeSlider(val) {
      manualXMax = parseInt(val);
      const lbl = document.getElementById('x-range-label');
      if (lbl) lbl.textContent = '¬±' + (manualXMax >= 1000 ? (manualXMax / 1000).toFixed(0) + 'k' : manualXMax.toLocaleString());
      if (data.length > 0) buildChart();
    }

    // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function initApp() {
      // Mode A: load two datasets
      document.getElementById('btn-load-comparison').addEventListener('click', async () => {
        const btn = document.getElementById('btn-load-comparison');
        btn.textContent = "Loading..."; btn.disabled = true;
        try {
          await Promise.all([
            loadArchive(document.getElementById('archive-select-left').value,  'left'),
            loadArchive(document.getElementById('archive-select-right').value, 'right'),
          ]);
          document.getElementById('prompt-overlay').style.display = 'none';
          document.getElementById('chart-area').style.display     = 'flex';
          switchDataset(currentDataset);
          updateHeaderTitle();
        } catch (e) {
          alert("Error loading datasets. Ensure you are running a local web server (e.g. python -m http.server)");
          console.error(e);
        } finally {
          btn.textContent = "‚úî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (confirm)"; btn.disabled = false;
        }
      });

      // Mode B: load single dataset
      document.getElementById('btn-load-single').addEventListener('click', async () => {
        const btn = document.getElementById('btn-load-single');
        btn.textContent = "Loading..."; btn.disabled = true;
        try {
          await loadArchive(document.getElementById('archive-select-single').value, 'single');
          document.getElementById('prompt-overlay').style.display = 'none';
          document.getElementById('chart-area').style.display     = 'flex';
          updateHeaderTitle();
          renderAll();
        } catch (e) {
          alert("Error loading dataset. Ensure you are running a local web server (e.g. python -m http.server)");
          console.error(e);
        } finally {
          btn.textContent = "‚úî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (confirm)"; btn.disabled = false;
        }
      });

      updateHeaderHeight();
      window.addEventListener('resize', updateHeaderHeight);
      if (window.ResizeObserver) new ResizeObserver(updateHeaderHeight).observe(document.getElementById('header'));

      // Mode C: load single dataset (turn_out vs v+i+b)
      document.getElementById('btn-load-single-c').addEventListener('click', async () => {
        const btn = document.getElementById('btn-load-single-c');
        btn.textContent = "Loading..."; btn.disabled = true;
        try {
          await loadArchive(document.getElementById('archive-select-single-c').value, 'single');
          document.getElementById('prompt-overlay').style.display = 'none';
          document.getElementById('chart-area').style.display     = 'flex';
          updateHeaderTitle();
          renderAll();
        } catch (e) {
          alert("Error loading dataset. Ensure you are running a local web server (e.g. python -m http.server)");
          console.error(e);
        } finally {
          btn.textContent = "‚úî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (confirm)"; btn.disabled = false;
        }
      });

      document.getElementById('archive-select-left').addEventListener('change',     updateHeaderTitle);
      document.getElementById('archive-select-right').addEventListener('change',    updateHeaderTitle);
      document.getElementById('archive-select-single').addEventListener('change',   updateHeaderTitle);
      document.getElementById('archive-select-single-c').addEventListener('change', updateHeaderTitle);
    }

    initApp();
  </script>

</body>
</html>
