<!DOCTYPE html>
<html lang="th" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>version2 - Thailand Ballot Surplus Analysis 2569</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
  <style>
    /* ‚îÄ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #64748b;
      --faint: #f1f5f9;
      --red: #ef4444;
      --amber: #f59e0b;
      --teal: #14b8a6;
      --purple: #8b5cf6;
    }

    [data-theme="dark"] {
      --bg: #080e1a;
      --surface: #0f1827;
      --border: #1a2740;
      --text: #cbd5e1;
      --muted: #475569;
      --faint: #1e2d42;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Sarabun', sans-serif;
      font-size: 16px;
      min-height: 100vh;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ‚îÄ LAYOUT STRUCTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #wrapper {
      display: flex;
      height: 100vh;
      width: 100%;
      overflow: hidden;
    }

    #left-sidebar {
      width: 260px;
      height: 100vh;
      overflow-y: auto;
      border-right: 1px solid var(--border);
      background: var(--surface);
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 100;
      flex-shrink: 0;
    }

    .main-content {
      flex: 1;
      height: 100vh;
      overflow-y: auto;
      padding: 30px;
      background: var(--bg);
    }

    /* ‚îÄ‚îÄ‚îÄ SIDEBAR COMPONENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .sidebar-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    button, select {
      text-align: left;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
      transition: all 0.15s;
    }

    button:hover, select:hover { border-color: #38bdf8; }
    button.active {
      border-color: #38bdf8;
      color: #38bdf8;
      background: rgba(56, 189, 248, 0.08);
      font-weight: 500;
    }

    .sidebar-divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    /* ‚îÄ‚îÄ‚îÄ CHART COMPONENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .stats-row {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .stat-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 20px;
      flex: 1;
      min-width: 160px;
    }

    .stat-value { font-family: 'DM Mono', monospace; font-size: 1.3rem; font-weight: 600; }
    .stat-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; margin-top: 4px;}

    .party-section {
      margin-bottom: 30px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .party-header {
      padding: 14px 20px;
      background: var(--faint);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .party-dot { width: 12px; height: 12px; border-radius: 50%; }
    .party-name { font-weight: 600; font-size: 1.1rem; }
    .party-total-surplus { margin-left: auto; font-family: 'DM Mono', monospace; font-weight: 700; }

    .chart-container { padding: 15px 20px; }
    .row { display: flex; align-items: center; height: 32px; margin-bottom: 6px; }
    .row-label { width: 150px; font-size: 0.8rem; padding-right: 12px; text-align: right; color: var(--muted); }
    
    .bar-container {
      flex: 2; /* Larger share */
      height: 22px;
      display: flex;
      background: var(--faint);
      border-radius: 2px;
      overflow: hidden;
    }

    /* Diverging Surplus Bar Styling */
    .surplus-visualizer {
      flex: 1; /* Smaller share */
      height: 22px;
      margin-left: 15px;
      display: flex;
      align-items: center;
      position: relative;
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      background: var(--faint);
    }

    .surplus-center-line {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 1px;
      background: var(--muted);
      opacity: 0.5;
      z-index: 1;
    }

    .surplus-bar {
      height: 14px;
      border-radius: 2px;
      position: absolute;
      z-index: 2;
    }

    .bar-segment {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-family: 'DM Mono', monospace;
      color: white;
    }

    .surplus-value-text { width: 65px; text-align: right; font-family: 'DM Mono', monospace; font-size: 0.85rem; font-weight: 700; margin-left: 10px;}

    .tooltip {
      position: fixed; display: none; background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px; font-size: 12px; z-index: 2000; pointer-events: none;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 260px; color: var(--text);
    }
  </style>
</head>

<body>

<div id="wrapper">
  <div id="left-sidebar">
    <h2 style="font-size: 1.1rem; margin-bottom: 10px;">Surplus Analysis</h2>
    
    <button class="btn-sort" onclick="captureImage()" style="width: 100%; text-align: center; background: var(--teal); color: white; border: none;">üì∑ Save as Image</button>
    <button onclick="toggleTheme()" style="width: 100%; text-align: center; margin-top: 5px;">‚òÄÔ∏è / üåô Theme</button>

    <div class="sidebar-divider"></div>

    <div class="sidebar-label">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Dataset</div>
    <div class="btn-group">
      <button id="ds-const" class="active" onclick="setDataset('constituency')">‡∏™.‡∏™. (‡πÄ‡∏Ç‡∏ï)</button>
      <button id="ds-pl" onclick="setDataset('partylist')">‡∏ö‡∏™. (‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)</button>
    </div>

    <div class="sidebar-label">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° | Group By</div>
    <div class="btn-group">
      <button id="grp-party" class="active" onclick="setGrouping('party')">‡∏û‡∏£‡∏£‡∏Ñ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</button>
      <button id="grp-region" onclick="setGrouping('region')">‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ</button>
    </div>

    <div class="sidebar-label">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• | Filter</div>
    <div class="btn-group">
      <button id="flt-pos" class="active" onclick="setFilter('positive')">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß > ‡∏ä‡∏°‡∏û‡∏π (+)</button>
      <button id="flt-neg" onclick="setFilter('negative')">‡∏ä‡∏°‡∏û‡∏π > ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‚àí)</button>
      <button id="flt-all" onclick="setFilter('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div class="sidebar-spacer" style="flex-grow: 1; min-height: 50px;"></div>
    <div class="sidebar-disclaimer"
        style="font-size: 0.75rem; line-height: 1.4; color: var(--muted); padding-top: 15px; border-top: 1px solid var(--border); margin-top: auto;">
        <p style="color: var(--red)"><strong>‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Disclaimers):</strong></p>

        <p><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2566</strong> ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Å‡∏Å‡∏ï. (https://ectreport66.ect.go.th/) </p>
        <p><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ 2569</strong> ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏Å‡∏ï. ‡πÅ‡∏ö‡∏ö ‡∏™.‡∏™.6/1 ‡πÇ‡∏î‡∏¢ Chanon Ngernthongdee </p><br>
        <p>‡∏™‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å PDF ‡∏î‡πâ‡∏ß‡∏¢ OCR; Source: <a
            href="https://github.com/killernay/election-69-OCR-result">killernay/election-69-OCR-result</a></p><br>
        <p>‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
        <p>‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 42 ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢</p><br><br>

        <p>Data visualization by</p>
        <p>¬© 2026 Ronnakrit Rattanasriampaipong</p>
        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ß‡∏±‡∏ô‡∏ó‡∏µ: 22 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569</p>
    </div>
  </div>

  <div class="main-content">
    <div id="capture-container" style="background: var(--bg); padding: 10px;">
        <h1 style="margin-bottom: 5px;">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‚Äì ‡∏ö‡∏±‡∏ï‡∏£‡∏ä‡∏°‡∏û‡∏π (Ballot Surplus)</h1>
        <p style="margin-bottom: 25px; color: var(--muted); font-size: 0.9rem;">
          ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÅ‡∏•‡∏∞ Visualizing ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) vs ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏ä‡∏°‡∏û‡∏π)
        </p>

        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-label">‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</div>
                <div class="stat-value" id="stat-total">‚Äî</div>
                <div id="stat-total-ballots" style="font-size: 0.75rem; color: var(--muted); margin-top: 4px; font-family: 'DM Mono';">0 ‡πÉ‡∏ö</div>
            </div>
            
            <div class="stat-box">
                <div class="stat-label">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß > ‡∏ä‡∏°‡∏û‡∏π (+)</div>
                <div class="stat-value" style="color: var(--red);" id="stat-positive">‚Äî</div>
                <div id="stat-positive-ballots" style="font-size: 0.75rem; color: var(--red); opacity: 0.8; margin-top: 4px; font-family: 'DM Mono';">+0 ‡πÉ‡∏ö</div>
            </div>
            
            <div class="stat-box">
                <div class="stat-label">‡∏ä‡∏°‡∏û‡∏π > ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (-)</div>
                <div class="stat-value" style="color: var(--purple);" id="stat-negative">‚Äî</div>
                <div id="stat-negative-ballots" style="font-size: 0.75rem; color: var(--purple); opacity: 0.8; margin-top: 4px; font-family: 'DM Mono';">-0 ‡πÉ‡∏ö</div>
            </div>
            
            <div class="stat-box">
                <div class="stat-label">Net Surplus (‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)</div>
                <div class="stat-value" id="stat-sum-surplus">‚Äî</div>
                <div id="stat-sum-count" style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">0 ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà</div>
            </div>
        </div>

        <div id="chart-area"></div>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script src="election_data_generated.js"></script>
<script>
  // ‚îÄ‚îÄ‚îÄ DATA & COLORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const PARTY_COLOR = {
    '‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢': '#312682', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô': '#FF6413', '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢': '#E30613',
    '‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏£‡∏£‡∏°': '#4EC86F', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå': '#15A5F5', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥': '#BA810D',
    '‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ó‡∏¢': '#6841D0', '‡∏û‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏£‡∏±‡∏ê': '#006536', '‡πÑ‡∏ó‡∏£‡∏ß‡∏°‡∏û‡∏•‡∏±‡∏á': '#5266AD',
    '‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥': '#2b2c80', '‡∏Å‡πâ‡∏≤‡∏ß‡πÑ‡∏Å‡∏•': '#f97316'
  };
  function pc(name) { return PARTY_COLOR[name] || '#94a3b8'; }

  let currentDataset = 'constituency';
  let currentFilter = 'positive';
  let currentGrouping = 'party';

  function getSurplus(d) { return d.ballot_surplus ?? 0; }

  function setGrouping(g) {
    currentGrouping = g;
    document.getElementById('grp-party').classList.toggle('active', g === 'party');
    document.getElementById('grp-region').classList.toggle('active', g === 'region');
    render();
  }

  function setDataset(ds) {
    currentDataset = ds;
    document.getElementById('ds-const').classList.toggle('active', ds === 'constituency');
    document.getElementById('ds-pl').classList.toggle('active', ds === 'partylist');
    render();
  }

  function setFilter(f) {
    currentFilter = f;
    document.getElementById('flt-pos').classList.toggle('active', f === 'positive');
    document.getElementById('flt-neg').classList.toggle('active', f === 'negative');
    document.getElementById('flt-all').classList.toggle('active', f === 'all');
    render();
  }

  function toggleTheme() {
    const root = document.documentElement;
    root.dataset.theme = root.dataset.theme === 'dark' ? 'light' : 'dark';
  }

  // ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function render() {
    const sourceData = currentDataset === 'partylist' ? (typeof PARTYLIST_RAW !== 'undefined' ? PARTYLIST_RAW : []) : (typeof CONST_RAW !== 'undefined' ? CONST_RAW : []);

    let filtered = sourceData.filter(d => {
      const s = getSurplus(d);
      if (currentFilter === 'positive') return s > 0;
      if (currentFilter === 'negative') return s < 0;
      return s !== 0;
    });

    // Calculate Global Max Surplus for Bar Scaling
    const maxSurplus = Math.max(...sourceData.map(d => Math.abs(getSurplus(d))), 1);

    const posDistricts = sourceData.filter(d => getSurplus(d) > 0);
    const negDistricts = sourceData.filter(d => getSurplus(d) < 0);
    const totalWithDiff = sourceData.filter(d => getSurplus(d) !== 0);

    const sumPosBallots = posDistricts.reduce((s, d) => s + getSurplus(d), 0);
    const sumNegBallots = negDistricts.reduce((s, d) => s + getSurplus(d), 0);
    const absTotalError = totalWithDiff.reduce((s, d) => s + Math.abs(getSurplus(d)), 0);
    const netSurplus = filtered.reduce((s, d) => s + getSurplus(d), 0);

    // Update Global Stats
    document.getElementById('stat-total').textContent = totalWithDiff.length.toLocaleString();
    document.getElementById('stat-positive').textContent = posDistricts.length.toLocaleString();
    document.getElementById('stat-negative').textContent = negDistricts.length.toLocaleString();

    document.getElementById('stat-total-ballots').textContent = absTotalError.toLocaleString() + " ‡πÉ‡∏ö (Error ‡∏£‡∏ß‡∏°)";
    document.getElementById('stat-positive-ballots').textContent = "+" + sumPosBallots.toLocaleString() + " ‡πÉ‡∏ö";
    document.getElementById('stat-negative-ballots').textContent = sumNegBallots.toLocaleString() + " ‡πÉ‡∏ö";

    const sum = filtered.reduce((s, d) => s + getSurplus(d), 0);
    const statSum = document.getElementById('stat-sum-surplus');
    statSum.textContent = (netSurplus > 0 ? '+' : '') + netSurplus.toLocaleString();
    statSum.style.color = netSurplus > 0 ? 'var(--red)' : 'var(--purple)';
    document.getElementById('stat-sum-count').textContent = "‡∏à‡∏≤‡∏Å " + filtered.length + " ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà";

    // Grouping
    const groups = {};
    filtered.forEach(d => {
      const key = currentGrouping === 'region' ? (d.region || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') : (d.winner_party_2569 || 'Unknown');
      if (!groups[key]) groups[key] = [];
      groups[key].push(d);
    });

    const sortedGroups = Object.keys(groups).sort().map(key => ({
      name: key,
      data: groups[key].sort((a,b) => Math.abs(getSurplus(b)) - Math.abs(getSurplus(a))),
      total: groups[key].reduce((s, d) => s + getSurplus(d), 0)
    }));

    const chartArea = document.getElementById('chart-area');
    chartArea.innerHTML = sortedGroups.map(g => `
      <div class="party-section">
        <div class="party-header">
          <div class="party-dot" style="background: ${currentGrouping === 'party' ? pc(g.name) : 'var(--teal)'}"></div>
          <span class="party-name">${g.name}</span>
          <span class="party-total-surplus" style="color: ${g.total > 0 ? 'var(--red)' : 'var(--purple)'}">
            ${g.total > 0 ? '+' : ''}${g.total.toLocaleString()} ‡πÉ‡∏ö
          </span>
        </div>
        <div class="chart-container">
          <div class="row" style="height: 20px; margin-bottom: 10px; font-size: 0.65rem; font-weight: bold; color: var(--muted);">
             <div class="row-label"></div>
             <div style="flex:2; text-align: center;">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Winner/Runner-up/Inv)</div>
             <div style="flex:1; text-align: center;">Surplus Visualizer</div>
             <div class="surplus-value-text">‡πÉ‡∏ö</div>
          </div>
          ${g.data.map(d => {
            const s = getSurplus(d);
            const total = (d.valid_2569 || 0) + (d.invalid_2569 || 0) + (d.blank_2569 || 0);
            const winP = (d.winner_votes_2569 / total * 100);
            const runP = (d.runnerup_votes_2569 / total * 100);
            const invP = (d.invalid_2569 / total * 100);
            const restP = 100 - winP - runP - invP;
            
            const surplusBarWidth = (Math.abs(s) / maxSurplus) * 50; 

            return `
                <div class="row" onmousemove="showTip(event, ${JSON.stringify(d).replace(/"/g, '&quot;')})" onmouseleave="hideTip()">
                <div class="row-label">${d.province_thai} ‡πÄ‡∏Ç‡∏ï ${d.cons_no}</div>
                <div class="bar-container">
                    <div class="bar-segment" style="width:${winP}%; background:${pc(d.winner_party_2569)}">
                    ${winP > 12 ? d.winner_votes_2569.toLocaleString() : ''}
                    </div>
                    <div class="bar-segment" style="width:${runP}%; background:${pc(d.runnerup_party_2569)}; opacity:0.7">
                    ${runP > 12 ? d.runnerup_votes_2569.toLocaleString() : ''}
                    </div>
                    <div class="bar-segment" style="width:${restP}%; background:#64748b; opacity:0.3"></div>
                    <div class="bar-segment" style="width:${invP}%; background:#1e293b"></div>
                </div>
                <div class="surplus-visualizer">
                    <div class="surplus-center-line"></div>
                    <div class="surplus-bar" style="
                    width: ${surplusBarWidth}%; 
                    left: ${s > 0 ? '50%' : `calc(50% - ${surplusBarWidth}%)`};
                    background: ${s > 0 ? 'var(--red)' : 'var(--purple)'};
                    "></div>
                </div>
                <div class="surplus-value-text ${s > 0 ? 'surplus-positive' : 'surplus-negative'}">
                    ${s > 0 ? '+' : ''}${s.toLocaleString()}
                </div>
                </div>
            `;
            }).join('')}
        </div>
      </div>
    `).join('');
  }

  function showTip(e, d) {
    const tip = document.getElementById('tooltip');
    const s = getSurplus(d);
    
    // Use correct keys based on your data structure
    const winnerVotes = d.winner_votes_2569 || 0;
    const runnerupVotes = d.runnerup_votes_2569 || 0;
    const winnerParty = d.winner_party_2569 || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    const runnerupParty = d.runnerup_party_2569 || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

    tip.innerHTML = `
        <div style="font-weight:700; margin-bottom:5px; border-bottom:1px solid var(--border); padding-bottom:4px;">
        ${d.province_thai} ‡πÄ‡∏Ç‡∏ï ${d.cons_no}
        </div>
        <div style="color:var(--muted); font-size:10px; margin-bottom:10px;">${d.region || ''}</div>
        
        <div style="display:flex; justify-content:space-between; margin-bottom:3px;">
        <span style="font-size:11px;">‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ (<span style="color:${pc(winnerParty)}">${winnerParty}</span>):</span>
        <span style="font-family:'DM Mono'; font-weight:600;">${winnerVotes.toLocaleString()}</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:3px;">
        <span style="font-size:11px;">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2 (<span style="color:${pc(runnerupParty)}">${runnerupParty}</span>):</span>
        <span style="font-family:'DM Mono'; font-weight:600;">${runnerupVotes.toLocaleString()}</span>
        </div>
        
        <div style="border-top:1px solid var(--border); margin-top:8px; padding-top:8px;">
        <div style="display:flex; justify-content:space-between; font-weight:700;">
            <span>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£:</span>
            <span style="color:${s > 0 ? 'var(--red)' : 'var(--purple)'}">${s > 0 ? '+' : ''}${s.toLocaleString()} ‡πÉ‡∏ö</span>
        </div>
        <div style="font-size: 10px; color: var(--muted); margin-top: 4px; text-align:center;">
            ${s > 0 ? '‚ö† ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï > ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠' : s < 0 ? '‚ö† ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ > ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï' : '‚úì ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô'}
        </div>
        </div>
    `;
    
    tip.style.display = 'block';
    
    // Position logic with boundary detection
    let x = e.clientX + 15;
    let y = e.clientY + 15;
    if (x + 280 > window.innerWidth) x = e.clientX - 280;
    if (y + 180 > window.innerHeight) y = e.clientY - 180;
    
    tip.style.left = x + 'px';
    tip.style.top = y + 'px';
    }

  function hideTip() { document.getElementById('tooltip').style.display = 'none'; }

  async function captureImage() {
    const btn = event.target;
    btn.textContent = '‚è≥ Processing...';
    btn.disabled = true;
    try {
      const dataUrl = await htmlToImage.toPng(document.getElementById('capture-container'), {
        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg'),
        pixelRatio: data.length > 50 ? 1 : 2,
      });
      const link = document.createElement('a');
      link.download = `surplus-analysis-${new Date().getTime()}.png`;
      link.href = dataUrl;
      link.click();
      btn.textContent = 'üì∑ Save as Image';
    } catch (err) {
      btn.textContent = '‚ùå Error';
    } finally {
      btn.disabled = false;
    }
  }

  render();
</script>

</body>
</html>