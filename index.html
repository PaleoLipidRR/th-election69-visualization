<!DOCTYPE html>
<html lang="th" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thailand Invalid Ballots 2566 â†’ 2569</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
  <style>
    /* â”€â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #080e1a;
      --surface: #0f1827;
      --border: #1a2740;
      --text: #cbd5e1;
      --muted: #475569;
      --faint: #1e2d42;
      --red: #ef4444;
      --amber: #f59e0b;
      --teal: #14b8a6;
      --ring: #ffffff;
    }

    [data-theme="light"] {
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #64748b;
      --faint: #f1f5f9;
      --ring: #1e293b;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Sarabun', sans-serif;
      font-size: 18px;
      min-height: 100vh;
    }

    /* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 16px 28px 12px;
      display: flex;
      align-items: flex-end;
      gap: 32px;
      flex-wrap: wrap;
    }

    #header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.01em;
    }

    #header p {
      font-size: 0.85rem;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      margin-top: 3px;
    }

    .header-stats {
      display: flex;
      gap: 24px;
      margin-left: auto;
    }

    .hstat {
      text-align: right;
    }

    .hstat .v {
      font-family: 'DM Mono', monospace;
      font-size: 1.15rem;
      font-weight: 500;
      color: var(--text);
    }

    .hstat .l {
      font-size: 0.78rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* â”€â”€â”€ LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #legend {
      padding: 8px 28px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
      font-size: 0.82rem;
      color: var(--muted);
      background: var(--bg);
      position: sticky;
      top: 80px;
      z-index: 99;
      margin-left: 190px;
      margin-right: 190px;
    }

    .legend-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .legend-group span {
      font-family: 'DM Mono', monospace;
      color: var(--muted);
      margin-right: 4px;
    }

    .dot-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
    }

    .dot-swatch {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .bar-swatch {
      width: 14px;
      height: 8px;
      border-radius: 1px;
      flex-shrink: 0;
    }

    /* Lock the main wrapper to the screen height */
    #wrapper {
      display: flex;
      padding: 0;
      height: calc(100vh - 80px);
      width: 100%;
      overflow: hidden;
    }

    /* Constrain the chart area and enable internal scrolling */
    #chart-area {
      display: flex;
      padding: 0 28px;
      margin-left: 250px;
      margin-right: 190px;
      flex: 1;
      height: 100%;
      overflow-y: auto;
      overflow-x: auto;
      align-items: flex-start;
      background: var(--bg);
    }

    /* Ensure sidebars stay pinned to the sides */
    #left-sidebar,
    #right-sidebar {
      position: fixed;
      top: 80px;
      height: calc(100vh - 80px);
      z-index: 97;
      overflow-y: auto;
    }

    /* â”€â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #tooltip {
      position: fixed;
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      z-index: 10001;
      pointer-events: none;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
      min-width: 220px;
      color: var(--text);
    }

    #tooltip b {
      color: var(--text);
    }

    #tooltip .tip-change {
      font-family: 'DM Mono', monospace;
      font-weight: 500;
    }

    .ctrl-label {
      color: var(--muted);
      margin-right: 4px;
    }

    .btn-sort {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 3px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.82rem;
      font-family: 'DM Mono', monospace;
      transition: border-color 0.15s, color 0.15s;
    }

    .btn-sort:hover {
      border-color: #38bdf8;
      color: #38bdf8;
    }

    .btn-sort.active {
      border-color: #38bdf8;
      color: #38bdf8;
      background: rgba(56, 189, 248, 0.06);
    }

    .btn-dataset.active {
      border-color: #38bdf8;
      color: #38bdf8;
      background: rgba(56, 189, 248, 0.06);
    }

    /* â”€â”€â”€ SIDEBARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #left-sidebar {
      position: fixed;
      top: 80px;
      left: 0;
      width: 250px;
      height: calc(100vh - 80px);
      overflow-y: auto;
      border-right: 1px solid var(--border);
      background: var(--bg);
      padding: 16px 12px;
      z-index: 97;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #right-sidebar {
      position: fixed;
      top: 80px;
      right: 0;
      width: 190px;
      height: calc(100vh - 80px);
      overflow-y: auto;
      border-left: 1px solid var(--border);
      background: var(--bg);
      padding: 16px 12px;
      z-index: 97;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .sidebar-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
    }

    #left-sidebar .btn-filter {
      display: block;
      width: 100%;
      text-align: left;
      white-space: normal;
      line-height: 1.4;
      padding: 5px 10px;
    }

    #right-sidebar #party-legend {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    #left-sidebar .btn-sort:not(.btn-filter) {
      display: block;
      width: 100%;
      text-align: left;
    }

    .sidebar-divider {
      height: 1px;
      background: var(--border);
      margin: 10px 0 14px;
    }

    /* â”€â”€â”€ SVG PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chart-area {
      display: flex;
      padding: 0 28px;
      gap: 0;
      min-width: max-content;
      margin-left: 190px;
      margin-right: 190px;
    }

    svg {
      display: block;
      overflow: visible;
    }

    @media (max-width: 850px) {
      #left-sidebar,
      #right-sidebar {
        position: relative;
        width: 100%;
        height: auto;
        top: 0;
        border: none;
        border-bottom: 1px solid var(--border);
      }

      #legend,
      #chart-area {
        margin-left: 0;
        margin-right: 0;
        padding: 10px;
      }

      #wrapper {
        flex-direction: column;
        height: auto;
        overflow: visible;
      }

      #chart-area {
        overflow-x: auto;
        display: block;
      }
    }

    @media print {
      #left-sidebar,
      #right-sidebar {
        display: none !important;
      }

      #header {
        position: static !important;
      }

      #chart-area {
        margin-left: 0 !important;
        margin-right: 0 !important;
        overflow: visible !important;
      }

      body {
        background: white !important;
      }
    }
  </style>
</head>

<body>

  <div id="capture-container" style="background: var(--bg); padding: 20px 0;">
    <div id="header">
      <div>
        <h1>à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢ : à¸à¸²à¸£à¹€à¸¥à¸·à¸­à¸à¸•à¸±à¹‰à¸‡ 2566 â†’ 2569</h1>
        <p id="header-subtitle">à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸­à¸±à¸•à¸£à¸²à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢ Â· 400 à¹€à¸‚à¸•à¹€à¸¥à¸·à¸­à¸à¸•à¸±à¹‰à¸‡ Â· à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡ % à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡</p>
      </div>
      <div class="header-stats">
        <div class="hstat">
          <div class="v" id="hs-danger">â€”</div>
          <div class="l">à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢ &gt; à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡à¸„à¸°à¹à¸™à¸™</div>
          <div class="l" style="font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--red); margin-top: 2px;" id="hs-danger-sum"></div>
        </div>
        <div class="hstat">
          <div class="v" id="hs-improved">â€”</div>
          <div class="l">â†“ à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢à¸¥à¸”à¸¥à¸‡</div>
          <div class="l" style="font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--teal); margin-top: 2px;" id="hs-improved-sum"></div>
        </div>
        <div class="hstat">
          <div class="v" id="hs-worse">â€”</div>
          <div class="l">â†‘ à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢à¹€à¸à¸´à¹ˆà¸¡à¸‚à¸¶à¹‰à¸™</div>
          <div class="l" style="font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--red); margin-top: 2px;" id="hs-worse-sum"></div>
        </div>
        <div class="hstat" style="border-left:1px solid var(--border);padding-left:20px;margin-left:4px">
          <div class="v" id="hs-all-summary">â€”</div>
          <div class="l">â†‘â†“ à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
          <div class="l" style="font-family: 'DM Mono', monospace; font-size: 0.65rem; margin-top: 2px;" id="hs-all-sum"></div>
        </div>
      </div>
    </div>

    <div id="left-sidebar">
      <button id="btn-theme" class="btn-sort" onclick="toggleTheme()" title="à¸ªà¸¥à¸±à¸šà¹‚à¸«à¸¡à¸”à¸ªà¸§à¹ˆà¸²à¸‡/à¸¡à¸·à¸”"
        style="font-size:0.75rem;padding:3px 10px;margin-bottom:4px;margin-top:10px">â˜€ï¸ Light</button>
      <button class="btn-sort" onclick="captureImage()" title="à¸šà¸±à¸™à¸—à¸¶à¸à¸£à¸¹à¸›à¸ à¸²à¸"
        style="font-size:0.75rem;padding:3px 10px;margin-bottom:12px">ğŸ“· à¸šà¸±à¸™à¸—à¸¶à¸à¸£à¸¹à¸›à¸ à¸²à¸</button>

      <div class="sidebar-label">à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸­à¸·à¹ˆà¸™à¹†</div>
      <button class="btn-sort" onclick="window.location.href='surplus_analysis.html'" 
              style="width: 100%; background: var(--teal); color: white; border: none; margin-bottom: 10px;">
        ğŸ“Š à¸”à¸¹à¸ªà¹ˆà¸§à¸™à¸•à¹ˆà¸²à¸‡à¸šà¸±à¸•à¸£ (Surplus)
      </button>
            
      <div class="sidebar-label">à¸Šà¸¸à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ | dataset</div>
      <button class="btn-sort btn-dataset active" onclick="switchDataset('constituency')" title="à¸ª.à¸ª. - à¹€à¸‚à¸•à¹€à¸¥à¸·à¸­à¸à¸•à¸±à¹‰à¸‡"
        style="font-size:0.75rem;padding:3px 10px;margin-bottom:2px">à¸ª.à¸ª. (à¹€à¸‚à¸•)</button>
      <button class="btn-sort btn-dataset" onclick="switchDataset('partylist')" title="à¸šà¸ª. - à¸ª.à¸ª. à¸ˆà¸²à¸à¸šà¸±à¸à¸Šà¸µà¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­"
        style="font-size:0.75rem;padding:3px 10px;margin-bottom:12px">à¸šà¸ª. (à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­)</button>
      
      <div class="sidebar-label">à¸à¸£à¸­à¸‡ | filter by</div>
      <button class="btn-sort btn-filter active" onclick="setFilter('all')">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”&nbsp;<span id="cnt-all"
          style="font-family:DM Mono,monospace;font-size:0.65rem;opacity:0.6"></span></button>
      <button class="btn-sort btn-filter" onclick="setFilter('danger')" style="color:#ef4444;border-color:#ef444455">âš 
        à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢ &gt; à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡à¸„à¸°à¹à¸™à¸™&nbsp;<span id="cnt-danger"
          style="font-family:DM Mono,monospace;font-size:0.65rem;opacity:0.6"></span></button>
      <button class="btn-sort btn-filter" onclick="setFilter('safe')" style="color:#14b8a6;border-color:#14b8a655">âœ“
        à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡à¸„à¸°à¹à¸™à¸™à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢&nbsp;<span id="cnt-safe"
          style="font-family:DM Mono,monospace;font-size:0.65rem;opacity:0.6"></span></button>
      <div class="sidebar-divider"></div>
      <div class="sidebar-label">à¹€à¸£à¸µà¸¢à¸‡à¹‚à¸”à¸¢ | sort by</div>
      <button class="btn-sort active" onclick="resort('pct_change')">% à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡</button>
      <button class="btn-sort" onclick="resort('pct_2569')">% à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢ 2569</button>
      <button class="btn-sort" onclick="resort('province')">à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”</button>
      <button class="btn-sort" onclick="resort('party_2566')">à¸œà¸¹à¹‰à¸Šà¸™à¸° 2566</button>
      <button class="btn-sort" onclick="resort('party_2569')">à¸œà¸¹à¹‰à¸Šà¸™à¸° 2569</button>

      <div class="sidebar-spacer" style="flex-grow: 1; min-height: 50px;"></div>
      <div class="sidebar-disclaimer"
        style="font-size: 0.75rem; line-height: 1.4; color: var(--muted); padding-top: 15px; border-top: 1px solid var(--border); margin-top: auto;">
        <p style="color: var(--red)"><strong>à¸‚à¹‰à¸­à¸ªà¸‡à¸§à¸™à¸ªà¸´à¸—à¸˜à¸´à¹Œ (Disclaimers):</strong></p>

        <p><strong>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸›à¸µ 2566</strong> à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸ˆà¸²à¸à¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œà¸à¸à¸•. (https://ectreport66.ect.go.th/) </p>
        <p><strong>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸›à¸µ 2569</strong> à¸¡à¸²à¸ˆà¸²à¸à¸£à¸²à¸¢à¸‡à¸²à¸™à¸„à¸°à¹à¸™à¸™à¸à¸à¸•. à¹à¸šà¸š à¸ª.à¸ª.6/1 à¹‚à¸”à¸¢ Chanon Ngernthongdee </p><br>
        <p>à¸ªà¸à¸±à¸”à¸ˆà¸²à¸ PDF à¸”à¹‰à¸§à¸¢ OCR; Source: <a
            href="https://github.com/killernay/election-69-OCR-result">killernay/election-69-OCR-result</a></p><br>
        <p>à¹„à¸¡à¹ˆà¸¢à¸·à¸™à¸¢à¸±à¸™à¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¸„à¸°à¹à¸™à¸™</p>
        <p>à¸ªà¸¸à¹ˆà¸¡à¸•à¸£à¸§à¸ˆà¸à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ PDF à¹€à¸‰à¸à¸²à¸° 42 à¹€à¸‚à¸•à¸—à¸µà¹ˆà¸œà¸¥à¸•à¹ˆà¸²à¸‡à¸„à¸°à¹à¸™à¸™à¸ªà¸­à¸‡à¸­à¸±à¸™à¸”à¸±à¸šà¸™à¹‰à¸­à¸¢à¸à¸§à¹ˆà¸²à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢</p><br><br>

        <p>Data visualization by</p>
        <p>Â© 2026 Ronnakrit Rattanasriampaipong</p>
        <p>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸±à¸à¹€à¸”à¸—à¸§à¸±à¸™à¸—à¸µ: 22 à¸à¸¸à¸¡à¸ à¸²à¸à¸±à¸™à¸˜à¹Œ 2569</p>
      </div>
    </div>


    <div id="chart-area">
      <svg id="svg-left"></svg>
      <svg id="svg-mid"></svg>
      <svg id="svg-right"></svg>
    </div>
  </div>

  <div id="right-sidebar">
    <div class="sidebar-label" style="margin-top:20px">à¸à¸£à¸£à¸„à¸œà¸¹à¹‰à¸Šà¸™à¸° 2569</div>
    <div id="party-legend"></div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-label">à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢</div>
    <div style="font-size:0.75rem; color:var(--muted); margin-top:10px; display:flex; flex-direction:column; gap:6px;">
      <div style="display:flex; align-items:center; gap:8px;">
        <div
          style="width:7px; height:7px; border-radius:50%; background:rgba(148,163,184,0.5); border:0.5px solid var(--muted);">
        </div>
        <span>à¸ˆà¸¸à¸”à¸˜à¸£à¸£à¸¡à¸”à¸² = 2566</span>
      </div>

      <div style="display:flex; align-items:center; gap:8px;">
        <div
          style="width:7px; height:7px; border-radius:50%; background:var(--muted); outline:2px solid var(--ring); outline-offset:1px;">
        </div>
        <span>à¸¡à¸µà¸§à¸‡à¹à¸«à¸§à¸™ = 2569</span>
      </div>
    </div><br>
    <div class="dot-label">
      <div class="bar-swatch" style="background:#3e3f3f"></div>à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸à¸£à¸£à¸„à¸ªà¸­à¸‡à¸­à¸±à¸™à¸”à¸±à¸šà¹à¸£à¸ 2569
    </div>
    <div class="dot-label">
      <div class="bar-swatch" style="background:#d7d1d2"></div>à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢
    </div>
    <div class="dot-label">
      <div class="bar-swatch" style="background:#f05957"></div>à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢ &gt; à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸à¸£à¸£à¸„à¸ªà¸­à¸‡à¸­à¸±à¸™à¸”à¸±à¸šà¹à¸£à¸ âš 
    </div>
  </div>

  <div id="tooltip"></div>
  <script src="election_data_generated.js"></script>
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATA NORMALIZATION
    // Normalize field names from notebook export to what the visualization expects
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function normalizeRecord(d) {
      // Helper to safely get numeric value
      const num = (val, fallback = 0) => {
        if (val === null || val === undefined || isNaN(val)) return fallback;
        return Number(val);
      };
      
      // Helper to safely get string value
      const str = (val, fallback = "Unknown") => {
        if (val === null || val === undefined || val === "") return fallback;
        return String(val);
      };

      return {
        // Location fields (pass through)
        province_thai: str(d.province_thai),
        province_eng: str(d.province_eng, d.province_thai),
        cons_no: num(d.cons_no),
        region: str(d.region),
        
        // 2566 data - normalize field names
        percent_invalid: num(d.percent_invalid_2566 ?? d.percent_invalid),
        turn_out: num(d.turn_out_2566 ?? d.turn_out),
        winner_party: str(d.winner_party_2566 ?? d.winner_party),
        
        // 2569 data - normalize field names
        invalid_2569: num(d.invalid_2569),
        percent_invalid_2569: num(d.percent_invalid_2569),
        winner_party_2569: str(d.winner_party_2569),
        winner_votes_2569: num(d.winner_votes_2569),
        runnerup_party_2569: str(d.runnerup_party_2569),
        runnerup_votes_2569: num(d.runnerup_votes_2569),
        margin_2569: num(d.margin_2569),
        
        // Changes
        invalid_pct_change: num(d.invalid_pct_change),
        invalid_change: num(d.invalid_change),
        turnout_change: num(d.turnout_change),
      };
    }

    // Normalize both datasets
    const RAW = (typeof CONST_RAW !== 'undefined' ? CONST_RAW : []).map(normalizeRecord);
    const PARTYLIST_NORMALIZED = (typeof PARTYLIST_RAW !== 'undefined' ? PARTYLIST_RAW : []).map(normalizeRecord);

    console.log("âœ“ Loaded", RAW.length, "constituency records");
    console.log("âœ“ Loaded", PARTYLIST_NORMALIZED.length, "party list records");
    
    // Debug: check first record
    if (RAW.length > 0) {
      console.log("Sample RAW record:", RAW[0]);
    }

    // â”€â”€â”€ PARTY COLORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const PARTY_COLOR = {
      'à¸ à¸¹à¸¡à¸´à¹ƒà¸ˆà¹„à¸—à¸¢': '#312682',
      'à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™': '#FF6413',
      'à¹€à¸à¸·à¹ˆà¸­à¹„à¸—à¸¢': '#E30613',
      'à¸à¸¥à¹‰à¸²à¸˜à¸£à¸£à¸¡': '#4EC86F',
      'à¸›à¸£à¸°à¸Šà¸²à¸˜à¸´à¸›à¸±à¸•à¸¢à¹Œ': '#15A5F5',
      'à¸›à¸£à¸°à¸Šà¸²à¸Šà¸²à¸•à¸´': '#BA810D',
      'à¹„à¸—à¸¢à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸—à¸¢': '#6841D0',
      'à¸à¸¥à¸±à¸‡à¸›à¸£à¸°à¸Šà¸²à¸£à¸±à¸': '#006536',
      'à¹„à¸—à¸£à¸§à¸¡à¸à¸¥à¸±à¸‡': '#5266AD',
      'à¹‚à¸­à¸à¸²à¸ªà¹ƒà¸«à¸¡à¹ˆ': '#c61a12',
      'à¸£à¸§à¸¡à¹„à¸—à¸¢à¸ªà¸£à¹‰à¸²à¸‡à¸Šà¸²à¸•à¸´': '#2b2c80',
      'à¸à¹‰à¸²à¸§à¹„à¸à¸¥': '#f97316',
    };
    function pc(name) { return PARTY_COLOR[name] || '#94a3b8'; }

    // â”€â”€â”€ RUNNER-UP PARTY LOOKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Build from data if runnerup_party_2569 field exists
    function runnerUpParty(d) {
      // First try the direct field from data
      if (d.runnerup_party_2569 && d.runnerup_party_2569 !== "Unknown") {
        return d.runnerup_party_2569;
      }
      // Fallback to winner party
      return d.winner_party_2569 || d.winner_party || "Unknown";
    }

    // â”€â”€â”€ LAYOUT CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ROW_H = 18;
    const TOP_PAD = 60;
    const LBL_W = 208;
    const SLOPE_W = 320;
    const BAR_W = 260;
    const BAR_GAP = 30;
    const DOT_COL_W = 28;
    const R = 3.2;

    // X scale: % invalid 0..11
    const X_MIN = 0, X_MAX = 11;
    function xScale(pct) {
      return LBL_W + ((pct - X_MIN) / (X_MAX - X_MIN)) * SLOPE_W;
    }

    // â”€â”€â”€ DATASETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentDataset = 'constituency';

    function getSourceData() {
      return currentDataset === 'partylist' ? PARTYLIST_NORMALIZED : RAW;
    }

    function switchDataset(dataset) {
      currentDataset = dataset;
      
      // Update button active states
      document.querySelectorAll('.btn-dataset').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      
      // Reset to default sort and filter
      activeFilter = 'all';
      currentSort = SORTS.pct_change;
      
      // Update filter buttons
      document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.btn-filter')[0].classList.add('active');
      
      // Update sort buttons
      document.querySelectorAll('.btn-sort:not(.btn-filter):not(.btn-dataset)').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.btn-sort:not(.btn-filter):not(.btn-dataset)')[0].classList.add('active');
      
      // Switch data source
      const selectedRaw = getSourceData();
      
      // Update header subtitle
      const subtitle = document.getElementById('header-subtitle');
      if (dataset === 'partylist') {
        if (selectedRaw.length === 0) {
          subtitle.textContent = 'à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ à¸šà¸ª. (à¸šà¸±à¸à¸Šà¸µà¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­) à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸£à¹‰à¸­à¸¡ | Party List data coming soon';
          data = [];
        } else {
          subtitle.textContent = `à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸­à¸±à¸•à¸£à¸²à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢ Â· à¸šà¸±à¸à¸Šà¸µà¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­ ${selectedRaw.length} à¹€à¸‚à¸• Â· à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡ % à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡`;
          data = [...selectedRaw];
          data.sort(currentSort);
        }
      } else {
        subtitle.textContent = `à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸­à¸±à¸•à¸£à¸²à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢ Â· ${selectedRaw.length} à¹€à¸‚à¸•à¹€à¸¥à¸·à¸­à¸à¸•à¸±à¹‰à¸‡ Â· à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡ % à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡`;
        data = [...selectedRaw];
        data.sort(currentSort);
      }
      
      updateCounts();
      buildChart();
    }

    // â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let data = [...RAW];

    // â”€â”€â”€ SORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SORTS = {
      pct_change: (a, b) => b.invalid_pct_change - a.invalid_pct_change,
      pct_2569: (a, b) => b.percent_invalid_2569 - a.percent_invalid_2569,
      province: (a, b) => (a.province_eng || "").localeCompare(b.province_eng || "") || a.cons_no - b.cons_no,
      party_2566: (a, b) => (a.winner_party || "").localeCompare(b.winner_party || "", 'th') || b.invalid_pct_change - a.invalid_pct_change,
      party_2569: (a, b) => (a.winner_party_2569 || "").localeCompare(b.winner_party_2569 || "", 'th') || b.invalid_pct_change - a.invalid_pct_change,
    };

    // â”€â”€â”€ THEME HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function T(dark, light) {
      return document.documentElement.dataset.theme === 'light' ? light : dark;
    }
    function toggleTheme() {
      const root = document.documentElement;
      const going_light = root.dataset.theme !== 'light';
      root.dataset.theme = going_light ? 'light' : '';
      document.getElementById('btn-theme').textContent = going_light ? 'â˜€ï¸ Light' : 'ğŸŒ™ Dark';
      buildChart();
    }

    // â”€â”€â”€ FILTER STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let activeFilter = 'all';

    function applyFilter() {
      const sourceData = getSourceData();
      if (activeFilter === 'danger') return sourceData.filter(d => d.invalid_2569 > d.margin_2569);
      if (activeFilter === 'safe') return sourceData.filter(d => d.invalid_2569 <= d.margin_2569);
      return [...sourceData];
    }

    function setFilter(key) {
      activeFilter = key;
      document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      data = applyFilter();
      data.sort(currentSort);
      buildChart();
    }

    let currentSort = SORTS.pct_change;

    function updateCounts() {
      const sourceData = getSourceData();
      const nd = sourceData.filter(d => d.invalid_2569 > d.margin_2569).length;
      document.getElementById('cnt-all').textContent = '(' + sourceData.length + ')';
      document.getElementById('cnt-danger').textContent = '(' + nd + ')';
      document.getElementById('cnt-safe').textContent = '(' + (sourceData.length - nd) + ')';
    }
    
    function resort(key) {
      currentSort = SORTS[key];
      data = applyFilter();
      data.sort(currentSort);
      document.querySelectorAll('.btn-sort:not(.btn-filter):not(.btn-dataset)').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      buildChart();
    }

    // â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function svgEl(tag, attrs) {
      const e = document.createElementNS('http://www.w3.org/2000/svg', tag);
      for (const [k, v] of Object.entries(attrs)) e.setAttribute(k, v);
      return e;
    }
    function svgText(parent, x, y, txt, attrs) {
      const e = svgEl('text', { x, y, ...attrs });
      e.textContent = txt;
      parent.appendChild(e);
      return e;
    }

    // â”€â”€â”€ MAIN BUILD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildChart() {
      const n = data.length;
      const H = TOP_PAD + (n * ROW_H) + 10;
      const svgL = document.getElementById('svg-left');
      const svgM = document.getElementById('svg-mid');
      const svgR = document.getElementById('svg-right');
      svgL.innerHTML = '';
      svgM.innerHTML = '';
      svgR.innerHTML = '';

      const svgLW = LBL_W + SLOPE_W + 10;
      const svgMW = DOT_COL_W;
      const svgRW = BAR_GAP + BAR_W + 80;
      svgL.setAttribute('width', svgLW);
      svgL.setAttribute('height', H);
      svgM.setAttribute('width', svgMW);
      svgM.setAttribute('height', H);
      svgR.setAttribute('width', svgRW);
      svgR.setAttribute('height', H);

      // â”€â”€ LEFT SVG: x-axis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      svgL.appendChild(svgEl('line', {
        x1: LBL_W, y1: TOP_PAD - 2,
        x2: LBL_W + SLOPE_W, y2: TOP_PAD - 2,
        stroke: T('#1e3a5f', '#cbd5e1'), 'stroke-width': 1
      }));

      for (let p = 0; p <= X_MAX; p++) {
        const x = xScale(p);
        svgL.appendChild(svgEl('line', {
          x1: x, y1: TOP_PAD - 2,
          x2: x, y2: H,
          stroke: p === 0 ? T('#2563eb', '#6366f1') : T('#0f1e2f', '#e2e8f0'),
          'stroke-width': p === 0 ? 1 : 0.5,
          'stroke-dasharray': p === 0 ? '' : '2,4'
        }));
        svgText(svgL, x, TOP_PAD - 8, p + '%', {
          'text-anchor': 'middle',
          'font-size': '12',
          'font-family': 'DM Mono, monospace',
          fill: T('#94a3b8', '#334155')
        });
      }

      // â”€â”€ Headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      svgText(svgL, xScale(5.5), 25, 'à¸­à¸±à¸•à¸£à¸²à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢ (%) | à¸ˆà¸¸à¸” 2569 à¸¡à¸µà¸§à¸‡à¹à¸«à¸§à¸™ | à¸ªà¸µà¸ˆà¸¸à¸”à¸•à¸²à¸¡à¸à¸£à¸£à¸„à¸­à¸±à¸™à¸”à¸±à¸š 1', {
        'text-anchor': 'middle', 'font-size': '12',
        'font-family': 'Sarabun, sans-serif', fill: T('#94a3b8', '#334155')
      });

      svgText(svgM, DOT_COL_W + 10, 25, 'à¸­à¸±à¸™à¸”à¸±à¸š 2', {
        'text-anchor': 'middle', 'font-size': '12',
        'font-family': 'Sarabun, sans-serif', fill: T('#94a3b8', '#334155')
      });

      svgText(svgR, BAR_GAP + 10, 25, 'à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡à¸œà¸¹à¹‰à¸Šà¸™à¸° 2569', {
        'font-size': '11.5', 'font-family': 'Sarabun, sans-serif', fill: T('#94a3b8', '#334155')
      });

      svgText(svgL, xScale(20) + 10, 25, 'à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢', {
        'font-size': '11.5', 'font-family': 'Sarabun, sans-serif', fill: T('#94a3b8', '#334155')
      });

      // â”€â”€ Arrows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const arrowYStart = 35;
      const arrowYEnd = 50;
      const arrowStroke = T('#94a3b8', '#334155');

      function drawDownArrow(parent, x, y1, y2, color) {
        parent.appendChild(svgEl('line', {
          x1: x, y1: y1, x2: x, y2: y2,
          stroke: color, 'stroke-width': '1.5'
        }));
        parent.appendChild(svgEl('path', {
          d: `M ${x - 4} ${y2 - 5} L ${x} ${y2} L ${x + 4} ${y2 - 5}`,
          fill: 'none', stroke: color, 'stroke-width': '1.5'
        }));
      }

      drawDownArrow(svgM, DOT_COL_W + 15, arrowYStart, arrowYEnd, arrowStroke);
      drawDownArrow(svgR, BAR_GAP + 60, arrowYStart, arrowYEnd, arrowStroke);
      drawDownArrow(svgL, xScale(20) + 30, arrowYStart, arrowYEnd, arrowStroke);

      // â”€â”€ ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      data.forEach((d, i) => {
        const y0 = TOP_PAD + i * ROW_H;
        const yMid = y0 + ROW_H / 2;

        const x2566 = xScale(d.percent_invalid);
        const x2569 = xScale(d.percent_invalid_2569);
        const c2566 = pc(d.winner_party);
        const c2569 = pc(d.winner_party_2569);
        const isDanger = d.invalid_2569 > d.margin_2569;
        const pctChange = d.invalid_pct_change;
        const sign = pctChange > 0 ? '+' : '';

        // â”€â”€ Row BG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const rowBg = [svgL, svgM, svgR].map(svg => {
          const r = svgEl('rect', {
            x: 0, y: y0,
            width: svg === svgL ? svgLW : svg === svgM ? svgMW : svgRW,
            height: ROW_H,
            fill: i % 2 === 0 ? T('rgba(255,255,255,0.018)', 'rgba(0,0,0,0.028)') : 'transparent',
            'data-i': i
          });
          svg.appendChild(r);
          return r;
        });

        rowBg.forEach(r => {
          r.style.cursor = 'default';
          r.addEventListener('mousemove', e => showTip(e, d, isDanger, sign, pctChange));
          r.addEventListener('mouseleave', hideTip);
        });

        // â”€â”€ Y-axis label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        svgText(svgL, LBL_W - 28, yMid + 3.5, d.province_thai, {
          'text-anchor': 'end',
          'font-size': '14',
          'font-family': 'Sarabun, sans-serif',
          fill: T('#64748b', '#64748b')
        });
        svgText(svgL, LBL_W - 4, yMid + 3.5, d.cons_no, {
          'text-anchor': 'end',
          'font-size': '14',
          'font-family': 'DM Mono, monospace',
          fill: T('#94a3b8', '#334155')
        });

        // â”€â”€ Connecting line â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        svgL.appendChild(svgEl('line', {
          x1: x2566, y1: yMid,
          x2: x2569, y2: yMid,
          stroke: T('rgba(148,163,184,0.18)', 'rgba(100,116,139,0.25)'),
          'stroke-width': isDanger ? 1.5 : 0.8
        }));

        // â”€â”€ 2566 dot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        svgL.appendChild(svgEl('circle', {
          cx: x2566, cy: yMid, r: R,
          fill: T('rgba(255,255,255,0.25)', 'rgba(0,0,0,0.3)'),
          stroke: T('rgba(255,255,255,0.25)', 'rgba(0,0,0,0.3)'),
          'stroke-width': 0.5
        }));

        // â”€â”€ 2569 dot with ring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        svgL.appendChild(svgEl('circle', {
          cx: x2569, cy: yMid, r: R + 2.5,
          fill: 'none',
          stroke: getComputedStyle(document.documentElement).getPropertyValue('--ring').trim() || '#fff',
          'stroke-width': 2,
          opacity: 0.9
        }));
        svgL.appendChild(svgEl('circle', {
          cx: x2569, cy: yMid, r: R,
          fill: c2569,
          stroke: T('rgba(255,255,255,0.4)', 'rgba(0,0,0,0.3)'),
          'stroke-width': isDanger ? 1.5 : 0.8
        }));

        // â”€â”€ Change label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const changeColor = pctChange < -0.5 ? '#14b8a6'
          : pctChange > 0.5 ? '#ef4444'
            : '#475569';
        svgText(svgL, LBL_W + SLOPE_W + 6, yMid + 3.5,
          sign + pctChange.toFixed(2), {
          'font-size': '9.5',
          'font-family': 'DM Mono, monospace',
          fill: changeColor
        });

        // â”€â”€ MID SVG: runner-up party dot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        svgM.appendChild(svgEl('circle', {
          cx: DOT_COL_W + 15, cy: yMid, r: R + 0.5,
          fill: pc(runnerUpParty(d)),
          stroke: T('rgba(255,255,255,0.3)', 'rgba(0,0,0,0.25)'),
          'stroke-width': 0.8
        }));

        // â”€â”€ RIGHT SVG: 100% bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const mVal = d.margin_2569 || 0;
        const iVal = d.invalid_2569 || 0;
        const total = mVal + iVal;
        const marginW = total > 0 ? (mVal / total) * BAR_W : 0;
        const invalidW = total > 0 ? (iVal / total) * BAR_W : 0;
        const bx = BAR_GAP;
        const by = y0 + 2;
        const bh = ROW_H - 4;

        // Margin segment
        svgR.appendChild(svgEl('rect', {
          x: bx, y: by, width: marginW, height: bh,
          fill: T('rgba(255,255,255,0.3)', 'rgba(0,0,0,0.15)'), opacity: 0.75, rx: 1
        }));

        // Invalid segment
        svgR.appendChild(svgEl('rect', {
          x: bx + marginW, y: by, width: invalidW, height: bh,
          fill: isDanger ? '#ef4444' : '#ccc4c4',
          opacity: isDanger ? 0.9 : 0.7, rx: 1
        }));

        // Danger indicator
        if (isDanger) {
          svgText(svgR, bx + BAR_W + 5, yMid + 3.5, 'âš ', {
            'font-size': '9.5', fill: '#ef4444'
          });
          // Numbers in bar
          svgText(svgR, bx + 2, yMid + 3.5,
            mVal.toLocaleString(), {
            'text-anchor': 'start', 'font-size': '8.5',
            'font-family': 'DM Mono, monospace',
            fill: '#ffffff'
          });
          svgText(svgR, bx + marginW + invalidW - 2, yMid + 3.5,
            iVal.toLocaleString(), {
            'text-anchor': 'end', 'font-size': '8.5',
            'font-family': 'DM Mono, monospace',
            fill: '#ffffff'
          });
        }
      });

      // â”€â”€ Update header stats (based on current filtered data) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const dangerRows = data.filter(d => d.invalid_2569 > d.margin_2569);
      const improvedRows = data.filter(d => d.invalid_pct_change < 0);
      const worseRows = data.filter(d => d.invalid_pct_change > 0);

      // Counts
      document.getElementById('hs-danger').textContent = dangerRows.length;
      document.getElementById('hs-improved').textContent = improvedRows.length;
      document.getElementById('hs-worse').textContent = worseRows.length;

      // Sums (smaller text)
      const dangerSum = dangerRows.reduce((sum, d) => sum + (d.invalid_2569 || 0), 0);
      const improvedSum = improvedRows.reduce((sum, d) => sum + (d.invalid_2569 || 0), 0);
      const worseSum = worseRows.reduce((sum, d) => sum + (d.invalid_2569 || 0), 0);
      const allSum = data.reduce((sum, d) => sum + (d.invalid_2569 || 0), 0);

      document.getElementById('hs-danger-sum').textContent = `${dangerSum.toLocaleString()} à¸šà¸±à¸•à¸£`;
      document.getElementById('hs-improved-sum').textContent = `${improvedSum.toLocaleString()} à¸šà¸±à¸•à¸£`;
      document.getElementById('hs-worse-sum').textContent = `${worseSum.toLocaleString()} à¸šà¸±à¸•à¸£`;
      document.getElementById('hs-all-sum').textContent = `${allSum.toLocaleString()} à¸šà¸±à¸•à¸£`;

      // Update the "All" summary
      const sourceData = getSourceData();
      const allInc = sourceData.filter(d => d.invalid_pct_change > 0).length;
      const allDec = sourceData.filter(d => d.invalid_pct_change < 0).length;
      const summaryEl = document.getElementById('hs-all-summary');
      if (summaryEl) summaryEl.textContent = `â†‘${allInc} / â†“${allDec}`;

      svgR.setAttribute('height', H);
      buildLegend(data);
    }

    // â”€â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showTip(e, d, isDanger, sign, pctChange) {
      const tip = document.getElementById('tooltip');
      if (!tip) return;

      const runnerUpName = runnerUpParty(d);
      const runnerUpCol = pc(runnerUpName);
      const changeColor = pctChange < 0 ? '#14b8a6' : '#ef4444';

      // Surplus value (const_surplus for constituency, pl_surplus for party list)
      const surplus = currentDataset === 'partylist' ? (d.pl_surplus ?? 0) : (d.const_surplus ?? 0);
      const surplusLabel = currentDataset === 'partylist' ? 'à¸šà¸±à¸•à¸£à¸ªà¹ˆà¸§à¸™à¹€à¸à¸´à¸™ (à¸šà¸±à¸à¸Šà¸µ)' : 'à¸šà¸±à¸•à¸£à¸ªà¹ˆà¸§à¸™à¹€à¸à¸´à¸™ (à¹€à¸‚à¸•)';
      const surplusColor = surplus !== 0 ? '#f59e0b' : 'var(--muted)';
      const surplusSign = surplus > 0 ? '+' : '';
      
      // Voters diff for party list only
      const votersDiff = d.voters_diff_const_PL ?? 0;
      const votersDiffColor = votersDiff > 0 ? '#f59e0b' : votersDiff < 0 ? '#8b5cf6' : 'var(--muted)';
      const votersDiffSign = votersDiff > 0 ? '+' : '';

      // Build extra info section based on dataset
      let extraSection = '';
      if (currentDataset === 'partylist') {
        // Party list: show pl_surplus and voters_diff_const_PL
        extraSection = `
          <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border); font-size: 11px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span style="color: var(--muted);">${surplusLabel}:</span>
              <span style="font-family: 'DM Mono'; color: ${surplusColor}; font-weight: ${surplus !== 0 ? 'bold' : 'normal'};">${surplusSign}${surplus.toLocaleString()}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--muted);">à¸œà¸¹à¹‰à¸¡à¸²à¹ƒà¸Šà¹‰à¸ªà¸´à¸—à¸˜à¸´à¹Œ (à¹€à¸‚à¸• - à¸šà¸±à¸à¸Šà¸µ):</span>
              <span style="font-family: 'DM Mono'; color: ${votersDiffColor}; font-weight: ${votersDiff !== 0 ? 'bold' : 'normal'};">${votersDiffSign}${votersDiff.toLocaleString()}</span>
            </div>
            ${votersDiff !== 0 || surplus !== 0 ? `
            <div style="font-size: 9px; color: var(--amber); margin-top: 4px; text-align: center;">
              ${surplus !== 0 ? 'âš  à¸¡à¸µà¸šà¸±à¸•à¸£à¸ªà¹ˆà¸§à¸™à¹€à¸à¸´à¸™' : ''}
              ${surplus !== 0 && votersDiff !== 0 ? ' Â· ' : ''}
              ${votersDiff > 0 ? 'âš  à¸šà¸±à¸•à¸£à¹€à¸‚à¸• > à¸šà¸±à¸•à¸£à¸šà¸±à¸à¸Šà¸µ' : votersDiff < 0 ? 'âš  à¸šà¸±à¸•à¸£à¸šà¸±à¸à¸Šà¸µ > à¸šà¸±à¸•à¸£à¹€à¸‚à¸•' : ''}
            </div>
            ` : ''}
          </div>
        `;
      } else {
        // Constituency: show const_surplus only if non-zero
        if (surplus !== 0) {
          extraSection = `
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border); font-size: 11px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--muted);">${surplusLabel}:</span>
                <span style="font-family: 'DM Mono'; color: ${surplusColor}; font-weight: bold;">${surplusSign}${surplus.toLocaleString()}</span>
              </div>
              <div style="font-size: 9px; color: var(--amber); margin-top: 4px; text-align: center;">
                âš  à¸¡à¸µà¸šà¸±à¸•à¸£à¸ªà¹ˆà¸§à¸™à¹€à¸à¸´à¸™
              </div>
            </div>
          `;
        }
      }

      tip.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px;">${d.province_thai} à¹€à¸‚à¸• ${d.cons_no}</div>
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 4px;">${d.province_eng}</div>
        
        <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
          <tr>
            <td style="color: var(--muted);">2566 à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢:</td>
            <td style="text-align: right; font-family: 'DM Mono';">${d.percent_invalid.toFixed(2)}%</td>
          </tr>
          <tr>
            <td style="color: var(--muted);">2569 à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢:</td>
            <td style="text-align: right; font-family: 'DM Mono'; font-weight: bold;">${d.percent_invalid_2569.toFixed(2)}%</td>
          </tr>
          <tr style="border-top: 1px dashed var(--border);">
            <td style="color: var(--muted);">à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡:</td>
            <td style="text-align: right; font-family: 'DM Mono'; color: ${changeColor}; font-weight: bold;">${sign}${Math.abs(pctChange).toFixed(2)} pp</td>
          </tr>
        </table>

        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 11px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
            <span style="color: var(--muted);">à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡ (<span style="color: ${runnerUpCol}">${runnerUpName}</span>)</span>
            <span style="font-family: 'DM Mono'; color: var(--teal);">${(d.margin_2569 || 0).toLocaleString()}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--muted);">à¸ˆà¸³à¸™à¸§à¸™à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢:</span>
            <span style="font-family: 'DM Mono'; color: ${isDanger ? 'var(--red)' : 'var(--text)'};">${(d.invalid_2569 || 0).toLocaleString()}</span>
          </div>
        </div>
        ${extraSection}
        ${isDanger ? `<div style="margin-top: 8px; color: var(--red); font-weight: bold; font-size: 10px; text-align: center; background: rgba(239, 68, 68, 0.1); padding: 4px; border-radius: 4px;">âš  à¸šà¸±à¸•à¸£à¹€à¸ªà¸µà¸¢ > à¸Šà¹ˆà¸­à¸‡à¸§à¹ˆà¸²à¸‡à¸„à¸°à¹à¸™à¸™</div>` : ''}
      `;

      tip.style.display = 'block';

      let posX = e.clientX + 15;
      let posY = e.clientY + 15;

      if (posX + 250 > window.innerWidth) {
        posX = e.clientX - 260;
      }
      if (posY + 200 > window.innerHeight) {
        posY = e.clientY - tip.offsetHeight - 20;
      }

      tip.style.left = posX + 'px';
      tip.style.top = posY + 'px';
    }

    function hideTip() {
      document.getElementById('tooltip').style.display = 'none';
    }

    // â”€â”€â”€ PARTY LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildLegend(currentData) {
      const container = document.getElementById('party-legend');
      container.innerHTML = '';

      const visibleParties = new Set();
      currentData.forEach(d => {
        visibleParties.add(d.winner_party_2569);
        visibleParties.add(runnerUpParty(d));
      });

      const sortedParties = [...visibleParties].filter(Boolean).sort((a, b) => (a ?? '').localeCompare(b ?? '', 'th'));

      sortedParties.forEach(p => {
        const div = document.createElement('div');
        div.className = 'dot-label';
        div.innerHTML = `<div class="dot-swatch" style="background:${pc(p)}"></div>${p}`;
        container.appendChild(div);
      });
    }

    // â”€â”€â”€ CAPTURE IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function captureImage() {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'â³ Processing...';
      btn.disabled = true;

      const element = document.getElementById('capture-container');
      const chartScroll = document.getElementById('chart-area');
      const header = document.getElementById('header');

      const originalContainerStyle = element.style.cssText;
      const originalHeaderStyle = header.style.cssText;
      const originalChartStyle = chartScroll.style.cssText;

      try {
        element.style.height = 'auto';
        element.style.width = '1200px';
        element.style.position = 'relative';
        element.style.padding = '40px';

        header.style.position = 'relative';
        header.style.width = '100%';
        header.style.top = '0';
        header.style.left = '0';

        chartScroll.style.height = 'auto';
        chartScroll.style.overflow = 'visible';
        chartScroll.style.position = 'relative';
        chartScroll.style.marginTop = '20px';
        chartScroll.style.marginLeft = '0';
        chartScroll.style.marginRight = '0';

        const dataUrl = await htmlToImage.toPng(element, {
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg'),
          quality: 0.95,
          pixelRatio: data.length > 50 ? 1 : 2,
          cacheBust: true,
        });

        const link = document.createElement('a');
        link.download = `election-data-${new Date().getTime()}.png`;
        link.href = dataUrl;
        link.click();

        btn.textContent = originalText;
      } catch (err) {
        console.error("Capture Error:", err);
        btn.textContent = 'âŒ Error';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.disabled = false;
        }, 3000);
      } finally {
        element.style.cssText = originalContainerStyle;
        header.style.cssText = originalHeaderStyle;
        chartScroll.style.cssText = originalChartStyle;
        btn.disabled = false;
      }
    }

    // â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    data = [...RAW];
    data.sort(SORTS.pct_change);

    updateCounts();
    buildChart();
  </script>

</body>

</html>
